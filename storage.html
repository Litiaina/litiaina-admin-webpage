<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cloud Storage Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --background: #0D0D0D;
            --surface-1: #1A1A1A;
            --surface-2: #2C2C2C;
            --surface-3: #383838;
            /* New color for progress bar track */
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --primary: #E60023;
            --border: #2a2a2a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
        }

        /* Custom class definitions for Tailwind */
        .bg-surface-2 {
            background-color: var(--surface-2);
        }

        .bg-surface-3 {
            background-color: var(--surface-3);
        }

        /* New class for progress bar track */
        .text-text-primary {
            color: var(--text-primary);
        }

        .border-border {
            border-color: var(--border);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--surface-2);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #444;
        }

        .btn-primary {
            background-color: var(--primary);
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #c0001d;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .drop-zone.dragover {
            border-color: var(--primary);
            background-color: rgba(230, 0, 35, 0.1);
        }

        .file-item:hover .file-actions,
        .grid-item:hover .grid-actions {
            opacity: 1;
        }

        .grid-item .file-thumbnail {
            background-color: var(--surface-2);
        }

        /* Fix for invisible text in browser autofill */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px var(--surface-2) inset !important;
            -webkit-text-fill-color: var(--text-primary) !important;
            caret-color: var(--text-primary) !important;
        }

        /* Upload Progress Panel Styles */
        #upload-progress-panel {
            transition: all 0.3s ease-in-out;
        }

        /* Custom styling for the select dropdown */
        .select-custom {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23A0A0A0' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
            /* Add space for the icon */
        }
    </style>
</head>

<body class="antialiased">
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    <div class="relative min-h-screen md:flex">
        <aside id="sidebar"
            class="w-64 flex-shrink-0 bg-surface-1 flex flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40">
            <div class="flex items-center justify-between h-16 border-b border-border px-6">
                <div class="flex items-center gap-3">
                    <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="currentColor"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12.01 2C6.49 2 2.02 6.48 2.02 12s4.47 10 9.99 10c5.52 0 10-4.48 10-10S17.53 2 12.01 2zM12 20c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-15c-.55 0-1 .45-1 1v5c0 .55.45 1 1 1s1-.45 1-1V6c0-.55-.45-1-1-1zm1 10h-2v2h2v-2z" />
                    </svg>
                    <h1 class="text-xl font-bold text-text-primary">Cloud Storage</h1>
                </div>
                <button id="close-sidebar-btn" class="md:hidden text-text-secondary hover:text-primary">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <button id="uploadModalBtn"
                    class="w-full bg-white text-black font-semibold rounded-full py-3 px-5 flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition-shadow">
                    <i class="fas fa-plus"></i>
                    <span>New</span>
                </button>
            </div>
            <nav id="fragmentList" class="flex-1 px-4 space-y-1 custom-scrollbar overflow-y-auto">
            </nav>
            <div class="p-4 border-t border-border">
                <div id="gb-used" class="text-xs text-text-secondary">
                    0.0 MB of 0.0 MB used
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                    <div id="storage-bar" class="h-1.5 rounded-full bg-green-500" style="width: 0%"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col">
            <header class="flex items-center justify-between h-16 border-b border-border px-4 sm:px-6">
                <div class="flex items-center gap-4">
                    <button id="menu-toggle-btn" class="md:hidden text-text-secondary hover:text-primary">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="relative w-full max-w-xs sm:max-w-xl">
                        <i
                            class="fas fa-search absolute left-4 sm:left-5 top-1/2 -translate-y-1/2 text-text-secondary"></i>
                        <input type="search" id="searchInput" placeholder="Search..."
                            class="w-full bg-surface-2 focus:bg-surface-2 border-transparent focus:border-primary focus:ring-0 rounded-full pl-10 sm:pl-12 pr-4 py-3 transition-all text-sm text-text-primary">
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <button
                        class="w-10 h-10 rounded-full hover:bg-surface-2 flex items-center justify-center text-text-secondary"><i
                            class="fas fa-cog"></i></button>
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center font-bold">U</div>
                </div>
            </header>

            <div class="flex-1 flex flex-col p-4 sm:p-6 overflow-hidden">
                <div class="flex items-center justify-between pb-4 border-b border-border mb-4">
                    <div id="breadcrumb" class="flex items-center text-lg sm:text-2xl font-bold truncate">
                    </div>
                    <div id="view-switcher" class="flex items-center bg-surface-2 rounded-lg p-1">
                        <button id="list-view-btn" class="px-3 py-1.5 text-sm rounded-md bg-primary text-white"><i
                                class="fas fa-list"></i></button>
                        <button id="grid-view-btn"
                            class="px-3 py-1.5 text-sm rounded-md text-text-secondary hover:bg-surface-1"><i
                                class="fas fa-th-large"></i></button>
                    </div>
                </div>
                <div id="browser"
                    class="flex-1 overflow-y-auto custom-scrollbar -mx-4 sm:-mr-6 sm:-ml-6 px-4 sm:pr-6 sm:pl-6">
                    <div id="objectList" class="space-y-1">
                    </div>
                    <div id="browserSpinner" class="flex items-center justify-center p-8" style="display: none;">
                        <i class="fas fa-spinner fa-spin text-3xl text-primary"></i>
                        <span class="ml-4 text-text-secondary">Loading Files...</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="uploadModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-surface-1 rounded-xl border border-border p-8 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold">Upload Files</h3>
                <button id="closeUploadModalBtn" class="text-text-secondary hover:text-primary"><i
                        class="fas fa-times text-xl"></i></button>
            </div>

            <div id="dropZone"
                class="relative flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-border rounded-lg cursor-pointer transition-all duration-300 hover:border-primary hover:bg-surface-2">
                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                    <i class="fas fa-cloud-upload-alt text-4xl text-text-secondary mb-3"></i>
                    <p id="dropText" class="mb-2 text-sm text-center text-text-secondary">
                        <span class="font-semibold">Click to upload</span> or drag and drop
                    </p>
                </div>
                <input type="file" id="fileInput" class="opacity-0 absolute top-0 left-0 w-full h-full cursor-pointer"
                    multiple />
            </div>

            <div class="mt-4 space-y-4">
                <input type="text" id="fragmentInput" placeholder="Fragment (e.g., images)"
                    class="w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary transition-all text-text-primary">
                <input type="text" id="pathPrefixInput" placeholder="Path Prefix (optional, e.g., vacation/)"
                    class="w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary transition-all text-text-primary">
            </div>

            <button
                class="btn btn-primary w-full py-3 mt-6 text-white font-semibold rounded-lg disabled:opacity-50 disabled:cursor-not-allowed"
                id="uploadBtn">
                Upload
            </button>
        </div>
    </div>

    <div id="deleteModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-surface-1 rounded-xl border border-border p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-2">Confirm Deletion</h3>
            <p class="text-sm text-text-secondary mb-6">Are you sure you want to delete this object? This action cannot
                be undone.</p>
            <div class="flex justify-end gap-3">
                <button id="cancelDeleteBtn"
                    class="bg-surface-2 hover:bg-surface-2/80 px-4 py-2 rounded-lg text-sm font-semibold">Cancel</button>
                <button id="confirmDeleteBtn"
                    class="btn btn-danger bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">Delete</button>
            </div>
        </div>
    </div>

    <div id="renameModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-surface-1 rounded-xl border border-border p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Rename Object</h3>
            <input type="text" id="newObjectKeyInput"
                class="w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary transition-all text-text-primary">
            <div class="flex justify-end gap-3 mt-6">
                <button id="cancelRenameBtn"
                    class="bg-surface-2 hover:bg-surface-2/80 px-4 py-2 rounded-lg text-sm font-semibold">Cancel</button>
                <button id="confirmRenameBtn"
                    class="btn btn-primary text-white px-4 py-2 rounded-lg text-sm font-semibold">Rename</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="modal-backdrop fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal bg-surface-1 rounded-xl border border-border p-6 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Share Object</h3>
            <div class="space-y-4">
                <select id="shareDisposition"
                    class="select-custom w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-1 focus:ring-primary transition-all text-text-primary">
                    <option value="view" selected>Share for viewing</option>
                    <option value="stream">Share for video streaming (note: supports only .mp4 videos)</option>
                    <option value="download">Share for downloading</option>
                </select>
                <input type="number" id="shareExpiry" value="3600" placeholder="Expires in (seconds)"
                    class="w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 focus:outline-none focus:ring-2 focus:ring-primary transition-all text-text-primary">
                <div class="relative">
                    <input type="text" id="shareUrl" readonly placeholder="Generated URL..."
                        class="w-full bg-surface-2 focus:bg-surface-2 border border-border rounded-lg px-4 py-2.5 pr-10 text-text-primary">
                    <button id="copyShareUrlBtn"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-text-secondary hover:text-primary">
                        <i class="far fa-copy"></i>
                    </button>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="closeShareBtn"
                    class="bg-surface-2 hover:bg-surface-2/80 px-4 py-2 rounded-lg text-sm font-semibold">Close</button>
                <button id="generateShareBtn"
                    class="btn btn-primary text-white px-4 py-2 rounded-lg text-sm font-semibold">Generate Link</button>
            </div>
        </div>
    </div>

    <div id="fileViewerModal" class="modal-backdrop fixed inset-0 z-[60] hidden items-center justify-center p-4 sm:p-8">
        <div class="modal bg-surface-1 rounded-xl border border-border flex flex-col w-full max-w-5xl h-[90vh]">
            <div class="flex justify-between items-center p-4 border-b border-border flex-shrink-0">
                <h3 id="fileViewerTitle" class="text-lg font-semibold truncate pr-4">Viewing File...</h3>
                <button id="closeFileViewerBtn" class="text-text-secondary hover:text-primary"><i
                        class="fas fa-times text-xl"></i></button>
            </div>
            <div id="fileViewerContent"
                class="flex-1 p-2 overflow-auto custom-scrollbar flex items-center justify-center bg-black/20">
                <div id="fileViewerSpinner" class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-primary"></i>
                    <p class="mt-4 text-text-secondary">Loading preview...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="upload-progress-panel"
        class="fixed bottom-4 right-4 w-full max-w-sm sm:w-80 bg-surface-1 rounded-lg shadow-2xl border border-border z-50 translate-y-[calc(100%+2rem)] opacity-0">
        <div class="flex items-center justify-between p-3 border-b border-border">
            <h4 id="upload-panel-title" class="font-semibold text-sm">Uploading...</h4>
            <button id="toggle-upload-panel-btn" class="text-text-secondary hover:text-primary"><i
                    class="fas fa-chevron-down"></i></button>
        </div>
        <div id="upload-items-container" class="p-2 space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
        </div>
    </div>

    <div id="toast-container" class="fixed top-5 right-5 z-[100] w-full max-w-xs space-y-3"></div>

    <div id="contextMenu" class="absolute z-50 hidden bg-surface-2 rounded-lg shadow-lg py-2 w-40 text-sm">
    </div>


    <script>
        // --- GLOBAL STATE & CONSTANTS ---
        let currentObjectList = [];
        let activeFragment = '';
        let currentView = 'list';
        let currentPath = ''; // To track the current folder path
        const serverLink = `https://storage.litiaina.com`;
        const token = localStorage.getItem("current-token")?.trim() || "dummy-token";
        const uid = localStorage.getItem("current-account-uid")?.trim() || "dummy-uid";
        const totalCapacity = Number(localStorage.getItem("current-capacity")?.trim()) || 10737418240; // 10 GB

        const KB = 1024;
        const MB = 1024 * KB;
        const GB = 1024 * MB;

        // --- UPLOAD QUEUE STATE ---
        let uploadQueue = [];
        let activeUploads = 0;
        const MAX_CONCURRENT_UPLOADS = 4;

        // --- UTILITY FUNCTIONS ---
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            }

            toast.className = `flex items-center w-full p-4 text-white ${colors[type]} rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            toast.innerHTML = `
            <i class="fas ${icons[type]} mr-3"></i>
            <div class="text-sm font-medium">${message}</div>
        `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 10);

            const closeToast = () => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove(), { once: true });
            };

            toast.onclick = closeToast;
            setTimeout(closeToast, duration);
        }

        function formatBytes(bytes, decimals = 2) {
            bytes = Number(bytes);
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds < 0) return '--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h > 0 ? h + 'h ' : ''}${m > 0 ? m + 'm ' : ''}${s}s`;
        }
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                // Images
                'jpg': 'fa-file-image', 'jpeg': 'fa-file-image', 'png': 'fa-file-image', 'gif': 'fa-file-image', 'svg': 'fa-file-image',
                // Documents
                'pdf': 'fa-file-pdf', 'doc': 'fa-file-word', 'docx': 'fa-file-word', 'xls': 'fa-file-excel', 'xlsx': 'fa-file-excel',
                'ppt': 'fa-file-powerpoint', 'pptx': 'fa-file-powerpoint', 'txt': 'fa-file-alt',
                // Archives
                'zip': 'fa-file-archive', 'rar': 'fa-file-archive', '7z': 'fa-file-archive',
                // Code
                'html': 'fa-file-code', 'css': 'fa-file-code', 'js': 'fa-file-code', 'json': 'fa-file-code',
                // Audio/Video
                'mp3': 'fa-file-audio', 'wav': 'fa-file-audio', 'mp4': 'fa-file-video', 'mov': 'fa-file-video', 'avi': 'fa-file-video',
            };
            return iconMap[extension] || 'fa-file';
        }


        // --- UI MANAGEMENT ---
        function resetUploadModal() {
            document.getElementById('dropText').innerHTML = '<span class="font-semibold">Click to upload</span> or drag and drop';
            document.getElementById('fileInput').value = '';
            document.getElementById('pathPrefixInput').value = '';
        }

        // --- CORE API LOGIC ---
        async function updateCapacityDisplay() {
            const gbUsedElement = document.getElementById('gb-used');
            const storageBar = document.getElementById('storage-bar');

            if (!token || !uid) {
                gbUsedElement.textContent = `USED: -- / TOTAL: ${formatBytes(totalCapacity)}`;
                storageBar.style.width = '0%';
                storageBar.className = "h-1.5 rounded-full bg-green-500"; // reset
                return;
            }

            try {
                const url = `${serverLink}/v4/capacity/usage`;
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { "authorization": `Bearer ${token}`, "uid": uid }
                });

                if (response.ok) {
                    const capacity = await response.json();
                    const usedSpace = Number(capacity.capacity_used) || 0;
                    const percentage = (usedSpace / totalCapacity) * 100;

                    gbUsedElement.textContent = `${formatBytes(usedSpace)} of ${formatBytes(totalCapacity)} used`;
                    storageBar.style.width = `${percentage}%`;

                    // âœ… change bar color based on usage
                    if (percentage < 60) {
                        storageBar.className = "h-1.5 rounded-full bg-green-500";
                    } else if (percentage < 85) {
                        storageBar.className = "h-1.5 rounded-full bg-yellow-500";
                    } else {
                        storageBar.className = "h-1.5 rounded-full bg-red-500";
                    }

                } else {
                    gbUsedElement.textContent = `Error of ${formatBytes(totalCapacity)} used`;
                    storageBar.style.width = '0%';
                    storageBar.className = "h-1.5 rounded-full bg-green-500";
                }
            } catch (error) {
                const usedSpace = 3.2 * GB;
                const percentage = (usedSpace / totalCapacity) * 100;

                gbUsedElement.textContent = `USED: ${formatBytes(usedSpace)} / TOTAL: ${formatBytes(totalCapacity)}`;
                storageBar.style.width = `${percentage}%`;

                // fallback coloring
                if (percentage < 60) {
                    storageBar.className = "h-1.5 rounded-full bg-green-500";
                } else if (percentage < 85) {
                    storageBar.className = "h-1.5 rounded-full bg-yellow-500";
                } else {
                    storageBar.className = "h-1.5 rounded-full bg-red-500";
                }

                console.warn("Could not fetch capacity, showing mock data.", error);
            }
        }

        function getOptimalChunkSize(fileSize) {
            if (fileSize < 100 * MB) return 2 * MB;
            if (fileSize < 500 * MB) return 5 * MB;
            if (fileSize < 1 * GB) return 8 * MB;
            return 16 * MB;
        }
        async function calculateChecksum(blob) {
            const buffer = await blob.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Session Management for Resumability ---
        function getSessionKey(file) { return `upload-session-${file.name}-${file.size}-${file.lastModified}`; }
        function saveSession(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function getSession(key) { const session = localStorage.getItem(key); return session ? JSON.parse(session) : null; }
        function clearSession(key) { localStorage.removeItem(key); }

        // --- UPLOAD QUEUE & PANEL LOGIC ---

        function showUploadPanel() {
            const panel = document.getElementById('upload-progress-panel');
            panel.classList.remove('translate-y-[calc(100%+2rem)]', 'opacity-0');
        }

        function updateUploadPanelTitle() {
            const title = document.getElementById('upload-panel-title');
            const completed = uploadQueue.filter(item => item.status === 'complete').length;
            const total = uploadQueue.length;
            if (activeUploads === 0 && uploadQueue.every(item => item.status === 'complete' || item.status === 'error' || item.status === 'cancelled')) {
                title.textContent = `${completed} of ${total} uploads complete`;
            } else {
                const remaining = uploadQueue.filter(item => item.status === 'pending' || item.status === 'uploading').length;
                title.textContent = `Uploading ${activeUploads} of ${remaining} files...`;
            }
        }

        function createUploadItemUI(uploadItem) {
            const container = document.getElementById('upload-items-container');
            const itemEl = document.createElement('div');
            itemEl.id = `upload-${uploadItem.id}`;
            itemEl.className = 'flex items-center p-2 bg-surface-2 rounded-md';
            itemEl.innerHTML = `
            <div class="flex-shrink-0 w-8 flex items-center justify-center">
                <i class="far ${getFileIcon(uploadItem.file.name)} text-lg text-text-secondary"></i>
            </div>
            <div class="flex-1 overflow-hidden ml-3">
                <p class="text-sm font-medium truncate text-text-primary">${uploadItem.pathPrefix}${uploadItem.file.name}</p>
                <p class="status-text text-xs text-text-secondary mt-0.5">Waiting...</p>
            </div>
            <div class="status-icon text-lg ml-3 w-6 h-6 flex items-center justify-center">
                <button class="cancel-btn w-6 h-6 rounded-full hover:bg-surface-1 flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
            </div>
        `;
            container.appendChild(itemEl);

            itemEl.querySelector('.cancel-btn').onclick = () => {
                if (uploadItem.controller) {
                    uploadItem.controller.abort();
                }
                uploadItem.status = 'cancelled';
                const itemUI = document.getElementById(`upload-${uploadItem.id}`);
                itemUI.querySelector('.status-text').textContent = 'Cancelled';
                itemUI.querySelector('.status-icon').innerHTML = `<i class="fas fa-ban text-red-500"></i>`;
                if (activeUploads > 0) {
                    activeUploads--;
                }
                processUploadQueue();
            };
        }

        function processUploadQueue() {
            updateUploadPanelTitle();
            while (activeUploads < MAX_CONCURRENT_UPLOADS && uploadQueue.some(item => item.status === 'pending')) {
                const nextUpload = uploadQueue.find(item => item.status === 'pending');
                if (nextUpload) {
                    activeUploads++;
                    nextUpload.status = 'uploading';
                    startUpload(nextUpload);
                }
            }
        }

        async function handleFileUploadRequest() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            const fragment = document.getElementById('fragmentInput').value.trim();
            let pathPrefix = document.getElementById('pathPrefixInput').value.trim();

            if (pathPrefix && !pathPrefix.endsWith('/')) {
                pathPrefix += '/';
            }

            if (files.length === 0) {
                showToast('Please select files to upload.', 'error');
                return;
            }
            if (!fragment) {
                showToast('Please provide a fragment name.', 'error');
                return;
            }
            if (!token || !uid) {
                showToast('Authentication details are missing.', 'error');
                return;
            }

            showUploadPanel();

            for (const file of files) {
                const uploadItem = {
                    id: crypto.randomUUID(),
                    file: file,
                    fragment: fragment,
                    pathPrefix: pathPrefix,
                    status: 'pending', // pending, uploading, complete, error, cancelled
                    controller: new AbortController(),
                };
                uploadQueue.push(uploadItem);
                createUploadItemUI(uploadItem);
            }

            processUploadQueue();
            document.getElementById('uploadModal').classList.add('hidden');
            resetUploadModal();
        }

        async function startUpload(uploadItem) {
            const { file, id } = uploadItem;
            const sessionKey = getSessionKey(file);
            const ui = {
                statusText: document.querySelector(`#upload-${id} .status-text`),
                statusIcon: document.querySelector(`#upload-${id} .status-icon`),
            };
            ui.statusText.textContent = 'Starting...';

            ui.statusIcon.innerHTML = `
            <svg class="progress-ring w-full h-full" viewBox="0 0 36 36">
                <circle stroke-width="3" stroke="var(--surface-1)" fill="transparent" r="15.9155" cx="18" cy="18"/>
                <circle class="progress-ring__bar" stroke-width="3" stroke="var(--primary)" fill="transparent" r="15.9155" cx="18" cy="18"
                    style="stroke-dasharray: 100, 100; stroke-dashoffset: 100; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.3s;"/>
            </svg>
        `;
            ui.progressBar = ui.statusIcon.querySelector('.progress-ring__bar');


            try {
                const existingSession = getSession(sessionKey);
                if (existingSession && existingSession.file_id) {
                    ui.statusText.textContent = 'Resuming...';
                    await resumeChunkedFile(uploadItem, existingSession.file_id, sessionKey, ui);
                } else {
                    await uploadChunkedFile(uploadItem, sessionKey, ui);
                }

                uploadItem.status = 'complete';
                if (ui.progressBar) ui.progressBar.style.strokeDashoffset = 0;
                ui.statusText.textContent = 'Completed';
                ui.statusIcon.innerHTML = `<i class="fas fa-check-circle text-green-500"></i>`;
                clearSession(sessionKey);
                await updateCapacityDisplay();
                if (uploadItem.fragment === activeFragment) {
                    await listObjects(activeFragment);
                }

            } catch (err) {
                if (err.name !== 'AbortError' && uploadItem.status !== 'cancelled') {
                    console.error('Upload failed:', err);
                    uploadItem.status = 'error';
                    ui.statusText.textContent = `Error: ${err.message.substring(0, 30)}...`;
                    ui.statusIcon.innerHTML = `<i class="fas fa-exclamation-circle text-red-500"></i>`;
                    clearSession(sessionKey);
                }
            } finally {
                activeUploads--;
                processUploadQueue();
            }
        }

        async function uploadChunkedFile(uploadItem, sessionKey, ui) {
            const { file, fragment, pathPrefix, controller } = uploadItem;
            const fileSize = file.size;
            const chunkSize = getOptimalChunkSize(fileSize);
            const totalChunks = Math.ceil(fileSize / chunkSize);

            const objectKey = `${pathPrefix}${file.name}`;
            const initiateResponse = await fetch(`${serverLink}/v4/fragment/object/upload/init/${fragment}/${objectKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', authorization: `Bearer ${token}`, uid: uid },
                body: JSON.stringify({
                    content_type: file.type || 'application/octet-stream',
                    total_size_bytes: fileSize,
                    total_chunks: totalChunks,
                }),
                signal: controller.signal
            });

            if (!initiateResponse.ok) throw new Error(`${await initiateResponse.text()}`);
            const { file_id } = await initiateResponse.json();
            saveSession(sessionKey, { file_id, name: file.name, size: file.size });
            const allChunks = Array.from({ length: totalChunks }, (_, i) => i);
            await processAndFinalizeChunks(uploadItem, file_id, allChunks, 0, ui);
        }

        async function resumeChunkedFile(uploadItem, file_id, sessionKey, ui) {
            const { file, controller } = uploadItem;
            const statusResponse = await fetch(`${serverLink}/v4/fragment/object/upload/status/${file_id}`, {
                headers: { authorization: `Bearer ${token}`, uid: uid },
                signal: controller.signal
            });

            if (!statusResponse.ok) {
                showToast('Could not resume. Starting a new upload.', 'warning');
                clearSession(sessionKey);
                await uploadChunkedFile(uploadItem, sessionKey, ui);
                return;
            }

            const status = await statusResponse.json();
            const chunkSize = getOptimalChunkSize(file.size);
            const uploadedChunks = new Set(status.uploaded_chunks);
            const allChunks = Array.from({ length: status.total_chunks }, (_, i) => i);
            const chunksToUpload = allChunks.filter(i => !uploadedChunks.has(i));
            const alreadyUploadedBytes = uploadedChunks.size * chunkSize;
            await processAndFinalizeChunks(uploadItem, file_id, chunksToUpload, alreadyUploadedBytes, ui);
        }

        async function processAndFinalizeChunks(uploadItem, file_id, chunkQueue, initialUploadedBytes, ui) {
            const { file, controller } = uploadItem;
            const fileSize = file.size;
            const chunkSize = getOptimalChunkSize(fileSize);
            let uploadedBytes = initialUploadedBytes;
            let lastUploadedBytes = initialUploadedBytes;
            let lastTime = performance.now();
            let speeds = [];
            let maxWorkers = Math.min(navigator.hardwareConcurrency || 4, 8);
            const MAX_WORKERS_CAP = 16;

            const updateProgress = () => {
                const progress = Math.round((uploadedBytes / fileSize) * 100);
                if (ui.progressBar) {
                    const offset = 100 - progress;
                    ui.progressBar.style.strokeDashoffset = offset;
                }

                const now = performance.now();
                const timeDiff = (now - lastTime) / 1000;
                if (timeDiff > 0.5) {
                    const bytesDiff = uploadedBytes - lastUploadedBytes;
                    const currentSpeed = bytesDiff / timeDiff;
                    if (currentSpeed > 0) {
                        speeds.push(currentSpeed);
                        if (speeds.length > 10) speeds.shift();
                    }
                    const avgSpeed = speeds.length > 0 ? speeds.reduce((a, b) => a + b, 0) / speeds.length : 0;
                    const remainingBytes = fileSize - uploadedBytes;
                    const estTime = avgSpeed > 0 ? remainingBytes / avgSpeed : 0;
                    ui.statusText.textContent = `Uploading... ${formatBytes(avgSpeed)}/s, ETA: ${formatTime(estTime)}`;
                    lastTime = now;
                    lastUploadedBytes = uploadedBytes;
                    if (avgSpeed > 2 * MB && maxWorkers < MAX_WORKERS_CAP) {
                        maxWorkers = Math.min(maxWorkers + 1, MAX_WORKERS_CAP);
                    }
                }
            };
            updateProgress();

            const uploadChunk = async (chunkIndex) => {
                const start = chunkIndex * chunkSize;
                const end = Math.min(start + chunkSize, fileSize);
                const blob = file.slice(start, end);
                const checksum = await calculateChecksum(blob);
                const formData = new FormData();
                formData.append('chunk', blob);

                const url = `${serverLink}/v4/fragment/object/upload/chunk/${file_id}/${chunkIndex}?checksum=${checksum}`;

                for (let retries = 3; retries > 0; retries--) {
                    if (controller.signal.aborted) throw new Error('Upload cancelled');
                    try {
                        const response = await fetch(url, {
                            method: 'PUT',
                            headers: { authorization: `Bearer ${token}`, uid: uid },
                            body: formData,
                            signal: controller.signal
                        });
                        if (!response.ok) throw new Error(`Chunk ${chunkIndex} failed: ${await response.text()}`);
                        uploadedBytes += blob.size;
                        updateProgress();
                        return;
                    } catch (err) {
                        if (err.name === 'AbortError') throw err;
                        if (retries === 1) throw err;
                        maxWorkers = Math.max(2, maxWorkers - 1);
                        await new Promise(r => setTimeout(r, 2000));
                    }
                }
            };

            await new Promise((resolve, reject) => {
                let activeWorkersCount = 0;
                let uploadFailedError = null;
                const processSingleChunk = async () => {
                    if (uploadFailedError) return;
                    activeWorkersCount++;
                    while (chunkQueue.length > 0) {
                        if (uploadFailedError) break;
                        const chunkIndex = chunkQueue.shift();
                        if (chunkIndex === undefined) break;
                        try {
                            await uploadChunk(chunkIndex);
                        } catch (err) {
                            uploadFailedError = err;
                            reject(err);
                            break;
                        }
                    }
                    activeWorkersCount--;
                    if (activeWorkersCount === 0 && chunkQueue.length === 0) {
                        uploadFailedError ? reject(uploadFailedError) : resolve();
                    }
                };
                const workerManager = setInterval(() => {
                    if (chunkQueue.length === 0 || uploadFailedError) {
                        clearInterval(workerManager);
                        return;
                    }
                    while (activeWorkersCount < maxWorkers && chunkQueue.length > 0) {
                        processSingleChunk();
                    }
                }, 100);

                const initialWorkers = Math.min(maxWorkers, chunkQueue.length);
                for (let i = 0; i < initialWorkers; i++) {
                    processSingleChunk();
                }
            });

            const finalizeResponse = await fetch(`${serverLink}/v4/fragment/object/upload/finalize/${file_id}`, {
                method: 'POST',
                headers: { authorization: `Bearer ${token}`, uid: uid },
                signal: controller.signal
            });
            if (!finalizeResponse.ok) throw new Error('Failed to finalize upload.');
        }

        // --- BROWSER/MANAGER LOGIC ---
        function navigateTo(path) {
            currentPath = path;
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value) {
                searchInput.value = '';
            }
            renderObjects(currentObjectList);
        }

        function renderObjects(objects) {
            const listContainer = document.getElementById('objectList');
            const breadcrumbContainer = document.getElementById('breadcrumb');
            listContainer.innerHTML = '';
            breadcrumbContainer.innerHTML = '';

            // 1. Render Breadcrumbs
            const pathParts = currentPath.split('/').filter(p => p);
            let pathAccumulator = '';

            const rootCrumb = document.createElement('a');
            rootCrumb.href = '#';
            rootCrumb.className = 'text-text-primary hover:text-primary transition-colors';
            rootCrumb.textContent = activeFragment.charAt(0).toUpperCase() + activeFragment.slice(1);
            rootCrumb.onclick = (e) => { e.preventDefault(); navigateTo(''); };
            breadcrumbContainer.appendChild(rootCrumb);

            pathParts.forEach(part => {
                pathAccumulator += part + '/';
                const separator = document.createElement('span');
                separator.className = 'mx-2 text-text-secondary';
                separator.textContent = '/';
                breadcrumbContainer.appendChild(separator);

                const partCrumb = document.createElement('a');
                partCrumb.href = '#';
                partCrumb.className = 'text-text-primary hover:text-primary transition-colors';
                partCrumb.textContent = part;
                const finalPath = pathAccumulator;
                partCrumb.onclick = (e) => { e.preventDefault(); navigateTo(finalPath); };
                breadcrumbContainer.appendChild(partCrumb);
            });

            // 2. Parse objects into folders and files
            const folders = new Set();
            const files = [];

            objects.forEach(obj => {
                if (obj.key.startsWith(currentPath)) {
                    const relativePath = obj.key.substring(currentPath.length);
                    const slashIndex = relativePath.indexOf('/');

                    if (slashIndex !== -1 && slashIndex > 0) {
                        const folderName = relativePath.substring(0, slashIndex);
                        folders.add(folderName);
                    } else if (slashIndex === -1 && relativePath.length > 0) {
                        files.push(obj);
                    }
                }
            });

            // 3. Render View
            if (currentView === 'grid') {
                listContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 sm:gap-6';
            } else {
                listContainer.className = 'space-y-1';
            }

            if (folders.size === 0 && files.length === 0) {
                listContainer.className = '';
                listContainer.innerHTML = '<div class="text-center py-16 text-text-secondary"><i class="fas fa-folder-open text-4xl mb-4"></i><p>This folder is empty.</p></div>';
                return;
            }

            if (currentView === 'list') {
                const header = document.createElement('div');
                header.className = 'hidden sm:flex items-center px-4 py-2 text-xs text-text-secondary border-b border-border font-semibold sticky top-0 bg-background z-10';
                header.innerHTML = `
                <div class="w-1/2 flex items-center">Name</div>
                <div class="w-1/4">Last Modified</div>
                <div class="w-1/4">File Size</div>
                <div class="w-20"></div>
            `;
                listContainer.appendChild(header);
            }

            // Render Folders
            Array.from(folders).sort().forEach(folderName => {
                const item = document.createElement('div');
                const newPath = currentPath + folderName + '/';

                if (currentView === 'list') {
                    item.className = 'file-item flex items-center px-4 py-3 hover:bg-surface-1 rounded-lg transition-colors border-b border-border cursor-pointer';
                    item.innerHTML = `
                    <div class="flex items-center w-full">
                        <i class="fas fa-folder text-xl text-primary w-8 text-center"></i>
                        <span class="font-medium text-text-primary truncate ml-4">${folderName}</span>
                    </div>
                `;
                } else {
                    item.className = 'grid-item relative group flex flex-col bg-surface-1 rounded-xl overflow-hidden border border-transparent hover:border-primary transition-all cursor-pointer';
                    item.innerHTML = `
                    <div class="file-thumbnail h-32 sm:h-36 flex items-center justify-center">
                        <i class="fas fa-folder text-5xl text-text-secondary"></i>
                    </div>
                    <div class="p-3 flex items-center gap-2 border-t border-border">
                         <i class="fas fa-folder text-md text-primary"></i>
                        <p class="font-medium text-sm truncate flex-1">${folderName}</p>
                    </div>
                `;
                }
                item.onclick = () => navigateTo(newPath);
                listContainer.appendChild(item);
            });

            // Render Files
            files.sort((a, b) => new Date(Number(b.last_modified.$date.$numberLong)) - new Date(Number(a.last_modified.$date.$numberLong)));
            files.forEach(obj => {
                const item = document.createElement('div');
                const relativePath = obj.key.substring(currentPath.length);

                if (currentView === 'list') {
                    item.className = 'file-item flex items-center px-4 py-3 hover:bg-surface-1 rounded-lg transition-colors border-b border-border';
                    item.innerHTML = `
                    <div class="flex items-center w-full sm:w-1/2">
                        <i class="far ${getFileIcon(obj.key)} text-xl text-primary w-8 text-center"></i>
                        <span class="font-medium text-text-primary truncate ml-4">${relativePath}</span>
                    </div>
                    <div class="hidden sm:block w-1/4 text-sm text-text-secondary">${new Date(Number(obj.last_modified.$date.$numberLong)).toLocaleDateString()}</div>
                    <div class="hidden sm:block w-1/4 text-sm text-text-secondary">${formatBytes(obj.size_bytes)}</div>
                    <div class="w-20 flex justify-end ml-auto">
                        <div class="file-actions opacity-100 sm:opacity-0 transition-opacity flex items-center gap-1">
                            <button data-action="more" title="More actions" class="w-8 h-8 rounded-full hover:bg-surface-2 flex items-center justify-center text-text-secondary hover:text-primary transition-colors"><i class="fas fa-ellipsis-v"></i></button>
                        </div>
                    </div>
                `;
                } else {
                    item.className = 'grid-item relative group flex flex-col bg-surface-1 rounded-xl overflow-hidden border border-transparent hover:border-primary transition-all cursor-pointer';
                    item.innerHTML = `
                    <div class="file-thumbnail h-32 sm:h-36 flex items-center justify-center">
                        <i class="far ${getFileIcon(obj.key)} text-5xl text-text-secondary"></i>
                    </div>
                    <div class="p-3 flex items-center gap-2 border-t border-border">
                         <i class="far ${getFileIcon(obj.key)} text-md text-primary"></i>
                        <p class="font-medium text-sm truncate flex-1">${relativePath}</p>
                    </div>
                    <div class="grid-actions absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button data-action="more" title="More actions" class="w-7 h-7 rounded-full bg-surface-2/80 backdrop-blur-sm hover:bg-surface-2 flex items-center justify-center text-text-secondary hover:text-primary transition-colors"><i class="fas fa-ellipsis-v text-xs"></i></button>
                    </div>
                `;
                }
                item.querySelector('[data-action="more"]').addEventListener('click', e => {
                    e.stopPropagation();
                    showContextMenu(e.currentTarget, obj);
                });
                listContainer.appendChild(item);
            });
        }

        async function listObjects(fragment) {
            if (!fragment) {
                document.getElementById('breadcrumb').innerHTML = `<h2 class="text-2xl font-bold">No Fragment Selected</h2>`;
                document.getElementById('objectList').innerHTML = '<div class="text-center py-16 text-text-secondary"><i class="fas fa-exclamation-circle text-4xl mb-4"></i><p>No fragments found. Please upload a file to create one.</p></div>';
                return;
            }

            document.getElementById('browserSpinner').style.display = 'flex';
            document.getElementById('objectList').innerHTML = '';

            try {
                const response = await fetch(`${serverLink}/v4/fragment/object/metadata/${fragment}`, {
                    headers: { authorization: `Bearer ${token}`, uid: uid }
                });
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                const objects = await response.json();
                currentObjectList = objects;
                renderObjects(objects);
            } catch (err) {
                showToast(`Failed to list objects: ${err.message}`, 'error');
                document.getElementById('objectList').innerHTML = `<div class="text-center py-16 text-red-500"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Error loading objects.</p></div>`;
            } finally {
                document.getElementById('browserSpinner').style.display = 'none';
            }
        }

        async function loadFragments() {
            const fragmentList = document.getElementById('fragmentList');
            try {
                const response = await fetch(`${serverLink}/v4/fragment/metadata`, {
                    headers: { authorization: `Bearer ${token}`, uid: uid }
                });
                if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                const fragments = await response.json();

                fragmentList.innerHTML = ''; // Clear existing list

                if (fragments.length > 0) {
                    if (!fragments.includes(activeFragment)) {
                        activeFragment = fragments[0];
                        currentPath = '';
                    }

                    fragments.forEach((fragment) => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = `fragment-item flex items-center px-4 py-2.5 font-medium rounded-lg`;
                        if (fragment === activeFragment) {
                            item.classList.add('bg-primary/20', 'text-text-primary');
                        } else {
                            item.classList.add('text-text-secondary', 'hover:bg-surface-2', 'hover:text-text-primary');
                        }
                        item.innerHTML = `
                        <i class="fas fa-folder mr-3"></i>
                        <span>${fragment}</span>
                    `;
                        fragmentList.appendChild(item);
                    });
                    listObjects(activeFragment);
                } else {
                    activeFragment = '';
                    currentPath = '';
                    listObjects(null);
                }

            } catch (err) {
                showToast(`Failed to load fragments: ${err.message}`, 'error');
                fragmentList.innerHTML = `<div class="p-4 text-xs text-red-500">Could not load fragments.</div>`;
                listObjects(null);
            }
        }

        function filterObjects() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                renderObjects(currentObjectList);
                return;
            }
            const filtered = currentObjectList.filter(obj => obj.key.toLowerCase().includes(query));
            renderFlatList(filtered);
        }

        function renderFlatList(objects) {
            const listContainer = document.getElementById('objectList');
            const breadcrumbContainer = document.getElementById('breadcrumb');
            listContainer.innerHTML = '';
            breadcrumbContainer.innerHTML = `<h2 class="text-2xl font-bold">Search Results</h2>`;

            if (objects.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-16 text-text-secondary"><i class="fas fa-search text-4xl mb-4"></i><p>No objects found.</p></div>';
                return;
            }

            listContainer.className = 'space-y-1';
            const header = document.createElement('div');
            header.className = 'hidden sm:flex items-center px-4 py-2 text-xs text-text-secondary border-b border-border font-semibold sticky top-0 bg-background z-10';
            header.innerHTML = `
            <div class="w-1/2 flex items-center">Name</div>
            <div class="w-1/4">Last Modified</div>
            <div class="w-1/4">File Size</div>
            <div class="w-20"></div>
        `;
            listContainer.appendChild(header);

            objects.forEach(obj => {
                const item = document.createElement('div');
                item.className = 'file-item flex items-center px-4 py-3 hover:bg-surface-1 rounded-lg transition-colors border-b border-border';
                item.innerHTML = `
                <div class="flex items-center w-full sm:w-1/2">
                    <i class="far ${getFileIcon(obj.key)} text-xl text-primary w-8 text-center"></i>
                    <span class="font-medium text-text-primary truncate ml-4">${obj.key}</span>
                </div>
                <div class="hidden sm:block w-1/4 text-sm text-text-secondary">${new Date(Number(obj.last_modified.$date.$numberLong)).toLocaleDateString()}</div>
                <div class="hidden sm:block w-1/4 text-sm text-text-secondary">${formatBytes(obj.size_bytes)}</div>
                <div class="w-20 flex justify-end ml-auto">
                    <div class="file-actions opacity-100 sm:opacity-0 transition-opacity flex items-center gap-1">
                        <button data-action="more" title="More actions" class="w-8 h-8 rounded-full hover:bg-surface-2 flex items-center justify-center text-text-secondary hover:text-primary transition-colors"><i class="fas fa-ellipsis-v"></i></button>
                    </div>
                </div>
            `;
                item.querySelector('[data-action="more"]').addEventListener('click', e => {
                    e.stopPropagation();
                    showContextMenu(e.currentTarget, obj);
                });
                listContainer.appendChild(item);
            });
        }

        async function getObjectBlob(fragment, key, endpoint) {
            const response = await fetch(`${serverLink}/v4/fragment/object/${endpoint}/${fragment}/${key}`, {
                headers: { authorization: `Bearer ${token}`, uid: uid }
            });
            if (!response.ok) throw new Error(`Server responded with ${response.status}`);
            return await response.blob();
        }

        async function handleObjectAction(action, fragment, key) {
            try {
                switch (action) {
                    case 'view': {
                        showFileViewerModal(key);
                        const blob = await getObjectBlob(fragment, key, 'get');
                        await renderFileViewerContent(blob, key);
                        break;
                    }
                    case 'download': {
                        showToast('Starting download...', 'info', 3000);
                        const blob = await getObjectBlob(fragment, key, 'download');
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = key.split('/').pop() || 'download';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        break;
                    }
                    case 'delete':
                        showDeleteModal(fragment, key);
                        break;
                    case 'rename':
                        showRenameModal(fragment, key);
                        break;
                    case 'share':
                        showShareModal(fragment, key);
                        break;
                }
            } catch (err) {
                showToast(`Action failed: ${err.message}`, 'error');
                if (action === 'view') {
                    closeFileViewerModal();
                }
            }
        }

        // --- CONTEXT MENU LOGIC ---
        function showContextMenu(button, object) {
            const menu = document.getElementById('contextMenu');
            menu.innerHTML = `
            <a href="#" data-action="view" class="flex items-center px-4 py-2 hover:bg-surface-1"><i class="fas fa-eye w-6 mr-2"></i>View</a>
            <a href="#" data-action="share" class="flex items-center px-4 py-2 hover:bg-surface-1"><i class="fas fa-share-alt w-6 mr-2"></i>Share</a>
            <a href="#" data-action="rename" class="flex items-center px-4 py-2 hover:bg-surface-1"><i class="fas fa-pencil-alt w-6 mr-2"></i>Rename</a>
            <a href="#" data-action="download" class="flex items-center px-4 py-2 hover:bg-surface-1"><i class="fas fa-download w-6 mr-2"></i>Download</a>
            <div class="my-1 border-t border-border"></div>
            <a href="#" data-action="delete" class="flex items-center px-4 py-2 text-red-500 hover:bg-surface-1"><i class="fas fa-trash w-6 mr-2"></i>Delete</a>
        `;

            const rect = button.getBoundingClientRect();

            menu.classList.remove('hidden');
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;

            let top = rect.bottom + window.scrollY;
            let left = rect.right + window.scrollX - menuWidth;

            if (left < 8) { left = 8; }
            if (left + menuWidth > document.documentElement.clientWidth) { left = document.documentElement.clientWidth - menuWidth - 8; }
            if (top + menuHeight > document.documentElement.clientHeight + window.scrollY) { top = rect.top + window.scrollY - menuHeight; }
            if (top < window.scrollY) { top = window.scrollY + 8; }

            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;

            menu.onclick = (e) => {
                e.preventDefault();
                const target = e.target.closest('a');
                if (target) {
                    const action = target.dataset.action;
                    handleObjectAction(action, object.fragment, object.key);
                    menu.classList.add('hidden');
                }
            };
        }

        // --- MODAL LOGIC ---
        function showDeleteModal(fragment, key) {
            const modal = document.getElementById('deleteModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                try {
                    const response = await fetch(`${serverLink}/v4/fragment/object/delete/${fragment}/${key}`, {
                        method: 'DELETE',
                        headers: { authorization: `Bearer ${token}`, uid: uid }
                    });
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    showToast('Object deleted successfully.', 'success');
                    listObjects(fragment);
                } catch (err) {
                    showToast(`Failed to delete object: ${err.message}`, 'error');
                } finally {
                    modal.classList.add('hidden');
                }
            };
            document.getElementById('cancelDeleteBtn').onclick = () => modal.classList.add('hidden');
        }

        function showRenameModal(fragment, key) {
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('newObjectKeyInput');
            input.value = key;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('confirmRenameBtn').onclick = async () => {
                const newKey = input.value.trim();
                if (!newKey || newKey === key) {
                    showToast('Please enter a new, valid object key.', 'error');
                    return;
                }
                try {
                    const response = await fetch(`${serverLink}/v4/fragment/object/rename`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', authorization: `Bearer ${token}`, uid: uid },
                        body: JSON.stringify({
                            source_fragment: fragment,
                            source_key: key,
                            destination_fragment: fragment,
                            destination_key: newKey
                        })
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || `Server responded with ${response.status}`);
                    }
                    showToast('Object renamed successfully.', 'success');
                    listObjects(fragment);
                } catch (err) {
                    showToast(`Failed to rename object: ${err.message}`, 'error');
                } finally {
                    modal.classList.add('hidden');
                }
            };
            document.getElementById('cancelRenameBtn').onclick = () => modal.classList.add('hidden');
        }

        function showShareModal(fragment, key) {
            const modal = document.getElementById('shareModal');
            const urlInput = document.getElementById('shareUrl');
            urlInput.value = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            document.getElementById('generateShareBtn').onclick = async () => {
                const disposition = document.getElementById('shareDisposition').value;
                const expires_in = parseInt(document.getElementById('shareExpiry').value, 10) || 3600;
                try {
                    const response = await fetch(`${serverLink}/v4/fragment/object/share`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', authorization: `Bearer ${token}`, uid: uid },
                        body: JSON.stringify({ fragment, object_key: key, expires_in, disposition })
                    });
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const data = await response.json();
                    urlInput.value = data.url;
                } catch (err) {
                    showToast(`Failed to generate link: ${err.message}`, 'error');
                }
            };
            document.getElementById('copyShareUrlBtn').onclick = () => {
                if (urlInput.value) {
                    navigator.clipboard.writeText(urlInput.value);
                    showToast('URL copied to clipboard!', 'success');
                } else {
                    showToast('Generate a URL first!', 'error');
                }
            };
            document.getElementById('closeShareBtn').onclick = () => modal.classList.add('hidden');
        }

        const fileViewerModal = document.getElementById('fileViewerModal');
        const fileViewerTitle = document.getElementById('fileViewerTitle');
        const fileViewerContent = document.getElementById('fileViewerContent');
        const fileViewerSpinner = document.getElementById('fileViewerSpinner');
        let currentObjectUrl = null;

        function closeFileViewerModal() {
            fileViewerModal.classList.add('hidden');
            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
                currentObjectUrl = null;
            }
            fileViewerContent.innerHTML = '';
            fileViewerContent.appendChild(fileViewerSpinner);
        }

        function showFileViewerModal(objectKey) {
            const fileName = objectKey.split('/').pop();
            fileViewerTitle.textContent = fileName;

            fileViewerContent.innerHTML = '';
            fileViewerContent.appendChild(fileViewerSpinner);

            fileViewerModal.classList.remove('hidden');
            fileViewerModal.classList.add('flex');
        }

        async function renderFileViewerContent(blob, objectKey) {
            const fileName = objectKey.split('/').pop();
            const fileType = blob.type;

            if (currentObjectUrl) {
                URL.revokeObjectURL(currentObjectUrl);
            }
            currentObjectUrl = URL.createObjectURL(blob);

            let contentElement;

            if (fileType.startsWith('image/')) {
                contentElement = document.createElement('img');
                contentElement.src = currentObjectUrl;
                contentElement.className = 'max-w-full max-h-full object-contain';
            } else if (fileType.startsWith('video/')) {
                contentElement = document.createElement('video');
                contentElement.src = currentObjectUrl;
                contentElement.controls = true;
                contentElement.className = 'max-w-full max-h-full';
            } else if (fileType.startsWith('audio/')) {
                contentElement = document.createElement('audio');
                contentElement.src = currentObjectUrl;
                contentElement.controls = true;
                contentElement.className = 'w-full max-w-md my-auto';
            } else if (fileType === 'application/pdf') {
                contentElement = document.createElement('iframe');
                contentElement.src = currentObjectUrl;
                contentElement.className = 'w-full h-full border-0';
            } else if (fileType.startsWith('text/')) {
                contentElement = document.createElement('pre');
                contentElement.className = 'text-left text-sm p-4 bg-surface-2 rounded-lg whitespace-pre-wrap w-full h-full';
                try {
                    contentElement.textContent = await blob.text();
                } catch (e) {
                    contentElement.textContent = 'Could not read text content.';
                }
            } else {
                contentElement = document.createElement('div');
                contentElement.className = 'text-center my-auto';
                contentElement.innerHTML = `
                <i class="far ${getFileIcon(fileName)} text-6xl text-text-secondary mb-4"></i>
                <p class="text-text-primary">Preview not available for this file type.</p>
                <p class="text-sm text-text-secondary">${fileName}</p>
            `;
            }

            fileViewerContent.innerHTML = '';
            fileViewerContent.appendChild(contentElement);
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            updateCapacityDisplay();
            loadFragments();

            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuToggleBtn = document.getElementById('menu-toggle-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');

            function openSidebar() {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
            }

            function closeSidebar() {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
            }

            menuToggleBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            sidebarOverlay.addEventListener('click', closeSidebar);

            document.addEventListener('click', () => {
                document.getElementById('contextMenu').classList.add('hidden');
            });

            document.getElementById('fragmentList').addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.fragment-item');
                if (target && !target.classList.contains('bg-primary/20')) {
                    document.querySelectorAll('.fragment-item').forEach(item => {
                        item.classList.remove('bg-primary/20', 'text-text-primary');
                        item.classList.add('text-text-secondary', 'hover:bg-surface-2', 'hover:text-text-primary');
                    });
                    target.classList.add('bg-primary/20', 'text-text-primary');
                    target.classList.remove('text-text-secondary', 'hover:bg-surface-2', 'hover:text-text-primary');

                    activeFragment = target.querySelector('span').textContent.trim();
                    currentPath = '';
                    listObjects(activeFragment);
                    if (window.innerWidth < 768) {
                        closeSidebar();
                    }
                }
            });

            const listViewBtn = document.getElementById('list-view-btn');
            const gridViewBtn = document.getElementById('grid-view-btn');
            listViewBtn.addEventListener('click', () => {
                currentView = 'list';
                listViewBtn.classList.add('bg-primary', 'text-white');
                listViewBtn.classList.remove('text-text-secondary', 'hover:bg-surface-1');
                gridViewBtn.classList.remove('bg-primary', 'text-white');
                gridViewBtn.classList.add('text-text-secondary', 'hover:bg-surface-1');
                renderObjects(currentObjectList);
            });
            gridViewBtn.addEventListener('click', () => {
                currentView = 'grid';
                gridViewBtn.classList.add('bg-primary', 'text-white');
                gridViewBtn.classList.remove('text-text-secondary', 'hover:bg-surface-1');
                listViewBtn.classList.remove('bg-primary', 'text-white');
                listViewBtn.classList.add('text-text-secondary', 'hover:bg-surface-1');
                renderObjects(currentObjectList);
            });


            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    const fileCount = fileInput.files.length;
                    document.getElementById('dropText').innerHTML = `<span class="font-semibold">${fileCount} file${fileCount > 1 ? 's' : ''} selected</span>`;
                }
            });

            document.getElementById('uploadBtn').addEventListener('click', handleFileUploadRequest);
            document.getElementById('searchInput').addEventListener('input', filterObjects);

            const dropZone = document.getElementById('dropZone');
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    fileInput.dispatchEvent(new Event('change'));
                }
            });

            const uploadModal = document.getElementById('uploadModal');
            document.getElementById('uploadModalBtn').addEventListener('click', () => {
                document.getElementById('fragmentInput').value = activeFragment;
                document.getElementById('pathPrefixInput').value = currentPath;
                uploadModal.classList.remove('hidden');
            });
            document.getElementById('closeUploadModalBtn').addEventListener('click', () => uploadModal.classList.add('hidden'));

            document.getElementById('toggle-upload-panel-btn').addEventListener('click', () => {
                const panel = document.getElementById('upload-progress-panel');
                const container = document.getElementById('upload-items-container');
                container.classList.toggle('hidden');
                panel.querySelector('i').classList.toggle('fa-chevron-down');
                panel.querySelector('i').classList.toggle('fa-chevron-up');
            });

            document.getElementById('closeFileViewerBtn').addEventListener('click', closeFileViewerModal);
            fileViewerModal.addEventListener('click', (e) => {
                if (e.target === fileViewerModal) {
                    closeFileViewerModal();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && !fileViewerModal.classList.contains('hidden')) {
                    closeFileViewerModal();
                }
            });
        });
    </script>
</body>

</html>