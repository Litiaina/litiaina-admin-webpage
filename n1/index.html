<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>N1 Cloud</title>
    <link rel="icon" type="image/png" href="../images/litiaina_icon_48x48.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@300;400;600&family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/docx-preview/dist/docx-preview.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* Windows 11 Dark Theme Inspired */
            --win-bg-desktop: #202020;
            --win-glass: rgba(32, 32, 32, 0.75);
            --win-glass-border: rgba(255, 255, 255, 0.08);
            --win-header-bg: rgba(32, 32, 32, 0.95);
            --win-sidebar: #191919;
            --win-content: #1e1e1e;
            --accent-color: #60cdff;
            /* Windows Blue */
            --accent-hover: #4cc2ff;
            --text-primary: #ffffff;
            --text-secondary: #dcdcdc;
            --text-muted: #9e9e9e;
            --item-hover: rgba(255, 255, 255, 0.06);
            --item-active: rgba(255, 255, 255, 0.08);
            --selection-bg: rgba(96, 205, 255, 0.15);
            --selection-border: rgba(96, 205, 255, 0.4);
        }

        body {
            font-family: 'Segoe UI', 'Inter', sans-serif;
            background-color: var(--win-bg-desktop);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            color: var(--text-primary);
            cursor: default;
        }

        /* --- Desktop --- */
        #desktop {
            position: relative;
            width: 100%;
            height: 100%;
            background: url("../images/n1-cloud-professional-wallpaper.jpg") no-repeat center center fixed;
            background-size: cover;
        }

        /* --- Taskbar (Windows 11 Style) --- */
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: rgba(32, 32, 32, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--win-glass-border);
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Center align hack */
            align-items: center;
            padding: 0 12px;
            z-index: 5000;
        }

        /* Start Button Area */
        .taskbar-start {
            display: flex;
            align-items: center;
        }

        /* Center Apps */
        #taskbar-apps {
            display: flex;
            gap: 6px;
            height: 100%;
            align-items: center;
            justify-content: center;
        }

        /* System Tray */
        .taskbar-tray {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
        }

        .task-item {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
            position: relative;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .task-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .task-item.active {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .task-item.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            width: 16px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 2px;
        }

        /* Hide text in taskbar for Windows 11 look, show only icon */
        .task-item-text {
            display: none; 
        }

        .task-item i {
            font-size: 18px;
        }

        /* Start Button */
        .start-btn {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .start-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .start-btn.active {
             background-color: rgba(255, 255, 255, 0.15);
        }

        /* --- Desktop Icons --- */
        #desktop-icons {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 10;
        }

        .desktop-icon {
            width: 86px;
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 2px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.1s;
        }

        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.05);
        }

        .desktop-icon.selected {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .desktop-icon-img {
            font-size: 36px;
            margin-bottom: 6px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .desktop-icon-label {
            color: white;
            font-size: 12px;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9);
            line-height: 1.3;
        }

        /* --- Windows Structure --- */
        #windows-container {
            position: absolute;
            inset: 0;
            bottom: 48px; /* Above taskbar */
            z-index: 50;
            pointer-events: none;
        }

        .window {
            position: absolute;
            background-color: var(--win-content);
            border-radius: 8px;
            box-shadow: 0 0 0 1px rgba(0,0,0,0.2), 0 14px 28px rgba(0,0,0,0.4), 0 10px 10px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 320px;
            min-height: 200px;
            opacity: 0;
            transform: scale(0.95);
            transition: opacity 0.15s ease-out, transform 0.15s cubic-bezier(0.1, 0.9, 0.2, 1);
            pointer-events: auto;
        }

        .window.visible {
            opacity: 1;
            transform: scale(1);
        }

        .window.maximized {
            border-radius: 0;
            border: none;
        }

        /* Window Header (Title Bar) */
        .window-header {
            height: 38px;
            background-color: var(--win-header-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 12px;
            cursor: default; /* Windows doesn't show drag pointer usually */
            user-select: none;
            flex-shrink: 0;
        }
        
        .window-title {
            font-size: 12px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 400;
        }

        .window-controls {
            display: flex;
            height: 100%;
        }

        .win-control-btn {
            width: 46px;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: var(--text-primary);
            transition: background 0.1s;
            cursor: default;
        }

        .win-control-btn:hover {
            background-color: rgba(255, 255, 255, 0.06);
        }

        .win-control-btn.close-btn:hover {
            background-color: #e81123;
            color: white;
        }

        .window-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: var(--win-content);
            position: relative;
        }

        /* Sidebar */
        .window-sidebar {
            width: 220px;
            background-color: var(--win-sidebar);
            padding: 16px 6px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-item {
            padding: 8px 12px;
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.1s;
        }

        .nav-item:hover {
            background-color: var(--item-hover);
        }

        .nav-item.active {
            background-color: var(--item-active);
            color: var(--accent-color);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 4px;
            height: 16px;
            width: 3px;
            border-radius: 2px;
            background-color: var(--accent-color);
        }

        /* Explorer Content */
        .window-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #191919;
        }

        /* Toolbar/Address Bar Area */
        .explorer-toolbar {
            height: 48px;
            border-bottom: 1px solid var(--win-glass-border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            background: var(--win-content);
        }

        .tool-btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-primary);
            background: transparent;
            border: 1px solid transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.1s;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.08);
        }
        
        .tool-btn.primary {
            background-color: rgba(96, 205, 255, 0.1);
            color: var(--accent-color);
        }

        .address-bar {
            flex: 1;
            background: #252525;
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 4px;
            height: 32px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .breadcrumb-segment {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 2px;
        }
        
        .breadcrumb-segment:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Main View */
        #browser {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            position: relative;
        }

        /* Grid/List Items */
        .file-item {
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: default;
            transition: background 0.05s;
        }

        .file-item:hover {
            background-color: var(--item-hover);
        }

        .file-item.selected {
            background-color: var(--selection-bg) !important;
            border-color: transparent !important; /* Windows uses simpler selection */
        }
        
        .file-item.selected:hover {
            background-color: rgba(96, 205, 255, 0.2) !important;
        }

        .item-tile {
            height: 160px;
        }

        /* Selection Marquee */
        #selection-marquee {
            position: absolute;
            border: 1px solid var(--accent-color);
            background-color: rgba(96, 205, 255, 0.2);
            z-index: 9999;
            pointer-events: none;
            display: none;
        }

        /* Scrollbars */
        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #666;
        }

        /* Context Menu */
        #contextMenu {
            background: rgba(40, 40, 40, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
            padding: 4px;
            z-index: 6000;
        }

        .ctx-item {
            padding: 8px 12px;
            cursor: default;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-radius: 4px;
        }

        .ctx-item:hover {
            background: rgba(255,255,255,0.08);
        }

        .ctx-div {
            height: 1px;
            background: rgba(255,255,255,0.08);
            margin: 4px 6px;
        }

        /* Boot Screen */
        #boot-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s;
        }

        /* Modals */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .win-modal {
            background: #2b2b2b;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        /* Resource Monitor Specifics */
        .res-card {
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
        }

        /* Start Menu Styles */
        #start-menu {
            transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            transform-origin: bottom center;
        }
        #start-menu.hidden {
            display: none !important;
            opacity: 0;
            transform: translateY(10px) scale(0.95);
        }
        #start-menu:not(.hidden) {
            display: flex !important;
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    </style>
</head>

<body class="antialiased text-gray-200" oncontextmenu="return false;">

    <!-- Boot Screen -->
    <div id="boot-screen">
        <div class="animate-pulse flex flex-col items-center">
            <img src="../images/litiaina_icon_48x48.png" alt="logo" class="w-20 h-20 mb-6" />
            <div class="h-1 w-32 bg-gray-800 rounded-full overflow-hidden">
                <div class="h-full bg-blue-500 w-1/2 animate-[slide_1.5s_infinite_linear]"></div>
            </div>
        </div>
    </div>

    <!-- Selection Marquee -->
    <div id="selection-marquee"></div>

    <div id="desktop">
        <!-- Desktop Icons -->
        <div id="desktop-icons">
            <div class="desktop-icon" onclick="WindowManager.open('file-explorer')">
                <div class="desktop-icon-img text-yellow-400"><i class="fas fa-folder"></i></div>
                <div class="desktop-icon-label">File Explorer</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('notepad')">
                <div class="desktop-icon-img text-white"><i class="fas fa-sticky-note"></i></div>
                <div class="desktop-icon-label">Notepad</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('calendar')">
                <div class="desktop-icon-img text-blue-400"><i class="fas fa-calendar-alt"></i></div>
                <div class="desktop-icon-label">Calendar</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('dashboard')">
                <div class="desktop-icon-img text-green-500"><i class="fas fa-chart-line"></i></div>
                <div class="desktop-icon-label">Resource Monitor</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('recycle-bin')">
                <div class="desktop-icon-img text-gray-400"><i class="fas fa-trash-can"></i></div>
                <div class="desktop-icon-label">Recycle Bin</div>
            </div>
        </div>

        <!-- Start Menu -->
        <div id="start-menu" class="hidden absolute bottom-14 left-0 right-0 mx-auto w-[600px] h-[400px] bg-[#202020]/95 backdrop-blur-xl border border-[#333] rounded-lg shadow-2xl z-[4999] flex flex-col overflow-hidden">
            <div class="p-6 bg-gradient-to-b from-[#333] to-[#202020] border-b border-white/5">
                <input type="text" placeholder="Type here to search" class="w-full bg-[#1e1e1e] text-sm text-white px-4 py-2 rounded border border-[#444] focus:border-blue-500 outline-none">
            </div>
            <div class="flex-1 p-6 grid grid-cols-2 gap-4 overflow-y-auto custom-scrollbar">
                 <div>
                    <div class="text-xs font-semibold text-gray-500 mb-2 uppercase">Pinned</div>
                    <div class="grid grid-cols-4 gap-2">
                         <div class="flex flex-col items-center p-2 hover:bg-white/5 rounded cursor-pointer" onclick="WindowManager.open('file-explorer'); StartMenu.toggle();">
                             <div class="w-8 h-8 bg-yellow-400/20 rounded flex items-center justify-center text-yellow-400 mb-1"><i class="fas fa-folder"></i></div>
                             <span class="text-[10px]">Explorer</span>
                         </div>
                         <div class="flex flex-col items-center p-2 hover:bg-white/5 rounded cursor-pointer" onclick="WindowManager.open('notepad'); StartMenu.toggle();">
                             <div class="w-8 h-8 bg-white/10 rounded flex items-center justify-center text-white mb-1"><i class="fas fa-sticky-note"></i></div>
                             <span class="text-[10px]">Notepad</span>
                         </div>
                         <div class="flex flex-col items-center p-2 hover:bg-white/5 rounded cursor-pointer" onclick="WindowManager.open('calendar'); StartMenu.toggle();">
                             <div class="w-8 h-8 bg-blue-500/20 rounded flex items-center justify-center text-blue-400 mb-1"><i class="fas fa-calendar-alt"></i></div>
                             <span class="text-[10px]">Calendar</span>
                         </div>
                         <div class="flex flex-col items-center p-2 hover:bg-white/5 rounded cursor-pointer" onclick="WindowManager.open('dashboard'); StartMenu.toggle();">
                             <div class="w-8 h-8 bg-green-500/20 rounded flex items-center justify-center text-green-500 mb-1"><i class="fas fa-chart-line"></i></div>
                             <span class="text-[10px]">Monitor</span>
                         </div>
                    </div>
                 </div>
            </div>
            <div class="h-14 bg-[#181818] border-t border-[#333] flex items-center justify-between px-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-xs font-bold">U</div>
                    <div class="text-xs">
                        <div class="font-semibold text-white" id="start-menu-username">User</div>
                    </div>
                </div>
                <button onclick="App.logout()" class="p-2 hover:bg-[#333] rounded text-red-400 hover:text-red-300 transition-colors" title="Sign out">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>

        <!-- Taskbar -->
        <div id="taskbar">
            <!-- Left Spacer -->
             <div></div>

            <!-- Center Apps -->
            <div id="taskbar-apps">
                <div class="start-btn" id="start-btn" title="Start" onclick="StartMenu.toggle()">
                    <img src="../images/litiaina_icon_48x48.png" alt="Start" class="w-6 h-6">
                </div>
                <!-- Dynamic Apps go here -->
            </div>

            <!-- Right Tray -->
            <div class="taskbar-tray">
                <div class="cursor-pointer hover:bg-white/10 p-2 rounded" title="Upload Status" onclick="WindowManager.open('uploads')">
                    <i class="fas fa-cloud-arrow-up text-xs"></i>
                </div>
                <div class="flex flex-col items-end mr-2">
                    <div id="clock" class="text-xs text-white font-medium">12:00 PM</div>
                    <div class="text-[10px] text-gray-400">12/17/2025</div>
                </div>
                <div class="w-1 bg-gray-500 h-full opacity-0"></div> <!-- Show Desktop Area -->
            </div>
        </div>

        <!-- Windows Layer -->
        <div id="windows-container">

            <!-- 1. FILE EXPLORER -->
            <div id="win-file-explorer" class="window" style="width: 1000px; height: 650px; top: 60px; left: 100px; display: none;">
                <div class="window-header">
                    <div class="window-title">
                        <img src="../images/litiaina_icon_48x48.png" class="w-4 h-4 opacity-70">
                        File Explorer
                    </div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('file-explorer')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn" onclick="WindowManager.maximize('file-explorer')"><i class="far fa-square"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('file-explorer')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                
                <!-- New Ribbon/Toolbar for File Explorer -->
                <div class="explorer-toolbar">
                     <div class="flex items-center gap-2 text-gray-400">
                        <button class="p-1 hover:bg-white/10 rounded disabled:opacity-30" onclick="navigateBack()" id="back-btn"><i class="fas fa-arrow-left"></i></button>
                        <button class="p-1 hover:bg-white/10 rounded" onclick="listObjects(activeFragment)"><i class="fas fa-rotate-right"></i></button>
                     </div>
                     <div class="address-bar">
                         <i class="fas fa-hard-drive text-gray-400 mr-2"></i>
                         <div id="breadcrumb" class="breadcrumb w-full">Local Files</div>
                     </div>
                     <div class="relative w-48">
                        <input type="text" id="searchInput" placeholder="Search" class="w-full bg-[#252525] border border-white/10 rounded h-8 px-3 text-xs text-white focus:border-blue-500 outline-none">
                     </div>
                </div>

                <!-- Sub-toolbar for actions -->
                <div class="flex items-center gap-1 px-2 py-1 bg-[#1e1e1e] border-b border-white/5 text-xs">
                    <button class="tool-btn" onclick="document.getElementById('newFolderBtnAction').click()">
                        <i class="fas fa-plus text-blue-400"></i> New
                    </button>
                    <div class="w-px h-4 bg-white/10 mx-1"></div>
                    <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-file-upload"></i> Upload
                    </button>
                    <div class="flex-1"></div>
                    <button id="tiles-view-btn" class="tool-btn"><i class="fas fa-th-large"></i></button>
                    <button id="list-view-btn" class="tool-btn"><i class="fas fa-list"></i></button>
                </div>

                <div class="window-body">
                    <div class="window-sidebar custom-scrollbar overflow-y-auto">
                        <div class="text-[11px] font-semibold text-gray-500 uppercase px-3 py-2 mt-1">Quick Access</div>
                        <div class="nav-item active" id="nav-my-files" onclick="AppNav.navigate('my-files')">
                            <i class="fas fa-home text-blue-400"></i> Home
                        </div>
                        <div class="nav-item" id="nav-recent" onclick="AppNav.navigate('recent')">
                            <i class="far fa-clock"></i> Recent
                        </div>
                        <div class="nav-item" id="nav-starred" onclick="AppNav.navigate('starred')">
                            <i class="fas fa-star text-yellow-500"></i> Favorites
                        </div>

                        <div class="flex justify-between items-center px-3 mt-6 mb-1">
                            <div class="text-[11px] font-semibold text-gray-500 uppercase">Drives</div>
                            <button id="addFragmentBtn" class="text-xs text-gray-400 hover:text-white px-1"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="fragmentList" class="flex flex-col gap-0.5"></div>

                        <!-- Storage Quota UI -->
                        <div class="mt-auto p-3 m-2 bg-[#252525] rounded border border-white/5">
                            <div class="flex justify-between items-center mb-1 text-[10px] text-gray-400">
                                <span>Storage</span>
                                <span id="sidebar-storage-percent">0%</span>
                            </div>
                            <div class="w-full bg-[#333] rounded-full h-1 mb-1">
                                <div id="sidebar-storage-bar" class="bg-blue-500 h-1 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="sidebar-gb-used" class="text-[10px] text-gray-500">0 GB used</div>
                        </div>
                    </div>

                    <div class="window-content">
                        <div id="browser" class="custom-scrollbar">
                            <div id="objectList" class="grid gap-1" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));"></div>
                            <div id="browserSpinner" class="absolute inset-0 flex items-center justify-center bg-[#191919]/80 hidden z-10">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-circle-notch fa-spin text-2xl text-blue-500 mb-2"></i>
                                    <span class="text-xs text-gray-400">Working on it...</span>
                                </div>
                            </div>
                        </div>
                        <div class="h-6 bg-[#1e1e1e] border-t border-white/5 flex items-center px-3 text-[11px] text-gray-500 justify-between select-none">
                            <span id="selection-status">0 items selected</span>
                            <div class="flex gap-4">
                                <span id="network-activity-status" class="flex items-center gap-2">
                                    Online
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. RESOURCE MONITOR (Windows Style) -->
            <div id="win-dashboard" class="window" style="width: 900px; height: 600px; top: 80px; left: 150px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-chart-line text-green-500"></i> Resource Monitor</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('dashboard')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('dashboard')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                <div class="window-body">
                    <div class="window-sidebar" style="width: 200px;">
                        <div class="nav-item active" onclick="ResMonitor.showTab('overview')">
                            <i class="fas fa-microchip mr-1"></i> Overview
                        </div>
                    </div>
                    <div class="flex-1 p-6 overflow-y-auto bg-[#191919] custom-scrollbar">
                        <!-- Overview Tab -->
                        <div id="res-tab-overview" class="block">
                            <h2 class="text-xl font-light text-white mb-6">System Performance</h2>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Account Info -->
                                <div class="res-card col-span-2 flex gap-4 items-center p-4 bg-[#252525]">
                                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center text-white text-xl shadow-lg">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-gray-400 uppercase tracking-widest font-semibold">User Profile</div>
                                        <div class="text-lg font-medium text-white" id="account-name-display">Loading...</div>
                                        <div class="text-xs text-gray-500 font-mono" id="account-email-display">Loading...</div>
                                    </div>
                                </div>

                                <!-- Network Activity Charts -->
                                <div class="res-card p-4">
                                    <div class="text-xs text-gray-400 font-semibold mb-2 uppercase">Throughput (In)</div>
                                    <div class="h-32 w-full relative">
                                        <canvas id="net-in-chart"></canvas>
                                    </div>
                                    <div class="text-right mt-2 font-mono text-lg text-white" id="net-in-val">0 KB/s</div>
                                </div>
                                <div class="res-card p-4">
                                    <div class="text-xs text-gray-400 font-semibold mb-2 uppercase">Throughput (Out)</div>
                                    <div class="h-32 w-full relative">
                                        <canvas id="net-out-chart"></canvas>
                                    </div>
                                    <div class="text-right mt-2 font-mono text-lg text-white" id="net-out-val">0 KB/s</div>
                                </div>

                                <!-- Storage Analysis -->
                                <div class="res-card col-span-2 p-4">
                                    <div class="flex gap-8">
                                        <div class="w-1/3 flex flex-col items-center justify-center">
                                            <div class="text-xs text-gray-400 mb-2">Storage Composition</div>
                                            <div class="relative w-32 h-32">
                                                <canvas id="storage-pie-chart"></canvas>
                                            </div>
                                            <div class="text-xs text-gray-300 mt-2 font-mono" id="storage-total-label">Calculating...</div>
                                        </div>

                                        <div class="flex-1">
                                            <div class="text-xs text-gray-400 mb-3 font-semibold uppercase border-b border-gray-700 pb-2">Breakdown</div>
                                            <div class="space-y-2 text-xs" id="storage-stats-container">
                                                <div class="flex justify-between items-center py-1 border-b border-[#333]">
                                                    <span class="text-gray-400"><i class="fas fa-image w-5 text-purple-400"></i> Pictures</span>
                                                    <span class="text-white font-mono" id="stat-images">0 B</span>
                                                </div>
                                                <div class="flex justify-between items-center py-1 border-b border-[#333]">
                                                    <span class="text-gray-400"><i class="fas fa-video w-5 text-pink-500"></i> Video</span>
                                                    <span class="text-white font-mono" id="stat-videos">0 B</span>
                                                </div>
                                                <div class="flex justify-between items-center py-1 border-b border-[#333]">
                                                    <span class="text-gray-400"><i class="fas fa-music w-5 text-yellow-500"></i> Music</span>
                                                    <span class="text-white font-mono" id="stat-audio">0 B</span>
                                                </div>
                                                <div class="flex justify-between items-center py-1 border-b border-[#333]">
                                                    <span class="text-gray-400"><i class="fas fa-file-word w-5 text-blue-500"></i> Documents</span>
                                                    <span class="text-white font-mono" id="stat-docs">0 B</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 3. NOTEPAD (NEW) -->
            <div id="win-notepad" class="window" style="width: 600px; height: 450px; top: 100px; left: 200px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-sticky-note text-white"></i> Notepad</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('notepad')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn" onclick="WindowManager.maximize('notepad')"><i class="far fa-square"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('notepad')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                <div class="explorer-toolbar h-8 bg-[#252525] flex items-center px-2 text-xs gap-1">
                    <button class="tool-btn" onclick="Notepad.save()"><i class="fas fa-save text-blue-400"></i> Save</button>
                    <button class="tool-btn" onclick="Notepad.download()"><i class="fas fa-download"></i> Download</button>
                    <div class="w-px h-4 bg-white/10 mx-1"></div>
                    <button class="tool-btn hover:text-red-400" onclick="Notepad.clear()"><i class="fas fa-trash"></i> Clear</button>
                    <span id="notepad-status" class="ml-auto text-gray-500 text-[10px] italic pr-2"></span>
                </div>
                <textarea id="notepad-area" class="flex-1 bg-[#1e1e1e] text-white p-4 outline-none resize-none font-mono text-sm border-none" placeholder="Type your notes here..."></textarea>
            </div>

            <!-- 4. CALENDAR (NEW) -->
            <div id="win-calendar" class="window" style="width: 320px; height: 380px; top: 100px; left: 300px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-calendar-alt text-blue-400"></i> Calendar</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('calendar')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('calendar')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                <div class="window-body flex-col bg-[#191919] p-4 select-none">
                     <div class="flex justify-between items-center mb-4">
                         <button onclick="CalendarApp.changeMonth(-1)" class="hover:bg-white/10 p-2 rounded text-gray-400 w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-left"></i></button>
                         <span id="cal-title" class="font-semibold text-lg">Month Year</span>
                         <button onclick="CalendarApp.changeMonth(1)" class="hover:bg-white/10 p-2 rounded text-gray-400 w-8 h-8 flex items-center justify-center"><i class="fas fa-chevron-right"></i></button>
                     </div>
                     <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 mb-2 font-semibold">
                         <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                     </div>
                     <div id="cal-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
                     <div class="mt-auto pt-4 border-t border-white/5 text-center">
                        <button onclick="CalendarApp.resetToToday()" class="text-xs text-blue-400 hover:text-blue-300">Go to Today</button>
                     </div>
                </div>
            </div>

            <!-- 5. RECYCLE BIN -->
            <div id="win-recycle-bin" class="window" style="width: 800px; height: 500px; top: 120px; left: 150px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-trash-can text-gray-400"></i> Recycle Bin</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('recycle-bin')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('recycle-bin')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                
                <div class="explorer-toolbar bg-[#1e1e1e]">
                    <div class="flex gap-2">
                        <button id="empty-trash-btn" class="tool-btn hover:text-red-400"><i class="fas fa-trash-arrow-up"></i> Empty Recycle Bin</button>
                        <button id="restore-all-btn" class="tool-btn hover:text-green-400"><i class="fas fa-rotate-left"></i> Restore all items</button>
                    </div>
                     <div class="flex-1"></div>
                     <div class="flex bg-[#252525] rounded border border-white/5 p-0.5">
                        <button id="trash-tiles-btn" class="p-1 px-2 rounded hover:bg-[#333] text-gray-400 text-xs"><i class="fas fa-th-large"></i></button>
                        <button id="trash-list-btn" class="p-1 px-2 rounded bg-white/10 text-white text-xs"><i class="fas fa-list"></i></button>
                    </div>
                </div>

                <div class="window-body">
                    <div class="window-content bg-[#191919]">
                        <div id="recycle-bin-content" class="custom-scrollbar flex-1 overflow-y-auto content-start p-4"></div>
                    </div>
                </div>
            </div>

            <!-- 6. UPLOAD MANAGER -->
            <div id="win-uploads" class="window" style="width: 400px; height: 350px; top: 100px; right: 120px; display: none; z-index: 2000;">
                <div class="window-header">
                    <div class="window-title">Uploads</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('uploads')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('uploads')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                <div class="window-body flex-col bg-[#202020]">
                    <div class="p-2 border-b border-white/5 flex justify-between items-center text-[11px] text-gray-400 bg-[#252525]">
                        <span id="upload-status-header">Ready</span>
                        <button onclick="document.getElementById('upload-items-container').innerHTML=''" class="hover:text-white transition-colors">Clear list</button>
                    </div>
                    <div id="upload-items-container" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="contextMenu" class="fixed hidden w-56 text-sm"></div>
    <div id="toast-container" class="fixed bottom-16 right-5 z-[6000] space-y-2"></div>

    <!-- Win Style Modals -->
    <div id="newFolderModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="win-modal p-6 rounded-lg w-80 text-white">
            <h3 class="font-semibold mb-4 text-sm">Create New Folder</h3>
            <input type="text" id="newFolderNameInput" placeholder="Name" class="bg-[#191919] border border-[#444] w-full p-2 rounded mb-6 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelNewFolderBtn" class="text-xs bg-[#333] hover:bg-[#444] text-white px-4 py-2 rounded">Cancel</button>
                <button id="confirmNewFolderBtn" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Create</button>
            </div>
        </div>
    </div>

    <div id="newFragmentModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="win-modal p-6 rounded-lg w-80 text-white">
            <h3 class="font-semibold mb-4 text-sm">Map Network Drive (Mount)</h3>
            <input type="text" id="newFragmentNameInput" placeholder="Mount Name" class="bg-[#191919] border border-[#444] w-full p-2 rounded mb-6 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelNewFragmentBtn" class="text-xs bg-[#333] hover:bg-[#444] text-white px-4 py-2 rounded">Cancel</button>
                <button id="confirmNewFragmentBtn" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Mount</button>
            </div>
        </div>
    </div>

    <div id="renameModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="win-modal p-6 rounded-lg w-96 text-white">
            <h3 class="font-semibold mb-4 text-sm">Rename</h3>
            <input id="newObjectKeyInput" class="bg-[#191919] border border-[#444] w-full p-2 rounded mb-6 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelRenameBtn" class="text-xs bg-[#333] hover:bg-[#444] text-white px-4 py-2 rounded">Cancel</button>
                <button id="confirmRenameBtn" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Save</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="win-modal p-6 rounded-lg w-96 text-white">
            <h3 class="font-semibold mb-4 text-sm">Share File</h3>
            <div class="space-y-4">
                <select id="shareDisposition" class="w-full bg-[#191919] border border-[#444] p-2 rounded text-sm outline-none text-white">
                    <option value="view">View Only</option>
                    <option value="stream">Stream (Video)</option>
                    <option value="download">Download</option>
                </select>
                <input id="shareExpiry" type="number" value="3600" placeholder="Expires in (seconds)" class="w-full bg-[#191919] border border-[#444] p-2 rounded text-sm outline-none text-white">
                <div class="flex gap-2">
                    <input id="shareUrl" class="flex-1 bg-[#191919] border border-[#444] p-2 rounded text-xs text-gray-300 font-mono" readonly placeholder="Link will appear here...">
                    <button id="copyShareUrlBtn" class="bg-[#333] hover:bg-[#444] px-3 rounded text-white border border-[#444]"><i class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="closeShareBtn" class="text-xs bg-[#333] hover:bg-[#444] text-white px-4 py-2 rounded">Close</button>
                <button id="generateShareBtn" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">Generate Link</button>
            </div>
        </div>
    </div>

    <div id="genericModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[5000] hidden flex items-center justify-center">
        <div class="win-modal p-6 rounded-lg w-96">
            <h3 id="modalTitle" class="text-sm font-bold text-white mb-4">Title</h3>
            <div id="modalContent" class="text-sm text-gray-300 mb-6"></div>
            <div class="flex justify-end gap-2">
                <button id="modalCancel" class="px-4 py-2 rounded text-xs bg-[#333] hover:bg-[#444] text-white border border-[#444]">Cancel</button>
                <button id="modalConfirm" class="px-4 py-2 rounded text-xs bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-500/30">Confirm</button>
            </div>
        </div>
    </div>

    <div id="progressModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[6000] hidden flex-col items-center justify-center">
        <div class="win-modal p-6 rounded-lg w-96">
            <h3 id="progressTitle" class="text-sm font-bold text-white mb-4">Processing...</h3>
            <div class="w-full bg-[#333] rounded-full h-1 mb-3">
                <div id="progressBar" class="bg-blue-600 h-1 rounded-full transition-all duration-200" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[11px] text-gray-400">
                <span id="progressStatus">Initializing...</span>
                <span id="progressCount">0/0</span>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="fileInput" class="hidden" multiple />
    <input type="file" id="folderInput" class="hidden" webkitdirectory directory />
    <input type="file" id="resumeFileInput" class="hidden">
    <button id="newFolderBtnAction" class="hidden"></button>

    <script>
        // --- Core Variables ---
        let currentObjectList = [];
        let clientSideFolders = [];
        let clientSideFragments = [];
        let starredItems = JSON.parse(localStorage.getItem('starredItems')) || [];
        let trashedItems = JSON.parse(localStorage.getItem('trashedItems')) || [];
        let openFilesMap = new Map();
        let activeFragment = 'My Files';
        let currentPath = '';
        let currentView = 'tiles';
        let currentTrashView = 'list';
        // Changed to localhost to match typical N1 backend setups by default
        const serverLink = `https://storage.litiaina.com`; 
        const token = localStorage.getItem("current-token")?.trim() || "";
        let totalCapacity = Number(localStorage.getItem("current-capacity")?.trim()) || (15 * 1024 * 1024 * 1024);
        let uploadQueue = [];
        let activeUploads = 0;
        // HTTP/2 Optimization: Increased from 5 to 10 for parallel file uploads
        const MAX_CONCURRENT_UPLOADS = 1;
        const MB = 1024 * 1024;

        // User Info from LocalStorage
        const userEmail = localStorage.getItem("current-account-email") || "user@n1cloud.com";
        const userName = localStorage.getItem("current-account-name") || "N1 User";

        // Global App Logic
        const App = {
            logout: function() {
                localStorage.removeItem('current-token'); 
                localStorage.removeItem('current-account-email'); 
                localStorage.removeItem('current-account-uid'); 
                localStorage.removeItem('current-account-name'); 
                localStorage.removeItem('current-capacity');
                window.location.reload();
                window.location.href='../';
            }
        };

        const StartMenu = {
            toggle: function() {
                const menu = document.getElementById('start-menu');
                const btn = document.getElementById('start-btn');
                if (menu.classList.contains('hidden')) {
                    menu.classList.remove('hidden');
                    btn.classList.add('active');
                } else {
                    menu.classList.add('hidden');
                    btn.classList.remove('active');
                }
            },
            close: function() {
                document.getElementById('start-menu').classList.add('hidden');
                document.getElementById('start-btn').classList.remove('active');
            }
        };

        // --- Notepad App ---
        const Notepad = {
            init: function() {
                const saved = localStorage.getItem('notepad-content');
                if (saved) {
                    document.getElementById('notepad-area').value = saved;
                }
                
                // Auto save on input
                document.getElementById('notepad-area').addEventListener('input', (e) => {
                    localStorage.setItem('notepad-content', e.target.value);
                    document.getElementById('notepad-status').innerText = 'Saved locally';
                    setTimeout(() => document.getElementById('notepad-status').innerText = '', 2000);
                });
            },
            save: function() {
                const content = document.getElementById('notepad-area').value;
                localStorage.setItem('notepad-content', content);
                showToast('Note saved to local storage', 'success');
            },
            download: function() {
                const content = document.getElementById('notepad-area').value;
                const blob = new Blob([content], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `note_${new Date().toISOString().slice(0,10)}.txt`;
                a.click();
            },
            clear: function() {
                if(confirm('Clear notepad?')) {
                    document.getElementById('notepad-area').value = '';
                    localStorage.removeItem('notepad-content');
                }
            }
        };

        // --- Calendar App ---
        const CalendarApp = {
            date: new Date(),
            init: function() {
                this.render();
            },
            render: function() {
                const year = this.date.getFullYear();
                const month = this.date.getMonth();
                const today = new Date();

                // Set Title
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                document.getElementById('cal-title').innerText = `${monthNames[month]} ${year}`;

                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const grid = document.getElementById('cal-grid');
                grid.innerHTML = '';

                // Empty slots
                for (let i = 0; i < firstDay; i++) {
                    grid.innerHTML += `<div></div>`;
                }

                // Days
                for (let i = 1; i <= daysInMonth; i++) {
                    const isToday = i === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                    const cls = isToday ? 'bg-blue-600 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center mx-auto' : 'w-8 h-8 flex items-center justify-center mx-auto hover:bg-white/10 rounded-full cursor-pointer text-gray-300';
                    grid.innerHTML += `<div class="${cls}">${i}</div>`;
                }
            },
            changeMonth: function(delta) {
                this.date.setMonth(this.date.getMonth() + delta);
                this.render();
            },
            resetToToday: function() {
                this.date = new Date();
                this.render();
            }
        };

        // Stats for Network Graph
        // Removed global variable since each upload calculates its own speed now

        // Selection Manager State
        const SelectionManager = {
            selectedItems: new Set(), // Set of strings: "folder:name" or "file:key"
            lastSelectedIndex: -1,
            clear: function () {
                this.selectedItems.clear();
                this.updateUI();
            },
            toggle: function (id, isRange = false, allItems = []) {
                if (isRange && this.lastSelectedIndex !== -1 && allItems.length > 0) {
                    // Range logic
                    const currentIndex = allItems.findIndex(i => i.id === id);
                    if (currentIndex !== -1) {
                        const start = Math.min(this.lastSelectedIndex, currentIndex);
                        const end = Math.max(this.lastSelectedIndex, currentIndex);
                        for (let i = start; i <= end; i++) {
                            this.selectedItems.add(allItems[i].id);
                        }
                    }
                } else {
                    if (this.selectedItems.has(id)) {
                        this.selectedItems.delete(id);
                    } else {
                        this.selectedItems.add(id);
                        // Find index for range selection
                        if (allItems.length) {
                            this.lastSelectedIndex = allItems.findIndex(i => i.id === id);
                        }
                    }
                }
                this.updateUI();
            },
            selectSingle: function (id, allItems = []) {
                this.selectedItems.clear();
                this.selectedItems.add(id);
                if (allItems.length) {
                    this.lastSelectedIndex = allItems.findIndex(i => i.id === id);
                }
                this.updateUI();
            },
            updateUI: function () {
                // Update Visuals
                document.querySelectorAll('.file-item').forEach(el => {
                    const id = el.dataset.id;
                    if (this.selectedItems.has(id)) el.classList.add('selected');
                    else el.classList.remove('selected');
                });
                // Update Status Bar
                const count = this.selectedItems.size;
                document.getElementById('selection-status').textContent = `${count} item${count !== 1 ? 's' : ''} selected`;
            },
            getSelection: function () {
                return Array.from(this.selectedItems).map(id => {
                    const [type, ...rest] = id.split(':');
                    const key = rest.join(':');
                    return {
                        type,
                        key
                    };
                });
            }
        };

        const thumbnailCache = {
            map: new Map(),
            maxSize: 100,
            get(key) { return this.map.get(key); },
            has(key) { return this.map.has(key); },
            set(key, url) {
                if (this.map.has(key)) return;

                if (this.map.size >= this.maxSize) {
                    const firstKey = this.map.keys().next().value;
                    const oldUrl = this.map.get(firstKey);
                    URL.revokeObjectURL(oldUrl);
                    this.map.delete(firstKey);
                }
                this.map.set(key, url);
            }
        };

        // --- Thumbnail Queue System ---
        const ThumbnailLoader = {
            queue: [],
            processing: new Set(),
            maxConcurrent: 4, // Reduced from 8 to keep UI responsive

            enqueue: function (imgElement, fragment, key) {
                if (thumbnailCache.has(key)) {
                    this.apply(imgElement, thumbnailCache.get(key));
                    return;
                }

                // Avoid adding duplicates to queue
                if (this.queue.some(item => item.key === key)) return;

                // Add to queue
                this.queue.push({ imgElement, fragment, key });
                this.process();
            },

            process: async function () {
                if (this.processing.size >= this.maxConcurrent || this.queue.length === 0) return;

                const item = this.queue.shift();
                const { imgElement, fragment, key } = item;

                // --- PERFORMANCE FIX ---
                // If the element is no longer in the DOM (user scrolled past it), 
                // DROP the request. Do not download.
                if (!imgElement.isConnected) {
                    this.process(); // Skip to next
                    return;
                }

                this.processing.add(key);

                try {
                    // Fetch logic
                    const directUrl = `${serverLink}/v4/fragment/object/get/${fragment}/${key}`;
                    const res = await fetch(directUrl, {
                        headers: { 'Authorization': `Bearer ${token}` },
                        // Optional: Add AbortSignal here if you want to cancel mid-flight requests
                    });

                    if (!res.ok) throw new Error('Fetch failed');

                    const blob = await res.blob();

                    // Double-check: Did the user scroll away while we were downloading?
                    if (!imgElement.isConnected) {
                        // If yes, discard the blob without creating a URL
                        this.processing.delete(key);
                        this.process();
                        return;
                    }

                    const objectUrl = URL.createObjectURL(blob);
                    thumbnailCache.set(key, objectUrl);
                    this.apply(imgElement, objectUrl);

                } catch (e) {
                    // Silently fail or log debug
                } finally {
                    this.processing.delete(key);
                    this.process(); // Trigger next
                }
            },

            apply: function (img, url) {
                if (!img.isConnected) return;
                // Use requestAnimationFrame for smoother UI updates
                requestAnimationFrame(() => {
                    img.src = url;
                    img.onload = () => {
                        img.classList.remove('opacity-0');
                        if (img.previousElementSibling) img.previousElementSibling.classList.add('opacity-0');
                    };
                });
            }
        };

        // --- IMAGE OBSERVER ---
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const img = entry.target;
                const key = img.getAttribute('data-key');
                const fragment = img.getAttribute('data-fragment');

                if (entry.isIntersecting) {
                    ThumbnailLoader.enqueue(img, fragment, key);
                    imageObserver.unobserve(img);
                }
            });
        }, {
            root: document.getElementById('browser'),
            rootMargin: '200px', // Preload a bit more ahead since we are throttling
            threshold: 0.01
        });

        // --- Window Manager ---
        const WindowManager = {
            zIndex: 100,
            open: function (appId, meta = {}) {
                // Handle Start Menu auto-close logic
                if (appId !== 'start-menu') StartMenu.close();

                const win = $(`#win-${appId}`);
                if (win.is(':visible')) {
                    this.focus(appId);
                    return;
                }
                win.show();
                setTimeout(() => win.addClass('visible'), 10);
                this.focus(appId);
                this.addTaskbarItem(appId, meta);
                
                // App Specific Init
                if (appId === 'dashboard') setTimeout(() => ResMonitor.init(), 100);
                if (appId === 'recycle-bin') showTrash();
                if (appId === 'notepad') Notepad.init();
                if (appId === 'calendar') CalendarApp.init();
                
                if (appId === 'file-explorer') {
                    if (activeFragment && currentObjectList.length === 0) listObjects(activeFragment);
                    else setTimeout(() => VirtualScroller.renderVisible(), 50);
                }
                if (appId === 'uploads') checkForInterruptedUploads();
            },
            close: function (appId) {
                const win = $(`#win-${appId}`);
                win.removeClass('visible');
                setTimeout(() => {
                    win.hide();
                    if (appId.startsWith('viewer-')) {
                        win.remove();
                        for (let [key, val] of openFilesMap.entries()) {
                            if (val === appId) openFilesMap.delete(key);
                        }
                    }
                }, 150);
                $(`#task-item-${appId}`).remove();
            },
            minimize: function (appId) {
                $(`#win-${appId}`).removeClass('visible');
                setTimeout(() => $(`#win-${appId}`).hide(), 150);
                $(`#task-item-${appId}`).removeClass('active');
            },
            maximize: function (appId) {
                const win = $(`#win-${appId}`);
                win.toggleClass('maximized');
                if (win.hasClass('maximized')) win.css({
                    top: '0',
                    left: 0,
                    width: '100%',
                    height: '100%',
                    borderRadius: 0
                });
                else {
                    const defaults = {
                        'file-explorer': { w: 1000, h: 650, t: 60, l: 100 },
                        'dashboard': { w: 900, h: 600, t: 80, l: 150 },
                        'recycle-bin': { w: 800, h: 500, t: 120, l: 150 },
                        'uploads': { w: 400, h: 350, t: 100, l: 120 },
                        'notepad': { w: 600, h: 450, t: 100, l: 200 },
                        'calendar': { w: 320, h: 380, t: 100, l: 300 }
                    }[appId] || {
                        w: 800,
                        h: 550,
                        t: 100,
                        l: 100
                    };
                    win.css({
                        width: defaults.w,
                        height: defaults.h,
                        top: defaults.t,
                        left: defaults.l,
                        borderRadius: '6px'
                    });
                }
            },
            focus: function (appId) {
                this.zIndex++;
                $(`#win-${appId}`).css('z-index', this.zIndex);
                $('.task-item').removeClass('active');
                $(`#task-item-${appId}`).addClass('active');
                
                // If it's start menu related, close start menu if clicking window
                if(appId !== 'start-menu') StartMenu.close();
            },
            addTaskbarItem: function (appId, meta = {}) {
                if ($(`#task-item-${appId}`).length === 0) {
                    const map = {
                        'file-explorer': 'File Explorer',
                        'dashboard': 'Resource Monitor',
                        'recycle-bin': 'Recycle Bin',
                        'uploads': 'Upload Queue',
                        'notepad': 'Notepad',
                        'calendar': 'Calendar'
                    };
                    const iconMap = {
                        'file-explorer': 'fa-folder',
                        'dashboard': 'fa-chart-line',
                        'recycle-bin': 'fa-trash-can',
                        'uploads': 'fa-cloud-arrow-up',
                        'notepad': 'fa-sticky-note',
                        'calendar': 'fa-calendar-alt'
                    };
                    const label = meta.title || map[appId] || 'App';
                    const icon = meta.icon || iconMap[appId] || 'fa-window-maximize';
                    // Updated to match new CSS
                    $('#taskbar-apps').append(`<div id="task-item-${appId}" class="task-item active" onclick="WindowManager.open('${appId}')" title="${label}"><i class="fas ${icon}"></i></div>`);
                }
            }
        };

        // --- Resource Monitor (Chart.js) ---
        const ResMonitor = {
            charts: {},
            init: function () {
                if (!document.getElementById('net-in-chart').offsetParent) return;
                if (this.charts['net-in']) return;

                // Update Account Info
                $('#account-name-display').text(userName);
                $('#account-email-display').text(userEmail);

                this.initCharts();
                updateCapacityDisplay();
                updateStorageStats(); // Initial Draw of Pie Chart
            },
            showTab: function (tabId) {
                $('.res-tab').removeClass('active');
                $(`.res-tab[onclick*="${tabId}"]`).addClass('active');
            },
            initCharts: function () {
                Chart.defaults.color = '#a3a3a3';
                Chart.defaults.borderColor = '#333';
                Chart.defaults.font.family = "'Segoe UI', sans-serif";

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            min: 0,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                callback: function (val) {
                                    return formatBytes(val, 0) + '/s';
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        },
                        line: {
                            tension: 0.4,
                            borderWidth: 2
                        }
                    }
                };

                // Net In Chart
                this.charts['net-in'] = new Chart(document.getElementById('net-in-chart'), {
                    type: 'line',
                    data: {
                        labels: Array(30).fill(''),
                        datasets: [{
                            data: Array(30).fill(0),
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f620',
                            fill: true
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                max: 20 * 1024 * 1024
                            }
                        }
                    } // Cap axis for visuals
                });

                // Net Out Chart
                this.charts['net-out'] = new Chart(document.getElementById('net-out-chart'), {
                    type: 'line',
                    data: {
                        labels: Array(30).fill(''),
                        datasets: [{
                            data: Array(30).fill(0),
                            borderColor: '#22c55e',
                            backgroundColor: '#22c55e20',
                            fill: true
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                max: 10 * 1024 * 1024
                            }
                        }
                    }
                });

                // Pie Chart
                this.charts['pie'] = new Chart(document.getElementById('storage-pie-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Images', 'Videos', 'Audio', 'Docs', 'Archives', 'Other'],
                        datasets: [{
                            data: [1, 1, 1, 1, 1, 1], // Placeholders
                            backgroundColor: ['#c084fc', '#ec4899', '#eab308', '#3b82f6', '#f97316', '#6b7280'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Simulation Loop
                setInterval(() => {
                    this.updateNetworkCharts();
                }, 1000);
            },
            updateNetworkCharts: function () {
                if (!this.charts['net-in']) return;

                // Simulate Network Traffic (Base noise + active upload speed)
                // Base noise: 100KB - 500KB download (idle chatter), 10KB - 50KB upload
                const baseDown = Math.random() * 400 * 1024 + 100 * 1024;
                const baseUp = Math.random() * 40 * 1024 + 10 * 1024;

                // Calculate total upload speed from all active uploads
                const totalUploadSpeed = uploadQueue.reduce((acc, item) => acc + (item.currentSpeed || 0), 0);

                const totalUp = baseUp + totalUploadSpeed;
                const totalDown = baseDown; // We don't track download speed variable yet

                // Update Data Arrays
                const update = (chart, val, labelId) => {
                    const data = chart.data.datasets[0].data;
                    data.push(val);
                    data.shift();
                    chart.update('none');
                    document.getElementById(labelId).innerText = formatBytes(val) + '/s';
                };

                update(this.charts['net-in'], totalDown, 'net-in-val');
                update(this.charts['net-out'], totalUp, 'net-out-val');
            },
            updatePieChart: function (stats) {
                if (!this.charts['pie']) return;
                const data = [stats.images.size, stats.videos.size, stats.audio.size, stats.docs.size, stats.archives.size, stats.others.size];
                // If all zero, show placeholder
                if (data.every(v => v === 0)) this.charts['pie'].data.datasets[0].data = [1, 0, 0, 0, 0, 0];
                else this.charts['pie'].data.datasets[0].data = data;
                this.charts['pie'].update();
            }
        };

        // --- Core File System ---
        const AppNav = {
            navigate: function (view) {
                $('.nav-item').not('.fragment-item').removeClass('active');
                $(`#nav-${view}`).addClass('active');
                if (view === 'my-files') {
                    currentPath = '';
                    renderObjects(getActiveObjectList());
                } else if (view === 'recent') showRecentFiles();
                else if (view === 'starred') showStarredFiles();
            }
        };

        function getActiveObjectList() {
            const trashKeys = new Set(trashedItems.map(t => t.key));
            return currentObjectList.filter(o => !trashKeys.has(o.key));
        }

        const VirtualScroller = {
            items: [],
            container: null,
            content: null,
            viewType: 'tiles',
            ticking: false,
            lastStartIndex: -1,
            lastEndIndex: -1,

            init: function (containerId, contentId) {
                this.container = document.getElementById(containerId);
                this.content = document.getElementById(contentId);
                if (this.container) {
                    this.container.addEventListener('scroll', () => {
                        if (!this.ticking) {
                            window.requestAnimationFrame(() => {
                                this.renderVisible();
                                this.ticking = false;
                            });
                            this.ticking = true;
                        }
                    });
                    window.addEventListener('resize', () => {
                        if (!this.ticking) {
                            window.requestAnimationFrame(() => {
                                this.forceRender();
                                this.ticking = false;
                            });
                            this.ticking = true;
                        }
                    });
                }
            },
            setItems: function (items, viewType) {
                this.items = items;
                // If view type changes, we must clear the DOM to prevent recycling wrong element types
                if (this.viewType !== viewType && this.content) {
                    this.content.innerHTML = '';
                }
                this.viewType = viewType;
                if (this.container) this.container.scrollTop = 0;
                this.forceRender();
                SelectionManager.clear();
            },
            forceRender: function () {
                this.lastStartIndex = -1;
                this.renderVisible(true);
            },
            getColumns: function () {
                if (this.viewType === 'list') return 1;
                if (this.container) return Math.max(2, Math.floor(this.container.clientWidth / 108)); // Smaller tiles for Windows look
                return 5;
            },
            getRowHeight: function () {
                return this.viewType === 'tiles' ? 164 : 42;
            },
            renderVisible: function (force = false) {
                if (!this.container || !this.content) return;
                if (!this.items.length) {
                    this.content.innerHTML = `<div class="col-span-full py-20 text-center text-gray-500 flex flex-col items-center justify-center h-full"><i class="far fa-folder-open text-5xl mb-4 opacity-30"></i><p>This folder is empty</p></div>`;
                    this.content.style.paddingTop = '0px';
                    this.content.style.paddingBottom = '0px';
                    return;
                }

                const columns = this.getColumns();
                const rowHeight = this.getRowHeight();
                const totalItems = this.items.length;
                const totalRows = Math.ceil(totalItems / columns);
                const scrollTop = this.container.scrollTop;
                const clientHeight = this.container.clientHeight;

                // Increased buffer to 4 to prevent gray zones during fast scrolling
                const buffer = 4;
                const startRow = Math.max(0, Math.floor(scrollTop / rowHeight) - buffer);
                const endRow = Math.min(totalRows, Math.ceil((scrollTop + clientHeight) / rowHeight) + buffer);

                const startIndex = startRow * columns;
                const endIndex = Math.min(totalItems, endRow * columns);

                if (!force && startIndex === this.lastStartIndex && endIndex === this.lastEndIndex) return;

                this.lastStartIndex = startIndex;
                this.lastEndIndex = endIndex;

                const paddingTop = startRow * rowHeight;
                const paddingBottom = Math.max(0, (totalRows * rowHeight) - (endRow * rowHeight));

                // Apply padding changes only if necessary to avoid reflows
                if (this.content.style.paddingTop !== `${paddingTop}px`) this.content.style.paddingTop = `${paddingTop}px`;
                if (this.content.style.paddingBottom !== `${paddingBottom}px`) this.content.style.paddingBottom = `${paddingBottom}px`;

                // Layout Update
                if (this.viewType === 'tiles') {
                    if (this.content.className !== 'grid gap-1 p-2 content-start')
                        this.content.className = 'grid gap-1 p-2 content-start';
                    this.content.style.gridTemplateColumns = `repeat(auto-fill, minmax(100px, 1fr))`;
                    this.content.style.display = 'grid';
                } else {
                    if (this.content.className !== 'flex flex-col gap-1 p-2 content-start')
                        this.content.className = 'flex flex-col gap-1 p-2 content-start';
                    this.content.style.gridTemplateColumns = 'none';
                    this.content.style.display = 'flex';
                }

                // --- DOM Recycling Logic ---

                // 1. Snapshot currently rendered nodes by ID
                const existingNodes = new Map();
                // Convert HTMLCollection to Array to avoid live collection issues
                Array.from(this.content.children).forEach(child => {
                    if (child.dataset.id) existingNodes.set(child.dataset.id, child);
                });

                // 2. Build Fragment with recycled or new nodes
                const fragment = document.createDocumentFragment();
                const slice = this.items.slice(startIndex, endIndex);

                slice.forEach(itemData => {
                    const id = itemData.id;
                    let el = existingNodes.get(id);

                    if (el) {
                        // Reuse existing node (moves it from current parent to fragment)
                        // This preserves the <img> state so it doesn't reload/flash
                        fragment.appendChild(el);
                        existingNodes.delete(id); // Mark as claimed
                    } else {
                        // Create new node only if it doesn't exist
                        el = itemData.type === 'folder'
                            ? (this.viewType === 'tiles' ? createTile(itemData, 'folder') : createRow(itemData, 'folder'))
                            : (this.viewType === 'tiles' ? createTile(itemData, 'file') : createRow(itemData, 'file'));
                        fragment.appendChild(el);
                    }

                    // CRITICAL FIX: Update selection state inline.
                    // Checking selection map is fast (O(1)).
                    // Updating classList on a detached/fragment element is fast (no reflow).
                    if (SelectionManager.selectedItems.has(id)) {
                        el.classList.add('selected');
                    } else {
                        el.classList.remove('selected');
                    }
                });

                // 3. Atomic Update: This removes any nodes left in 'content' (unused ones) and inserts the fragment
                this.content.replaceChildren(fragment);
            }
        };

        function renderObjects(objects, keepScroll = false) {
            const breadcrumb = document.getElementById('breadcrumb');
            const backBtn = document.getElementById('back-btn');
            
            // Generate Breadcrumb UI
            if (currentPath) {
                backBtn.disabled = false;
                backBtn.classList.remove('opacity-30');
                
                let parts = currentPath.split('/').filter(p => p);
                let html = `<span class="breadcrumb-segment" onclick="navigateTo('')">Local Files</span>`;
                let acc = '';
                parts.forEach(p => {
                    acc += p + '/';
                    html += ` <span class="text-gray-500 text-[10px]"><i class="fas fa-chevron-right"></i></span> <span class="breadcrumb-segment" onclick="navigateTo('${acc}')">${p}</span>`;
                });
                breadcrumb.innerHTML = html;
            } else {
                backBtn.disabled = true;
                backBtn.classList.add('opacity-30');
                breadcrumb.innerHTML = '<span class="breadcrumb-segment">Local Files</span>';
            }
            
            const folders = new Set();
            const files = [];
            objects.forEach(obj => {
                if (obj.key.startsWith(currentPath)) {
                    const relative = obj.key.substring(currentPath.length);
                    const slashIdx = relative.indexOf('/');
                    if (slashIdx > 0) folders.add(relative.substring(0, slashIdx));
                    else if (slashIdx === -1 && relative.length > 0) files.push(obj);
                }
            });
            clientSideFolders.filter(f => f.path === currentPath && f.fragment === activeFragment).forEach(f => folders.add(f.name));
            const sortedFolders = Array.from(folders).sort();
            const sortedFiles = files.sort((a, b) => new Date(Number(b.last_modified.$date.$numberLong)) - new Date(Number(a.last_modified.$date.$numberLong)));

            const items = [
                ...sortedFolders.map(f => ({
                    type: 'folder',
                    name: f,
                    id: `folder:${f}`
                })),
                ...sortedFiles.map(f => ({
                    type: 'file',
                    data: f,
                    id: `file:${f.key}`
                }))
            ];

            // Pass keepScroll to VirtualScroller to prevent jumping
            VirtualScroller.setItems(items, currentView, keepScroll);
        }


        function showRecentFiles() {
            $('#breadcrumb').html('Recent Files');
            $('#back-btn').addClass('opacity-30');
            const flat = currentObjectList.filter(o => !o.key.endsWith('/')).sort((a, b) => new Date(Number(b.last_modified.$date.$numberLong)) - new Date(Number(a.last_modified.$date.$numberLong))).slice(0, 50);
            VirtualScroller.setItems(flat.map(i => ({
                type: 'file',
                data: i,
                id: `file:${i.key}`
            })), 'list');
        }

        function showStarredFiles() {
            $('#breadcrumb').html('Favorites');
            $('#back-btn').addClass('opacity-30');
            const flat = currentObjectList.filter(o => starredItems.includes(o.key));
            VirtualScroller.setItems(flat.map(i => ({
                type: 'file',
                data: i,
                id: `file:${i.key}`
            })), 'list');
        }

        function createTile(itemData, type) {
            const div = document.createElement('div');
            // Extract data depending on wrapper from VirtualScroller
            const item = type === 'folder' ? itemData.name : itemData.data;
            const uniqueId = itemData.id;

            const isPending = type === 'file' && item.status === 'Pending';
            div.className = `file-item item-tile p-2 flex flex-col items-center group relative ${isPending ? 'opacity-50' : ''}`;
            div.dataset.id = uniqueId;

            const name = type === 'folder' ? item : item.key.split('/').pop();
            const ext = name.split('.').pop().toLowerCase();
            const isImage = type === 'file' && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'tiff'].includes(ext);
            const iconHtml = type === 'folder' ? '<i class="fas fa-folder text-6xl text-yellow-400 mb-2 drop-shadow-md"></i>' : getFileIconHTML(name);

            let visualContent;
            if (isImage && !isPending) {
                const cachedUrl = thumbnailCache.get(item.key);
                visualContent = `<div class="relative w-full h-24 mb-2 flex items-center justify-center bg-[#252525] rounded"><div class="icon-placeholder absolute transition-opacity duration-300 ${cachedUrl ? 'opacity-0' : ''}">${iconHtml}</div><img class="img-preview absolute inset-0 w-full h-full object-contain p-1 rounded transition-opacity duration-300 ${cachedUrl ? '' : 'opacity-0'}" alt="${name}" src="${cachedUrl || ''}" data-key="${item.key}" data-fragment="${item.fragment}" loading="lazy"></div>`;
            } else {
                visualContent = `<div class="mb-2 h-24 flex items-center justify-center">${iconHtml}</div>`;
            }

            div.innerHTML = `${visualContent}${isPending ? `<div class="absolute top-2 right-2 text-yellow-500"><i class="fas fa-clock"></i></div>` : ''}<span class="text-[11px] text-center break-all line-clamp-2 leading-tight w-full text-gray-300 mt-1 max-h-8 overflow-hidden" title="${name}">${name}</span>`;
            if (isImage && !isPending && !thumbnailCache.has(item.key)) imageObserver.observe(div.querySelector('.img-preview'));

            // Event Listeners for Interaction
            attachItemListeners(div, uniqueId, type, item);
            return div;
        }

        function createRow(itemData, type) {
            const div = document.createElement('div');
            const item = type === 'folder' ? itemData.name : itemData.data;
            const uniqueId = itemData.id;

            const isPending = type === 'file' && item.status === 'Pending';
            div.className = `file-item item-list flex items-center px-4 py-2 ${isPending ? 'opacity-50' : ''}`;
            div.dataset.id = uniqueId;

            const name = type === 'folder' ? item : item.key.split('/').pop();
            const ext = name.split('.').pop().toLowerCase();
            const isImage = type === 'file' && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'tiff'].includes(ext);
            const iconHtml = type === 'folder' ? '<i class="fas fa-folder text-yellow-400 w-6 text-center mr-3"></i>' : getFileIconHTML(name, true);
            let iconSection = isImage && !isPending ? `<div class="relative w-6 h-6 mr-3 flex-shrink-0 flex items-center justify-center"><div class="icon-placeholder absolute inset-0 flex items-center justify-center ${thumbnailCache.has(item.key) ? 'opacity-0' : ''}">${iconHtml}</div><img class="img-preview absolute inset-0 w-full h-full object-cover rounded transition-opacity duration-300 ${thumbnailCache.has(item.key) ? '' : 'opacity-0'}" alt="${name}" src="${thumbnailCache.get(item.key) || ''}" data-key="${item.key}" data-fragment="${item.fragment}" loading="lazy"></div>` : iconHtml;
            
            // Windows Details View Layout
            div.innerHTML = `
                <div class="flex-1 min-w-0 flex items-center">
                    ${iconSection}
                    <span class="text-xs text-gray-300 truncate">${name}</span>
                    ${isPending ? `<i class="fas fa-clock text-yellow-500 ml-2 text-xs"></i>` : ''}
                </div>
                <div class="w-32 text-xs text-gray-500 text-right">
                   ${type === 'file' ? new Date(Number(item.last_modified.$date.$numberLong)).toLocaleDateString() : ''}
                </div>
                <div class="w-24 text-xs text-gray-500 text-right">
                    ${type === 'file' ? formatBytes(item.size_bytes) : ''}
                </div>
            `;
            if (isImage && !isPending && !thumbnailCache.has(item.key)) imageObserver.observe(div.querySelector('.img-preview'));

            attachItemListeners(div, uniqueId, type, item);
            return div;
        }

        function attachItemListeners(div, id, type, item) {
            div.onclick = (e) => {
                e.stopPropagation();
                if (e.ctrlKey || e.metaKey) {
                    SelectionManager.toggle(id);
                } else if (e.shiftKey) {
                    SelectionManager.toggle(id, true, VirtualScroller.items);
                } else {
                    SelectionManager.selectSingle(id, VirtualScroller.items);
                }
            };

            div.ondblclick = (e) => {
                e.stopPropagation();
                if (type === 'folder') navigateTo(currentPath + item + '/');
                else openFileViewer(item.fragment, item.key);
            };

            div.oncontextmenu = (e) => {
                if (!SelectionManager.selectedItems.has(id)) {
                    SelectionManager.selectSingle(id, VirtualScroller.items);
                }
                showCtx(e, {
                    type,
                    data: item,
                    id
                });
            };
        }

        function navigateTo(path) {
            currentPath = path;
            renderObjects(getActiveObjectList());
        }

        function navigateBack() {
            if (!currentPath) return;
            const parts = currentPath.split('/').filter(p => p);
            parts.pop();
            navigateTo(parts.length ? parts.join('/') + '/' : '');
        }

        // --- ENHANCED FILE VIEWER ---
        async function openFileViewer(fragment, key) {
            if (openFilesMap.has(key)) {
                WindowManager.open(openFilesMap.get(key));
                return;
            }
            const viewerId = `viewer-${crypto.randomUUID()}`;
            openFilesMap.set(key, viewerId);
            const fileName = key.split('/').pop();
            const ext = key.split('.').pop().toLowerCase();

            // File Type Detection
            const isImage = ['jpg', 'png', 'jpeg', 'gif', 'svg', 'webp', 'bmp', 'tiff'].includes(ext);
            const isVideo = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'm3u8'].includes(ext);
            const isAudio = ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg'].includes(ext);
            const isPdf = ['pdf'].includes(ext);
            const isDocx = ['docx'].includes(ext);
            const isXlsx = ['xlsx', 'xls', 'csv'].includes(ext);

            // Zoom controls (Images only)
            let zoomControls = isImage ? `<div class="zoom-controls mr-2 flex border border-white/10 rounded overflow-hidden"><button class="tool-btn zoom-out-btn px-2" title="Zoom Out"><i class="fas fa-search-minus"></i></button><button class="tool-btn zoom-reset-btn px-2 text-[10px]" title="Reset">100%</button><button class="tool-btn zoom-in-btn px-2" title="Zoom In"><i class="fas fa-search-plus"></i></button></div>` : '';

            // Window Template matching new Windows Style
            const windowHtml = `
            <div id="win-${viewerId}" class="window" style="width: 900px; height: 600px; top: 100px; left: 100px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-eye text-blue-400"></i> ${fileName}</div>
                    <div class="window-controls">
                        <div class="win-control-btn" onclick="WindowManager.minimize('${viewerId}')"><i class="fas fa-minus"></i></div>
                        <div class="win-control-btn" onclick="WindowManager.maximize('${viewerId}')"><i class="far fa-square"></i></div>
                        <div class="win-control-btn close-btn" onclick="WindowManager.close('${viewerId}')"><i class="fas fa-times"></i></div>
                    </div>
                </div>
                <div class="window-body flex-col bg-[#111]">
                    <div class="explorer-toolbar h-10 bg-[#252525]">
                        ${zoomControls}
                        <button class="tool-btn print-btn"><i class="fas fa-print"></i> Print</button>
                        <button class="tool-btn download-btn"><i class="fas fa-download"></i> Save</button>
                        <button class="tool-btn share-btn"><i class="fas fa-share-alt"></i> Share</button>
                        <div class="h-4 w-px bg-white/10 mx-2"></div>
                        <button class="tool-btn hover:text-red-400 delete-btn"><i class="fas fa-trash"></i> Delete</button>
                        <button class="tool-btn rename-btn"><i class="fas fa-pen"></i> Rename</button>
                    </div>
                    <div class="viewer-content flex-1 flex items-center justify-center overflow-hidden p-0 relative w-full h-full bg-[#101010]">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-blue-500"></i>
                    </div>
                </div>
            </div>`;

            $('#windows-container').append(windowHtml);
            $(`#win-${viewerId}`).draggable({
                handle: ".window-header",
                containment: "#windows-container",
                start: function () { WindowManager.focus(viewerId); }
            }).resizable({ minHeight: 200, minWidth: 300 });
            $(`#win-${viewerId}`).on('mousedown', function () { WindowManager.focus(viewerId); });

            WindowManager.open(viewerId, { title: fileName, icon: 'fa-eye' });

            const winContext = $(`#win-${viewerId}`);
            winContext.find('.download-btn').click(() => performDirectDownload(fragment, key));
            winContext.find('.share-btn').click(() => showShareModal(fragment, key));
            winContext.find('.rename-btn').click(() => showRenameModal(fragment, key));
            winContext.find('.delete-btn').click(() => {
                showGenericModal('Delete File', 'Are you sure?', () => {
                    moveToTrash(key, 'file');
                    WindowManager.close(viewerId);
                });
            });

            // --- Print / Save as PDF Logic ---
            winContext.find('.print-btn').click(() => {
                if (isPdf) {
                    // PDFs have their own print button inside the embed usually, but we can try to trigger it
                    const iframe = winContext.find('embed')[0];
                    if (iframe) iframe.contentWindow.print();
                } else if (isImage) {
                    const img = winContext.find('img')[0];
                    const w = window.open("");
                    w.document.write(`<img src="${img.src}" style="max-width:100%;">`);
                    w.print();
                    w.close();
                } else if (isDocx || isXlsx) {
                    // For Docs/Excel, we print the rendered HTML
                    const content = winContext.find('.viewer-content').html();
                    const w = window.open("", "_blank", "width=800,height=600");
                    w.document.write(`<html><head><title>${fileName}</title><style>body { font-family: sans-serif; } table { border-collapse: collapse; width: 100%; } td, th { border: 1px solid #ccc; padding: 4px; }</style></head><body>${content}</body></html>`);
                    w.document.close();
                    setTimeout(() => { w.print(); w.close(); }, 500);
                } else {
                    showToast('Printing not supported for this file type', 'error');
                }
            });

            try {
                // For Viewer, we can still use Signed URL or Blob. Blob is faster.
                // Let's check cache first.
                let url;
                if (thumbnailCache.has(key)) {
                    url = thumbnailCache.get(key);
                } else {
                    url = await getShareableUrl(fragment, key);
                }

                const contentDiv = winContext.find('.viewer-content');

                if (isImage) {
                    const imgId = `img-${viewerId}`;
                    contentDiv.html(`<div class="zoom-container overflow-hidden w-full h-full relative flex items-center justify-center cursor-grab" id="container-${imgId}"><img id="${imgId}" src="${url}" class="transition-transform duration-100 ease-out max-h-full max-w-full object-contain origin-center select-none" draggable="false"></div>`);
                    setupImageZoom(winContext, imgId);
                }
                else if (isVideo) {
                    const videoId = `vid-${viewerId}`;
                    contentDiv.html(`<video id="${videoId}" src="${url}" controls autoplay class="max-h-full max-w-full" style="outline:none;"></video>`);
                    if (ext === 'm3u8' && Hls.isSupported()) {
                        const video = document.getElementById(videoId);
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
                    }
                }
                else if (isAudio) {
                    contentDiv.html(`<div class="flex flex-col items-center justify-center text-center p-10"><div class="w-32 h-32 bg-[#222] rounded-full flex items-center justify-center mb-6 shadow-xl border border-[#333]"><i class="fas fa-music text-5xl text-blue-500"></i></div><h3 class="text-xl text-white mb-6 font-light tracking-wide">${fileName}</h3><audio src="${url}" controls autoplay class="w-96"></audio></div>`);
                }
                else if (isPdf) {
                    // Native PDF
                    contentDiv.html(`<embed src="${url}" type="application/pdf" width="100%" height="100%" />`);
                }
                else if (isDocx) {
                    // Robust DOCX Handling
                    if (typeof JSZip === 'undefined') {
                        throw new Error("Critical: JSZip library missing. Please checking HTML script order.");
                    }
                    contentDiv.html('<div class="docx-wrapper bg-white w-full h-full overflow-y-auto p-8 text-black">Loading Document...</div>');
                    const resp = await fetch(url);
                    const blob = await resp.blob();
                    const container = contentDiv.find('.docx-wrapper')[0];

                    if (window.docx) {
                        contentDiv.find('.docx-wrapper').html('');
                        await window.docx.renderAsync(blob, container, null, {
                            className: "docx-viewer",
                            inWrapper: false,
                            ignoreWidth: false,
                            ignoreHeight: false
                        });
                    } else throw new Error("docx-preview library not loaded");
                }
                else if (isXlsx) {
                    // Robust Excel Handling
                    contentDiv.html('<div class="xlsx-wrapper bg-white w-full h-full overflow-auto p-0 text-black text-sm relative">Loading Spreadsheet...</div>');
                    const resp = await fetch(url);
                    const ab = await resp.arrayBuffer();

                    if (window.XLSX) {
                        const wb = XLSX.read(ab);
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const html = XLSX.utils.sheet_to_html(ws, { id: "excel-table", editable: false });

                        // Professional Excel Styling
                        const style = `<style>
                            .xlsx-wrapper { background: #f0f0f0; }
                            #excel-table { 
                                border-collapse: separate; 
                                border-spacing: 0;
                                background: white; 
                                font-family: 'Segoe UI', sans-serif; 
                                font-size: 13px;
                                border-right: 1px solid #d4d4d4;
                                border-bottom: 1px solid #d4d4d4;
                            }
                            #excel-table td, #excel-table th { 
                                border-left: 1px solid #d4d4d4;
                                border-top: 1px solid #d4d4d4;
                                padding: 4px 12px; 
                                white-space: nowrap; 
                                height: 24px;
                                color: #333;
                            }
                            #excel-table th { 
                                background: #f8f9fa; 
                                font-weight: 600; 
                                color: #444;
                                text-align: center;
                                border-bottom: 2px solid #d4d4d4;
                                position: sticky;
                                top: 0;
                                z-index: 10;
                            }
                            #excel-table tr:hover td { background-color: #f0f7ff; }
                        </style>`;
                        contentDiv.find('.xlsx-wrapper').html(style + html);
                    } else throw new Error("SheetJS library not loaded");
                }
                else {
                    contentDiv.html(`<div class="text-center text-gray-500"><i class="fas fa-file-circle-question text-5xl mb-4"></i><p>Preview not available for .${ext}</p><button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-500" onclick="performDirectDownload('${fragment}', '${key}')">Download File</button></div>`);
                }
            } catch (e) {
                console.error(e);
                let msg = e.message;
                if (msg.includes("t is undefined")) msg = "Script Order Error: JSZip must be loaded before docx-preview.";
                winContext.find('.viewer-content').html(`<div class="flex flex-col items-center justify-center h-full text-red-400"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p>Error loading preview</p><p class="text-xs text-gray-500 mt-2">${msg}</p></div>`);
            }
        }

        // --- Data Fetching & Stats ---
        let fetchController = null; // Controller to abort pending fetches

        async function listObjects(fragment, options = { render: true }) {
            if (!fragment) return;
            if (options.render) $('#browserSpinner').removeClass('hidden').addClass('flex');

            // --- RACE CONDITION FIX ---
            // If a previous fetch is running, cancel it.
            if (fetchController) fetchController.abort();
            fetchController = new AbortController();
            const signal = fetchController.signal;

            // Clear list only for fresh loads, but ensure UI reflects it immediately
            currentObjectList = [];
            
            // Reset view initially (clear old items)
            if (options.render) {
                if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList(), false);
            }

            try {
                let marker = null;
                let isFirstPage = true;

                while (true) {
                    if (signal.aborted) throw new Error("Aborted");

                    let url = `${serverLink}/v4/fragment/object/metadata/${fragment}?show_all=true&limit=100`;
                    if (marker) url += `&marker=${encodeURIComponent(marker)}`;

                    const res = await fetch(url, { 
                        headers: { authorization: `Bearer ${token}` },
                        signal: signal
                    });
                    if (!res.ok) break;

                    const page = await res.json();

                    const mappedPage = page.map(item => ({
                        ...item,
                        key: item.object_key, 
                        size_bytes: item.total_size_bytes, 
                        last_modified: { $date: { $numberLong: item.created_at * 1000 } } 
                    }));

                    if (mappedPage.length > 0) {
                        currentObjectList.push(...mappedPage);
                        marker = mappedPage[mappedPage.length - 1].key; 

                        if (options.render) {
                            updateStorageStats();
                            if ($('#nav-my-files').hasClass('active')) {
                                renderObjects(getActiveObjectList(), !isFirstPage);
                            }
                            else if ($('#nav-recent').hasClass('active')) showRecentFiles();
                            else if ($('#nav-starred').hasClass('active')) showStarredFiles();
                        }
                        isFirstPage = false;
                    }

                    if (page.length < 100) break;
                }
                
                // After full load, ensure capacity sync
                updateCapacityDisplay();

            } catch (e) {
                if (e.message !== "Aborted") console.error(e);
            } finally {
                // Only hide spinner if this is the active request
                if (options.render && !signal.aborted) $('#browserSpinner').addClass('hidden');
            }
        }

        // --- UPDATED STATS LOGIC ---
        function updateStorageStats() {
            let totalBytes = 0;
            const stats = {
                images: {
                    count: 0,
                    size: 0
                },
                videos: {
                    count: 0,
                    size: 0
                },
                audio: {
                    count: 0,
                    size: 0
                },
                docs: {
                    count: 0,
                    size: 0
                },
                archives: {
                    count: 0,
                    size: 0
                },
                others: {
                    count: 0,
                    size: 0
                }
            };

            currentObjectList.forEach(obj => {
                const size = Number(obj.size_bytes);
                totalBytes += size;
                const ext = obj.key.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff'].includes(ext)) {
                    stats.images.count++;
                    stats.images.size += size;
                } else if (['mp4', 'mkv', 'avi', 'mov', 'webm', 'm3u8'].includes(ext)) {
                    stats.videos.count++;
                    stats.videos.size += size;
                } else if (['mp3', 'wav', 'flac', 'ogg', 'm4a', 'aac'].includes(ext)) {
                    stats.audio.count++;
                    stats.audio.size += size;
                } else if (['pdf', 'doc', 'docx', 'txt', 'md', 'rtf', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) {
                    stats.docs.count++;
                    stats.docs.size += size;
                } else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                    stats.archives.count++;
                    stats.archives.size += size;
                } else {
                    stats.others.count++;
                    stats.others.size += size;
                }
            });

            // Note: Sidebar and Top stats now rely on updateCapacityDisplay() for TOTAL usage.
            // This function focuses on the BREAKDOWN (Pie Chart & Stats List).
            
            $('#stat-images').text(`${formatBytes(stats.images.size)}`);
            $('#stat-videos').text(`${formatBytes(stats.videos.size)}`);
            $('#stat-audio').text(`${formatBytes(stats.audio.size)}`);
            $('#stat-docs').text(`${formatBytes(stats.docs.size)}`);

            ResMonitor.updatePieChart(stats);
        }

        async function updateCapacityDisplay() {
            try {
                const res = await fetch(`${serverLink}/v4/capacity/usage`, {
                    headers: {
                        authorization: `Bearer ${token}`
                    }
                });
                if (res.ok) {
                    const data = await res.json();
                    const used = data.capacity_used;
                    
                    // Update UI elements with AUTHORITATIVE server data
                    const pct = Math.min(100, (used / totalCapacity) * 100);
                    
                    // Sidebar
                    $('#sidebar-gb-used').text(`${formatBytes(used)} of ${formatBytes(totalCapacity)}`);
                    $('#sidebar-storage-percent').text(`${Math.round(pct)}%`);
                    $('#sidebar-storage-bar').css('width', `${pct}%`);
                    
                    // Dashboard Top Stats
                    $('#gb-used').text(formatBytes(used));
                    $('#storage-percentage').text(Math.round(pct) + '%');
                    
                    // Dashboard Pie Chart Center
                    $('#storage-total-label').text(`${formatBytes(used)} / ${formatBytes(totalCapacity)}`);
                }
            } catch (e) {
                console.error("Failed to fetch capacity usage", e);
            }
        }

        // --- Helpers ---
        function setupImageZoom(winContext, imgId) {
            const img = document.getElementById(imgId);
            const container = document.getElementById(`container-${imgId}`);
            let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;

            const setTransform = () => {
                img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                winContext.find('.zoom-reset-btn').text(`${Math.round(scale * 100)}%`);
                container.style.cursor = scale > 1 ? (panning ? 'grabbing' : 'grab') : 'default';
            };

            winContext.find('.zoom-in-btn').click(() => { scale = Math.min(scale + 0.25, 5); setTransform(); });
            winContext.find('.zoom-out-btn').click(() => { scale = Math.max(scale - 0.25, 0.25); setTransform(); });
            winContext.find('.zoom-reset-btn').click(() => { scale = 1; pointX = 0; pointY = 0; setTransform(); });

            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = -Math.sign(e.deltaY) * 0.1;
                scale = Math.min(Math.max(0.25, scale + delta), 5);
                setTransform();
            });
            container.addEventListener('mousedown', (e) => {
                if (scale > 1) {
                    e.preventDefault();
                    startX = e.clientX - pointX;
                    startY = e.clientY - pointY;
                    panning = true;
                    container.style.cursor = 'grabbing';
                }
            });
            window.addEventListener('mouseup', () => { if (panning) { panning = false; container.style.cursor = 'grab'; } });
            window.addEventListener('mousemove', (e) => {
                if (!panning) return;
                e.preventDefault();
                pointX = e.clientX - startX;
                pointY = e.clientY - startY;
                setTransform();
            });
        }

        function getFileIconHTML(name, isList = false) {
            const ext = name.split('.').pop().toLowerCase();
            const map = {
                'pdf': ['fa-file-pdf', 'text-red-500'],
                'doc': ['fa-file-word', 'text-blue-500'],
                'docx': ['fa-file-word', 'text-blue-500'],
                'xls': ['fa-file-excel', 'text-green-500'],
                'xlsx': ['fa-file-excel', 'text-green-500'],
                'ppt': ['fa-file-powerpoint', 'text-orange-500'],
                'jpg': ['fa-file-image', 'text-purple-400'],
                'png': ['fa-file-image', 'text-purple-400'],
                'gif': ['fa-file-image', 'text-purple-400'],
                'mp4': ['fa-file-video', 'text-pink-500'],
                'mp3': ['fa-file-audio', 'text-yellow-500'],
                'wav': ['fa-file-audio', 'text-yellow-500'],
                'zip': ['fa-file-zipper', 'text-orange-500'],
                'rar': ['fa-file-zipper', 'text-orange-500']
            };
            const [icon, color] = map[ext] || ['fa-file', 'text-gray-400'];
            const cls = isList ? `far ${icon} ${color} w-6 text-center mr-3` : `far ${icon} text-5xl ${color} mb-2 drop-shadow-md`;
            return `<i class="${cls}"></i>`;
        }

        function formatBytes(bytes, decimals = 2) {
            if (!bytes) return '0 B';
            const k = 1024,
                i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i];
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds < 0) return '--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h > 0 ? h + 'h ' : ''}${m > 0 ? m + 'm ' : ''}${s}s`;
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            const color = type === 'success' ? 'border-green-500 text-green-400' : type === 'error' ? 'border-red-500 text-red-400' : 'border-blue-500 text-blue-400';
            div.className = `bg-[#222] border-l-4 ${color} text-white px-4 py-3 rounded shadow-lg flex items-center animate-[slideIn_0.3s_ease-out]`;
            div.innerHTML = `<span class="text-sm font-medium">${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
        async function getShareableUrl(fragment, key, disposition = 'view', expiresIn = 3600) {
            try {
                const res = await fetch(`${serverLink}/v4/fragment/object/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        fragment,
                        object_key: key,
                        expires_in: expiresIn,
                        disposition
                    })
                });
                
                if (!res.ok) throw new Error("Failed to generate link");
                return (await res.json()).url;
            } catch (e) {
                console.error(e);
                showToast("Failed to create share link", "error");
                return null;
            }
        }
        async function performDirectDownload(fragment, key) {
            const url = await getShareableUrl(fragment, key, 'download');
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = key.split('/').pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
        }

        // --- Context & Modals ---
        function showCtx(e, data) {
            e.preventDefault();
            e.stopPropagation();
            const menu = $('#contextMenu');
            let x = e.clientX,
                y = e.clientY;
            if (x + 200 > window.innerWidth) x -= 200;
            if (y + 200 > window.innerHeight) y -= 200;
            let html = '';

            const selectedCount = SelectionManager.selectedItems.size;

            if (data.isTrash) {
                const object = data.data;
                html = `<div class="ctx-item text-green-400" onclick="restoreFromTrash('${object.key}')"><i class="fas fa-undo w-4"></i> Restore</div><div class="ctx-div"></div><div class="ctx-item text-red-400" onclick="deletePermanently('${object.fragment}', '${object.key}', 'file')"><i class="fas fa-trash-alt w-4"></i> Delete Forever</div>`;
            } else if (selectedCount > 1 && SelectionManager.selectedItems.has(data.id)) {
                html = `
                    <div class="ctx-item bg-[#333] cursor-default font-bold text-gray-400 border-b border-[#444] mb-1">${selectedCount} Items Selected</div>
                    <div class="ctx-item" onclick="batchDownload()"><i class="fas fa-download w-4"></i> Download All</div>
                    <div class="ctx-item text-red-400" onclick="batchDelete()"><i class="fas fa-trash w-4"></i> Delete All</div>
                    `;
            } else if (data.type === 'file') {
                const isStarred = starredItems.includes(data.data.key);
                html = `<div class="ctx-item" onclick="openFileViewer('${data.data.fragment}','${data.data.key}')"><i class="fas fa-eye w-4"></i> Open</div><div class="ctx-div"></div><div class="ctx-item" onclick="showShareModal('${data.data.fragment}','${data.data.key}')"><i class="fas fa-share-alt w-4"></i> Share</div><div class="ctx-item" onclick="showRenameModal('${data.data.fragment}','${data.data.key}')"><i class="fas fa-pen w-4"></i> Rename</div><div class="ctx-item" onclick="performDirectDownload('${data.data.fragment}','${data.data.key}')"><i class="fas fa-download w-4"></i> Download</div><div class="ctx-item" onclick="toggleStar('${data.data.key}')"><i class="${isStarred ? 'fas' : 'far'} fa-star w-4 text-yellow-500"></i> ${isStarred ? 'Unfavorite' : 'Favorite'}</div><div class="ctx-div"></div><div class="ctx-item text-red-400" onclick="moveToTrash('${data.data.key}','file')"><i class="fas fa-trash w-4"></i> Delete</div>`;
            } else {
                // BUG FIX: data.data is the string name for folders, not an object with a .name property
                const folderName = data.data;
                html = `<div class="ctx-item" onclick="navigateTo('${currentPath + folderName}/')"><i class="fas fa-folder-open w-4"></i> Open</div><div class="ctx-div"></div><div class="ctx-item text-red-400" onclick="moveToTrash('${currentPath + folderName}/','folder')"><i class="fas fa-trash w-4"></i> Delete Folder</div>`;
            }
            menu.html(html).css({
                top: y,
                left: x
            }).removeClass('hidden');
        }

        // --- Batch Actions ---
        function batchDelete() {
            const items = SelectionManager.getSelection();
            showGenericModal('Batch Delete', `Are you sure you want to delete ${items.length} items?`, () => {
                items.forEach(item => {
                    if (item.type === 'file') moveToTrash(item.key, 'file');
                    else if (item.type === 'folder') moveToTrash(currentPath + item.key + '/', 'folder');
                });
                SelectionManager.clear();
            });
            $('#contextMenu').addClass('hidden');
        }

        function batchDownload() {
            const items = SelectionManager.getSelection();
            if (items.length > 5) {
                if (!confirm(`You are about to download ${items.length} files. Continue?`)) return;
            }
            let delay = 0;
            items.forEach(item => {
                if (item.type === 'file') {
                    // Stagger downloads to prevent browser blocking
                    setTimeout(() => {
                        // Find fragment from current list (Selection doesn't store fragment, need lookup)
                        const obj = currentObjectList.find(o => o.key === item.key);
                        if (obj) performDirectDownload(obj.fragment, item.key);
                    }, delay);
                    delay += 500;
                }
            });
            $('#contextMenu').addClass('hidden');
        }


        function showGenericModal(title, content, onConfirm) {
            $('#modalTitle').text(title);
            $('#modalContent').text(content);
            $('#genericModal').removeClass('hidden').addClass('flex');
            $('#modalConfirm').off().click(() => {
                onConfirm();
                $('#genericModal').addClass('hidden').removeClass('flex');
            });
            $('#modalCancel').off().click(() => $('#genericModal').addClass('hidden').removeClass('flex'));
        }

        function showRenameModal(fragment, key) {
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('newObjectKeyInput');
            input.value = key;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('confirmRenameBtn').onclick = async () => {
                const newKey = input.value.trim();
                if (!newKey || newKey === key) return;
                try {
                    const response = await fetch(`${serverLink}/v4/fragment/object/rename`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            source_fragment: fragment,
                            source_key: key,
                            destination_fragment: fragment,
                            destination_key: newKey
                        })
                    });
                    if (!response.ok) throw new Error();
                    showToast('Object renamed successfully.', 'success');
                    listObjects(fragment);
                } catch (err) {
                    showToast('Failed to rename object.', 'error');
                } finally {
                    modal.classList.add('hidden');
                }
            };
            document.getElementById('cancelRenameBtn').onclick = () => modal.classList.add('hidden');
        }

        function showShareModal(fragment, key) {
            const modal = document.getElementById('shareModal');
            const urlInput = document.getElementById('shareUrl');
            urlInput.value = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('generateShareBtn').onclick = async () => {
                const disposition = document.getElementById('shareDisposition').value;
                const expires_in = parseInt(document.getElementById('shareExpiry').value, 10) || 3600;
                try {
                    const url = await getShareableUrl(fragment, key, disposition, expires_in);
                    if (url) urlInput.value = url;
                } catch (err) {
                    // Toast handled in getShareableUrl
                }
            };
            document.getElementById('copyShareUrlBtn').onclick = () => {
                if (urlInput.value) {
                    navigator.clipboard.writeText(urlInput.value);
                    showToast('URL copied!', 'success');
                }
            };
            document.getElementById('closeShareBtn').onclick = () => modal.classList.add('hidden');
        }

        // --- Trash & Actions ---
        function moveToTrash(key, type) {
            $('#contextMenu').addClass('hidden');
            let items = type === 'folder' ? currentObjectList.filter(o => o.key.startsWith(key)) : [currentObjectList.find(o => o.key === key)].filter(Boolean);
            if (type === 'folder') clientSideFolders = clientSideFolders.filter(f => (f.path || '') + f.name + '/' !== key);
            items.forEach(i => {
                if (!trashedItems.some(t => t.key === i.key)) trashedItems.push({
                    ...i,
                    trashedDate: new Date().toISOString()
                });
            });
            localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
            renderObjects(getActiveObjectList());
            if ($('#win-recycle-bin').is(':visible')) showTrash();
        }
        async function emptyTrash() {
            if (trashedItems.length === 0) return;

            showGenericModal('Empty Recycle Bin', `Permanently delete ${trashedItems.length} items? This cannot be undone.`, async () => {
                const total = trashedItems.length;
                showProgressModal('Emptying Recycle Bin', total);

                let count = 0;
                // Create a copy to iterate safely
                const itemsToDelete = [...trashedItems];

                for (const item of itemsToDelete) {
                    count++;
                    updateProgress(count, total, `Deleting ${item.key.split('/').pop()}...`);

                    try {
                        await fetch(`${serverLink}/v4/fragment/object/delete/${item.fragment}/${item.key}`, {
                            method: 'DELETE',
                            headers: {
                                authorization: `Bearer ${token}`
                            }
                        });
                    } catch (e) {
                        console.error("Failed to delete", item.key);
                    }
                }

                trashedItems = [];
                localStorage.setItem('trashedItems', '[]');
                showTrash();
                hideProgressModal();
                showToast('Recycle Bin emptied.', 'success');
                // Ensure capacity is updated after bulk delete
                updateCapacityDisplay();
            });
        }

        function restoreAll() {
            if (trashedItems.length === 0) return;

            showGenericModal('Restore All', `Restore all ${trashedItems.length} items to their original locations?`, () => {
                const total = trashedItems.length;
                showProgressModal('Restoring Files', total);

                // Simulate a small delay for UI feel since local operations are instant
                setTimeout(() => {
                    trashedItems = [];
                    localStorage.setItem('trashedItems', '[]');

                    updateProgress(total, total, 'Finalizing...');

                    setTimeout(() => {
                        hideProgressModal();
                        showTrash();
                        // Refresh the file view if we are looking at files
                        if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
                        showToast('All items restored.', 'success');
                    }, 500);
                }, 500);
            });
        }
        async function deletePermanently(fragment, key, type) {
            $('#contextMenu').addClass('hidden');
            showGenericModal('Delete Permanently', 'Cannot be undone. Sure?', async () => {
                try {
                    await fetch(`${serverLink}/v4/fragment/object/delete/${fragment}/${key}`, {
                        method: 'DELETE',
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    trashedItems = trashedItems.filter(t => t.key !== key);
                    localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
                    showTrash();
                    showToast('File deleted.', 'success');
                    updateCapacityDisplay();
                } catch (e) {
                    showToast('Failed.', 'error');
                }
            });
        }

        function restoreFromTrash(key) {
            $('#contextMenu').addClass('hidden');
            trashedItems = trashedItems.filter(t => t.key !== key);
            localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
            showTrash();
            showToast('File restored.', 'success');
            if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
        }

        function showProgressModal(title, total) {
            $('#progressTitle').text(title);
            $('#progressModal').removeClass('hidden').addClass('flex');
            updateProgress(0, total, 'Starting...');
        }

        function updateProgress(current, total, status) {
            const pct = Math.round((current / total) * 100);
            $('#progressBar').css('width', `${pct}%`);
            $('#progressCount').text(`${current}/${total}`);
            $('#progressStatus').text(status);
        }

        function hideProgressModal() {
            $('#progressModal').addClass('hidden').removeClass('flex');
        }

        function showTrash() {
            const container = document.getElementById('recycle-bin-content');
            const header = document.getElementById('trash-list-header');
            container.innerHTML = '';
            if (currentTrashView === 'tiles') {
                container.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 custom-scrollbar flex-1 overflow-y-auto content-start';
                if (header) header.classList.add('hidden');
            } else {
                container.className = 'flex flex-col gap-0 custom-scrollbar flex-1 overflow-y-auto';
                if (header) header.classList.remove('hidden');
            }
            if (trashedItems.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-500 flex flex-col items-center justify-center h-full"><i class="fas fa-trash-can text-5xl mb-4 opacity-30"></i><p>Recycle Bin is empty</p></div>`;
                return;
            }
            trashedItems.forEach(item => {
                const name = item.key.split('/').pop();
                const date = new Date(item.trashedDate).toLocaleDateString();
                if (currentTrashView === 'tiles') {
                    const div = document.createElement('div');
                    div.className = 'file-item p-3 flex flex-col items-center group relative border border-transparent rounded hover:bg-[#2a2a2a] transition-all h-max';
                    div.innerHTML = `${getFileIconHTML(name)}<span class="text-xs text-center truncate w-full text-gray-300 group-hover:text-white mt-1">${name}</span><div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 rounded"><button class="w-8 h-8 flex items-center justify-center rounded-full bg-green-600 text-white hover:bg-green-500 shadow-lg transform hover:scale-110 transition-transform" onclick="event.stopPropagation(); restoreFromTrash('${item.key}')"><i class="fas fa-undo text-xs"></i></button><button class="w-8 h-8 flex items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-500 shadow-lg transform hover:scale-110 transition-transform" onclick="event.stopPropagation(); deletePermanently('${item.fragment}', '${item.key}', 'file')"><i class="fas fa-times text-xs"></i></button></div>`;
                    div.oncontextmenu = (e) => showCtx(e, {
                        isTrash: true,
                        data: item
                    });
                    container.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-[1fr_150px_100px] gap-2 px-4 py-2 hover:bg-[#2a2a2a] border-b border-[#333] group items-center text-xs text-gray-300 transition-colors';
                    div.innerHTML = `<div class="flex items-center gap-3 truncate">${getFileIconHTML(name, true)}<span class="truncate">${name}</span></div><div class="text-gray-500">${date}</div><div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button class="text-green-500 hover:text-white" onclick="event.stopPropagation(); restoreFromTrash('${item.key}')"><i class="fas fa-undo"></i></button><button class="text-red-500 hover:text-white" onclick="event.stopPropagation(); deletePermanently('${item.fragment}', '${item.key}', 'file')"><i class="fas fa-times"></i></button></div>`;
                    div.oncontextmenu = (e) => showCtx(e, {
                        isTrash: true,
                        data: item
                    });
                    container.appendChild(div);
                }
            });
        }

        function toggleStar(key) {
            if (starredItems.includes(key)) starredItems = starredItems.filter(k => k !== key);
            else starredItems.push(key);
            localStorage.setItem('starredItems', JSON.stringify(starredItems));
            showToast(starredItems.includes(key) ? 'Added to Favorites' : 'Removed from Favorites', 'success');
            if ($('#nav-starred').hasClass('active')) showStarredFiles();
            else if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
        }

        // --- Uploads ---
        async function processZipUpload(files) {
            if (!files || files.length === 0) return;

            if (typeof JSZip === 'undefined') {
                showToast('JSZip library missing', 'error');
                return;
            }

            const zip = new JSZip();

            const pathInfo = files[0].entryPath || files[0].webkitRelativePath || '';
            const rootFolderName = pathInfo.split('/')[0] || 'folder_archive';

            showToast('Compressing folder...', 'info');
            showProgressModal('Compressing Folder', files.length);

            let processed = 0;

            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    processed++;
                    updateProgress(processed, files.length, `Zipping ${file.name}...`);

                    const filePath = file.entryPath || file.webkitRelativePath || file.name;
                    zip.file(filePath, file);
                }
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    if (metadata.percent < 100) {
                        $('#progressBar').css('width', `${metadata.percent}%`);
                        $('#progressStatus').text(`Compressing: ${metadata.percent.toFixed(0)}%`);
                    }
                });

                const zipFile = new File([content], `${rootFolderName}.zip`, { type: "application/zip" });

                hideProgressModal();
                showToast('Folder compressed! Added to queue.', 'success');

                handleUploads([zipFile]);

            } catch (e) {
                console.error(e);
                hideProgressModal();
                showToast('Failed to zip folder', 'error');
            }
        }

        async function scanFiles(item, path = '') {
            if (item.isFile) {
                return new Promise(resolve => {
                    item.file(file => {
                        // Attach the full path for the zipper to use
                        file.entryPath = path + file.name;
                        resolve([file]);
                    });
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                let entries = [];

                // readEntries must be called repeatedly until empty
                const readEntries = async () => {
                    const result = await new Promise(resolve => dirReader.readEntries(resolve));
                    if (result.length === 0) return entries;
                    entries = entries.concat(result);
                    return readEntries();
                };

                const allEntries = await readEntries();
                const files = [];
                for (const entry of allEntries) {
                    files.push(...await scanFiles(entry, path + item.name + '/'));
                }
                return files;
            }
            return [];
        }

        async function handleUploads(files) {
            if (!files.length) return;
            WindowManager.open('uploads');
            Array.from(files).forEach(f => {
                const item = {
                    id: crypto.randomUUID(),
                    file: f,
                    fragment: activeFragment,
                    objectKey: currentPath + (f.webkitRelativePath || f.name),
                    controller: new AbortController()
                };
                uploadQueue.push(item);
                createUploadUI(item);
            });
            processUploadQueue();
        }

        function createUploadUI(item, append = false) {
            const container = document.getElementById('upload-items-container');
            const el = document.createElement('div');
            el.id = item.id || `upload-${crypto.randomUUID()}`;
            el.className = 'bg-[#191919] p-2 rounded border border-[#333] mb-1';
            let progressBar = `<div class="w-full bg-[#333] h-1 rounded-full overflow-hidden mb-1"><div class="progress-bar bg-blue-600 h-full w-0 transition-all"></div></div>`;
            let actions = item.isRecovery ? `<div class="flex gap-2 mt-1"><button class="text-[10px] bg-green-600 hover:bg-green-500 text-white px-2 py-0.5 rounded resume-btn">Resume</button><button class="text-[10px] bg-red-600 hover:bg-red-500 text-white px-2 py-0.5 rounded cancel-btn">Cancel</button></div>` : '';
            el.innerHTML = `<div class="flex justify-between mb-1 text-[10px]"><span class="font-medium text-gray-300 truncate w-24">${item.file.name}</span><span class="${item.isRecovery ? 'text-yellow-500' : 'text-gray-400'} status-text"><i class="far fa-clock mr-1"></i>${item.isRecovery ? 'Interrupted' : 'Pending'}</span></div>${item.isRecovery ? '' : progressBar}<div class="flex justify-end text-[9px] text-gray-500 details-text">${item.isRecovery ? '<span>Waiting...</span>' : '<span>-- MB/s</span><span>--</span>'}</div>${actions}`;
            if (item.isRecovery) {
                el.querySelector('.resume-btn').onclick = () => {
                    const inp = document.getElementById('resumeFileInput');
                    inp.dataset.uiId = item.id;
                    inp.dataset.sessionKey = item.sessionKey;
                    inp.click();
                };
                el.querySelector('.cancel-btn').onclick = () => {
                    localStorage.removeItem(item.sessionKey);
                    el.remove();
                };
            }
            append ? container.appendChild(el) : container.prepend(el);
        }

        let isProcessingQueue = false;
        async function processUploadQueue() {
            if (isProcessingQueue) return;
            isProcessingQueue = true;
            try {
                while (activeUploads < MAX_CONCURRENT_UPLOADS) {
                    const next = uploadQueue.find(i => !i.started && !i.completed && !i.failed);
                    if (!next) break;
                    activeUploads++;
                    next.started = true;

                    // UPDATED: Start upload
                    startUpload(next).finally(() => {
                        activeUploads--;
                        // We do not reset global speed here anymore.
                        processUploadQueue();
                    });

                    // Reduced throttling: 500ms -> 100ms
                    await new Promise(r => setTimeout(r, 100));
                }
            } finally {
                isProcessingQueue = false;
            }
        }
        async function startUpload(item) {
            let ui = document.getElementById(item.id);
            if (!ui) return;
            const statusText = ui.querySelector('.status-text');
            const progBar = ui.querySelector('.progress-bar');
            const detailsText = ui.querySelector('.details-text');

            const currentUsage = currentObjectList.reduce((acc, obj) => acc + Number(obj.size_bytes), 0);
            if (currentUsage + item.file.size > totalCapacity) {
                statusText.textContent = "Storage Full";
                statusText.className = "text-red-400 text-[10px]";
                detailsText.innerHTML = `<span class="text-red-400">Not enough space</span>`;
                item.failed = true;
                showToast(`Not enough storage to upload ${item.file.name}`, 'error');
                return;
            }

            const sessionKey = `upload-session-${item.file.name}-${item.file.size}-${item.file.lastModified}`;
            item.sessionKey = sessionKey; // Explicitly attach for tracking

            let uploadedBytes = 0,
                lastUploadedBytes = 0,
                lastUpdate = Date.now();

            // Initialize speed tracking for this item
            item.currentSpeed = 0;

            try {
                const fileSize = item.file.size;
                const chunkSize = fileSize < 100 * MB ? 2 * MB : fileSize < 500 * MB ? 5 * MB : fileSize < 1024 * MB ? 8 * MB : 16 * MB;
                const totalChunks = Math.ceil(fileSize / chunkSize);
                let version_id, session_id, chunkQueue = Array.from({
                    length: totalChunks
                }, (_, i) => i);

                const existing = localStorage.getItem(sessionKey);
                if (existing) {
                    const sess = JSON.parse(existing);
                    statusText.textContent = "Resuming...";
                    const statusRes = await fetch(`${serverLink}/v4/fragment/object/upload/status/${sess.fragment}/${sess.version_id}?object_key=${encodeURIComponent(sess.objectKey)}`, {
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    if (statusRes.ok) {
                        const s = await statusRes.json();
                        version_id = sess.version_id;
                        session_id = sess.session_id;
                        const done = new Set(s.uploaded_parts); // Corrected property name from backend 'uploaded_parts'
                        chunkQueue = chunkQueue.filter(i => !done.has(i));
                        uploadedBytes = done.size * chunkSize;
                        if (uploadedBytes > fileSize) uploadedBytes = fileSize;
                        lastUploadedBytes = uploadedBytes;
                    } else {
                        localStorage.removeItem(sessionKey);
                    }
                }

                if (!version_id) {
                    statusText.textContent = "Initializing...";
                    const init = await fetch(`${serverLink}/v4/fragment/object/upload/init/${item.fragment}/${item.objectKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            content_type: item.file.type || 'application/octet-stream',
                            total_size_bytes: fileSize
                        })
                    });
                    if (!init.ok) throw new Error();
                    const res = await init.json();
                    version_id = res.version_id;
                    session_id = res.session_id;
                    
                    localStorage.setItem(sessionKey, JSON.stringify({
                        version_id,
                        session_id,
                        name: item.file.name,
                        size: fileSize,
                        lastModified: item.file.lastModified,
                        objectKey: item.objectKey,
                        fragment: item.fragment
                    }));
                }

                statusText.textContent = "Uploading...";
                const buffer = [],
                    // Optimization: Increased buffer size to prevent starvation
                    maxBuffer = 10,
                    // Optimization: 32 workers to saturate HTTP/2 multiplexing
                    maxWorkers = 32;

                let hashingDone = false;

                const producer = async () => {
                    for (const idx of chunkQueue) {
                        while (buffer.length >= maxBuffer) await new Promise(r => setTimeout(r, 50));
                        const blob = item.file.slice(idx * chunkSize, Math.min((idx + 1) * chunkSize, fileSize));
                        // Backend calculates hash, client side hashing is good for verification but not mandatory if using HTTPS and TCP checksums
                        // But let's keep it if we want to add headers later.
                        // For now the backend doesn't require Digest header in your provided code
                        
                        buffer.push({
                            index: idx,
                            blob
                        });
                    }
                    hashingDone = true;
                };
                const worker = async () => {
                    while (true) {
                        const chunk = buffer.shift();
                        if (!chunk) {
                            if (hashingDone) break;
                            await new Promise(r => setTimeout(r, 20));
                            continue;
                        }
                        try {
                            // NEW API: PUT /v4/fragment/object/upload/chunk/{fragment}/{version_id}/{part_index}?object_key={key}
                            const res = await fetch(`${serverLink}/v4/fragment/object/upload/chunk/${item.fragment}/${version_id}/${chunk.index}?object_key=${encodeURIComponent(item.objectKey)}&buffer_size=${chunkSize}`, {
                                method: 'PUT',
                                headers: {
                                    authorization: `Bearer ${token}`,
                                    'Content-Type': 'application/octet-stream'
                                },
                                body: chunk.blob,
                                signal: item.controller.signal
                            });

                            if (!res.ok) {
                                throw new Error(`Server returned status ${res.status}`);
                            }

                            uploadedBytes += chunk.blob.size;
                            const now = Date.now();
                            if (now - lastUpdate > 500) {
                                const speed = (uploadedBytes - lastUploadedBytes) / ((now - lastUpdate) / 1000);

                                // Store speed on item instead of global
                                item.currentSpeed = speed;

                                const eta = speed > 0 ? (fileSize - uploadedBytes) / speed : 0;
                                progBar.style.width = `${Math.min(100, (uploadedBytes / fileSize) * 100)}%`;
                                statusText.textContent = `${Math.round((uploadedBytes / fileSize) * 100)}%`;
                                detailsText.innerHTML = `<span class="mr-2">${formatBytes(speed)}/s</span><span>ETA: ${formatTime(eta)}</span>`;
                                lastUpdate = now;
                                lastUploadedBytes = uploadedBytes;
                            }
                        } catch (e) {
                            // Rate limit handling (Retry)
                            buffer.unshift(chunk);
                            // Add slight jitter to prevent thundering herd
                            const jitter = Math.random() * 500;
                            await new Promise(r => setTimeout(r, 1000 + jitter));
                        }
                    }
                };

                await new Promise((resolve, reject) => {
                    producer().catch(reject);
                    const workers = [];
                    for (let i = 0; i < maxWorkers; i++) workers.push(worker());
                    Promise.all(workers).then(resolve).catch(reject);
                });

                statusText.textContent = "Finalizing...";
                // NEW API: POST /v4/fragment/object/upload/finalize/{fragment}/{version_id}/{session_id}?object_key={key}
                // BODY: JSON { content_type, total_size_bytes }
                await fetch(`${serverLink}/v4/fragment/object/upload/finalize/${item.fragment}/${version_id}/${session_id}?object_key=${encodeURIComponent(item.objectKey)}`, {
                    method: 'POST',
                    headers: {
                        authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content_type: item.file.type || 'application/octet-stream',
                        total_size_bytes: fileSize
                    })
                });
                statusText.textContent = "Complete";
                statusText.className = "text-green-400 text-[10px]";
                progBar.classList.replace('bg-blue-600', 'bg-green-500');
                progBar.style.width = '100%';
                item.completed = true;
                item.currentSpeed = 0; // Reset speed on completion
                localStorage.removeItem(sessionKey);
                listObjects(activeFragment);
                updateCapacityDisplay(); // Update capacity after successful upload

            } catch (e) {
                console.error(e);
                statusText.textContent = "Failed";
                statusText.className = "text-red-400 text-[10px]";
                item.failed = true;
                item.currentSpeed = 0; // Reset speed on failure
                detailsText.innerHTML = `<button class="text-blue-400 mr-2" onclick="retryUpload('${item.id}')">Retry</button><button class="text-red-400" onclick="cancelUpload('${item.id}')">Cancel</button>`;
            }
        }
        window.retryUpload = (id) => {
            const item = uploadQueue.find(u => u.id === id);
            if (item) {
                item.failed = false;
                item.started = false;
                const ui = document.getElementById(id);
                ui.querySelector('.status-text').className = "text-blue-400 status-text";
                ui.querySelector('.status-text').textContent = "Retrying...";
                processUploadQueue();
            }
        };
        window.cancelUpload = (id) => {
            const item = uploadQueue.find(u => u.id === id);
            if (item) {
                item.controller.abort();
                localStorage.removeItem(`upload-session-${item.file.name}-${item.file.size}-${item.file.lastModified}`);
                uploadQueue = uploadQueue.filter(u => u.id !== id);
                document.getElementById(id).remove();
                activeUploads--;
                processUploadQueue();
            }
        };

        function checkForInterruptedUploads() {
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith('upload-session-')) {
                    const d = JSON.parse(localStorage.getItem(k));

                    // Generate ID deterministically
                    const elId = `recovery-${k.replace(/[^a-zA-Z0-9]/g, '')}`;

                    // CHECK: Ensure item is not already in queue (being uploaded) AND UI element doesn't already exist
                    if (!uploadQueue.some(u => u.sessionKey === k) && !document.getElementById(elId)) {
                        createUploadUI({
                            id: elId,
                            sessionKey: k,
                            file: {
                                name: d.name,
                                size: d.size
                            },
                            isRecovery: true,
                            status: 'interrupted',
                            objectKey: d.objectKey
                        }, true);
                    }
                }
            }
            if (document.querySelectorAll('#upload-items-container > div').length > 0) WindowManager.addTaskbarItem('uploads');
        }

        // --- Init ---
        $(document).ready(() => {
            VirtualScroller.init('browser', 'objectList');
            
            // Start Menu User
            $('#start-menu-username').text(userName);

            // Drag Drop
            const dz = document.getElementById('browser');
            let dc = 0;

            dz.addEventListener('dragover', (e) => e.preventDefault());
            dz.addEventListener('dragenter', (e) => {
                dc++;
                dz.classList.add('bg-[#252525]');
            });
            dz.addEventListener('dragleave', (e) => {
                dc--;
                if (dc === 0) dz.classList.remove('bg-[#252525]');
            });

            dz.addEventListener('drop', async (e) => {
                e.preventDefault();
                dc = 0;
                dz.classList.remove('bg-[#252525]');

                const items = e.dataTransfer.items;
                const files = [];
                let hasFolder = false;

                if (items) {
                    for (let i = 0; i < items.length; i++) {
                        const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                        if (entry) {
                            if (entry.isDirectory) hasFolder = true;
                            files.push(...await scanFiles(entry));
                        } else {
                            // Fallback for items that aren't entries
                            const f = items[i].getAsFile();
                            if (f) files.push(f);
                        }
                    }
                } else {
                    // Fallback for older browsers
                    files.push(...e.dataTransfer.files);
                }

                if (files.length > 0) {
                    if (hasFolder) {
                        // If we detected a folder, ZIP IT
                        processZipUpload(files);
                    } else {
                        // Otherwise, normal upload
                        handleUploads(files);
                    }
                }
            });

            // --- Paste Handler (Standard) ---
            $(document).on('paste', (e) => {
                const cd = e.originalEvent.clipboardData;
                if (!cd) return;

                const files = [];
                const uniqueFiles = new Set();
                let potentialFolders = 0;

                const addFile = (f) => {
                    if (!uniqueFiles.has(f.name + f.size)) {
                        files.push(f);
                        uniqueFiles.add(f.name + f.size);
                    }
                };
                if (cd.items) {
                    for (let i = 0; i < cd.items.length; i++) {
                        const item = cd.items[i];
                        if (item.kind !== 'file') continue;

                        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                        if (entry && entry.isDirectory) {
                            potentialFolders++;
                            continue;
                        }

                        const f = item.getAsFile();
                        if (f) {
                            if (f.size === 0) {
                                potentialFolders++;
                            } else {
                                addFile(f);
                            }
                        }
                    }
                }
                // 2. Fallback Method: 'files' list (older browsers)
                else if (cd.files) {
                    for (let i = 0; i < cd.files.length; i++) {
                        const f = cd.files[i];
                        if (f.size === 0) potentialFolders++;
                        else addFile(f);
                    }
                }

                if ($('#win-file-explorer').is(':visible')) {
                    if (files.length > 0) {
                        e.preventDefault();
                        handleUploads(files);
                    }

                    // Show error if we detected folders (and nothing valid was pasted)
                    if (potentialFolders > 0 && files.length === 0) {
                        showToast('Cannot paste folders. Please use Drag & Drop to zip/upload folders.', 'error');
                    }
                }
            });
            $(".window").draggable({
                handle: ".window-header",
                containment: "#windows-container",
                start: function () {
                    WindowManager.focus($(this).attr('id').replace('win-', ''));
                }
            }).resizable({
                minHeight: 200,
                minWidth: 300
            });
            $(".window").on('mousedown', function () {
                WindowManager.focus($(this).attr('id').replace('win-', ''));
            });
            $(document).on('click', (e) => {
                if (!$(e.target).closest('#contextMenu').length) $('#contextMenu').addClass('hidden');
                
                // Close start menu if clicked outside
                if (!$(e.target).closest('#start-menu').length && !$(e.target).closest('#start-btn').length) {
                    StartMenu.close();
                }
            });
            $('#folderInput').off('change');
            $('#browser').off('contextmenu');

            $('#folderInput').change((e) => {
                processZipUpload(e.target.files);
                e.target.value = ''; // Reset input
            });

            $('#browser').on('contextmenu', (e) => {
                if ($(e.target).closest('.file-item').length) return;

                e.preventDefault();
                e.stopPropagation();

                const menu = $('#contextMenu');
                let x = e.clientX,
                    y = e.clientY;

                if (x + 200 > window.innerWidth) x -= 200;
                if (y + 200 > window.innerHeight) y -= 200;

                const html = `
                    <div class="ctx-item" onclick="document.getElementById('newFolderBtnAction').click()"><i class="fas fa-folder-plus w-4 text-yellow-500"></i> New Folder</div>
                    <div class="ctx-div"></div>
                    <div class="ctx-item" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload w-4"></i> Upload File</div>
                    <div class="ctx-item" onclick="document.getElementById('folderInput').click()"><i class="fas fa-file-zipper w-4"></i> Upload Folder as Zip</div>
                    <div class="ctx-div"></div>
                    <div class="ctx-item" onclick="listObjects(activeFragment)"><i class="fas fa-sync-alt w-4"></i> Refresh</div>
                `;

                menu.html(html).css({
                    top: y,
                    left: x
                }).removeClass('hidden');
            });

            // Clear selection when clicking on empty space
            $('#browser').on('click', (e) => {
                if (e.target === e.currentTarget || e.target.id === 'objectList') {
                    SelectionManager.clear();
                }
            });

            // Selection Box (Marquee)
            const marquee = document.getElementById('selection-marquee');
            let isSelecting = false,
                startX, startY;

            $('#browser').on('mousedown', (e) => {
                if (e.target !== e.currentTarget && e.target.id !== 'objectList') return;
                if (e.which !== 1) return; // Only left click
                isSelecting = true;
                startX = e.pageX;
                startY = e.pageY;
                marquee.style.left = startX + 'px';
                marquee.style.top = startY + 'px';
                marquee.style.width = '0px';
                marquee.style.height = '0px';
                marquee.style.display = 'block';
                SelectionManager.clear();
            });

            $(document).on('mousemove', (e) => {
                if (!isSelecting) return;
                const currentX = e.pageX;
                const currentY = e.pageY;
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                const left = Math.min(currentX, startX);
                const top = Math.min(currentY, startY);
                marquee.style.width = width + 'px';
                marquee.style.height = height + 'px';
                marquee.style.left = left + 'px';
                marquee.style.top = top + 'px';

                // Hit Test
                const items = document.querySelectorAll('.file-item');
                const mRect = marquee.getBoundingClientRect();

                items.forEach(item => {
                    const iRect = item.getBoundingClientRect();
                    if (mRect.left < iRect.right && mRect.right > iRect.left && mRect.top < iRect.bottom && mRect.bottom > iRect.top) {
                        if (!SelectionManager.selectedItems.has(item.dataset.id)) SelectionManager.toggle(item.dataset.id);
                    }
                });
            });

            $(document).on('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    marquee.style.display = 'none';
                }
            });


            setTimeout(() => {
                $('#boot-screen').css('opacity', 0);
                setTimeout(() => $('#boot-screen').remove(), 600);
            }, 1200);
            $('#fileInput').change((e) => handleUploads(e.target.files));
            $('#searchInput').on('input', function () {
                const v = $(this).val().toLowerCase();
                if (!v) {
                    renderObjects(getActiveObjectList());
                    return;
                }
                $('#breadcrumb').html('<span class="text-blue-400">Search Results</span>');
                const flat = getActiveObjectList().filter(o => o.key.toLowerCase().includes(v));
                VirtualScroller.setItems(flat.map(i => ({
                    type: 'file',
                    data: i,
                    id: `file:${i.key}`
                })), 'list');
            });

            $('#resumeFileInput').change((e) => {
                const f = e.target.files[0],
                    sKey = e.target.dataset.sessionKey,
                    uiId = e.target.dataset.uiId;
                if (f && sKey) {
                    const d = JSON.parse(localStorage.getItem(sKey));
                    if (f.name === d.name && f.size === d.size && f.lastModified === d.lastModified) {
                        document.getElementById(uiId).remove();
                        const item = {
                            id: crypto.randomUUID(),
                            file: f,
                            fragment: d.fragment,
                            objectKey: d.objectKey,
                            controller: new AbortController(),
                            sessionKey: sKey // Ensure sessionKey is tracked
                        };
                        uploadQueue.push(item);
                        createUploadUI(item);
                        processUploadQueue();
                        showToast(`Resuming ${f.name}`, 'success');
                    } else showToast('Incorrect file.', 'error');
                }
                e.target.value = '';
            });

            $('#empty-trash-btn').click(emptyTrash);
            $('#restore-all-btn').click(restoreAll);
            $('#trash-tiles-btn').click(function () {
                currentTrashView = 'tiles';
                showTrash();
            });
            $('#trash-list-btn').click(function () {
                currentTrashView = 'list';
                showTrash();
            });
            $('#tiles-view-btn').click(function () {
                currentView = 'tiles';
                renderObjects(getActiveObjectList());
            });
            $('#list-view-btn').click(function () {
                currentView = 'list';
                renderObjects(getActiveObjectList());
            });

            async function loadFragments() {
                const list = $('#fragmentList').empty();
                try {
                    const res = await fetch(`${serverLink}/v4/fragment/metadata`, {
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    if (res.ok) (await res.json()).forEach(pushFrag);
                } catch (e) { }
                clientSideFragments.forEach(pushFrag);

                function pushFrag(f) {
                    if (document.getElementById(`frag-${f}`)) return;
                    const el = $(`<div id="frag-${f}" class="nav-item fragment-item text-[11px]"><i class="fas fa-hard-drive text-gray-400"></i> ${f}</div>`).click(function () {
                        $('#fragmentList .fragment-item').removeClass('active');
                        $(this).addClass('active');
                        activeFragment = f;
                        currentPath = '';
                        AppNav.navigate('my-files');
                        listObjects(f);
                    });
                    if (activeFragment === f) el.addClass('active');
                    list.append(el);
                }
                if (!activeFragment && list.children().length) list.children().first().click();
                else if (activeFragment) listObjects(activeFragment);
            }
            loadFragments();
            checkForInterruptedUploads();

            // Folder & Fragment Modals
            $('#newFolderBtnAction').click(() => {
                $('#newFolderNameInput').val('');
                $('#newFolderModal').removeClass('hidden').addClass('flex');
                setTimeout(() => $('#newFolderNameInput').focus(), 50);
            });
            $('#cancelNewFolderBtn').click(() => $('#newFolderModal').addClass('hidden').removeClass('flex'));
            $('#confirmNewFolderBtn').click(() => {
                const n = $('#newFolderNameInput').val().trim();
                if (n) {
                    clientSideFolders.push({
                        name: n,
                        path: currentPath,
                        fragment: activeFragment
                    });
                    $('#newFolderModal').addClass('hidden').removeClass('flex');
                    renderObjects(getActiveObjectList());
                    showToast('Folder created', 'success');
                }
            });

            $('#addFragmentBtn').click(() => {
                $('#newFragmentNameInput').val('');
                $('#newFragmentModal').removeClass('hidden').addClass('flex');
                setTimeout(() => $('#newFragmentNameInput').focus(), 50);
            });
            $('#cancelNewFragmentBtn').click(() => $('#newFragmentModal').addClass('hidden').removeClass('flex'));
            $('#confirmNewFragmentBtn').click(() => {
                const n = $('#newFragmentNameInput').val().trim();
                if (n && !clientSideFragments.includes(n)) {
                    clientSideFragments.push(n);
                    showToast(`Mount '${n}' created`, 'success');
                    loadFragments();
                }
                $('#newFragmentModal').addClass('hidden').removeClass('flex');
            });

            setInterval(() => $('#clock').text(new Date().toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            })), 1000);
        });
    </script>
</body>

</html>