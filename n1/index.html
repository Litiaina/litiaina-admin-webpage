<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>N1 Cloud - Professional</title>
    <link rel="icon" type="image/png" href="../images/litiaina_icon_48x48.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts & Icons -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* --- Synology-inspired Dark Theme --- */
            --bg-desktop: #1b2028;
            --bg-window: #242424;
            --bg-sidebar: #1f1f1f;
            --header-bg: #2d2d2d;
            --border-color: #383838;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --text-muted: #6b7280;
            --item-hover: rgba(255, 255, 255, 0.04);
            --item-active: rgba(59, 130, 246, 0.15);
            --selection-color: rgba(59, 130, 246, 0.3);
            --selection-border: #3b82f6;
        }

        .status-pending {
            opacity: 0.6;
        }

        .item-tile {
            height: 155px;
        }

        .item-list {
            height: 42px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-desktop);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            color: var(--text-primary);
        }

        /* --- Desktop --- */
        #desktop {
            position: relative;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 50%, #20252e 0%, #111418 100%);
            background-size: cover;
            background-image: url("../images/n1-cloud-professional-wallpaper.jpg")
        }

        /* --- Bottom Taskbar --- */
        #taskbar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 48px;
            background: rgba(30, 30, 30, 0.75);
            backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            padding: 0 12px;
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            margin-right: 8px;
        }

        .start-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #taskbar-apps {
            display: flex;
            gap: 4px;
            margin-left: 4px;
            flex: 1;
            height: 100%;
            align-items: center;
        }

        .task-item {
            height: 38px;
            padding: 0 12px;
            background: transparent;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            max-width: 160px;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .task-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border-bottom: 2px solid var(--accent-color);
        }

        .task-item-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Desktop Icons --- */
        #desktop-icons {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 10;
        }

        .desktop-icon {
            width: 96px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 10px 4px;
            border-radius: 8px;
            transition: background 0.2s, transform 0.1s;
            text-align: center;
            background-color: rgba(30, 30, 30, 0.45);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .desktop-icon:hover {
            background-color: rgba(60, 60, 60, 0.6);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .desktop-icon:active {
            transform: translateY(1px);
        }

        .desktop-icon-img {
            font-size: 32px;
            margin-bottom: 8px;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.4));
        }

        .desktop-icon-label {
            color: #e5e5e5;
            font-size: 11px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            line-height: 1.3;
        }

        /* --- Windows --- */
        #windows-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 48px;
            z-index: 50;
            pointer-events: none;
        }

        .window {
            position: absolute;
            background-color: var(--bg-window);
            border-radius: 6px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.15s, transform 0.15s;
            pointer-events: auto;
        }

        .window.visible {
            opacity: 1;
            transform: scale(1);
        }

        .window-header {
            height: 36px;
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            cursor: move;
            flex-shrink: 0;
        }

        .window-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .win-btn {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
        }

        .win-close {
            background: #ff5f56;
        }

        .win-min {
            background: #ffbd2e;
        }

        .win-max {
            background: #27c93f;
        }

        .window-body {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: var(--bg-window);
            position: relative;
        }

        .window-sidebar {
            width: 200px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .nav-item {
            padding: 6px 16px;
            color: var(--text-secondary);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.1s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--item-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--item-active);
            color: var(--accent-color);
            border-left-color: var(--accent-color);
            font-weight: 500;
        }

        .window-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .toolbar {
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            background: var(--bg-window);
        }

        .tool-btn {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--text-primary);
            background: #333;
            border: 1px solid #444;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.1s;
        }

        .tool-btn:hover {
            background: #444;
        }

        .tool-btn.primary {
            background: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .tool-btn.primary:hover {
            background: var(--accent-hover);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: var(--text-muted);
            padding: 0 8px;
        }

        #browser {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
            outline: none;
        }

        #browser.drag-active {
            background-color: rgba(59, 130, 246, 0.1) !important;
            border: 2px dashed #3b82f6 !important;
        }

        .file-item {
            border: 1px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
        }

        .file-item:hover {
            background: var(--item-hover);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Selection Styles */
        .file-item.selected {
            background-color: var(--selection-color) !important;
            border-color: var(--selection-border) !important;
            box-shadow: inset 0 0 0 1px var(--selection-border);
        }

        .file-item.selected .desktop-icon-label,
        .file-item.selected .text-gray-300,
        .file-item.selected .text-gray-500 {
            color: #fff !important;
        }

        /* Selection Box (Marquee) */
        #selection-marquee {
            position: absolute;
            border: 1px solid var(--accent-color);
            background-color: rgba(59, 130, 246, 0.2);
            z-index: 9999;
            pointer-events: none;
            display: none;
        }

        /* Resource Monitor */
        .res-sidebar {
            width: 160px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-color);
            padding: 10px;
        }

        .res-tab {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 2px;
        }

        .res-tab:hover {
            background: var(--item-hover);
            color: var(--text-primary);
        }

        .res-tab.active {
            background: var(--item-active);
            color: var(--accent-color);
            font-weight: 600;
        }

        .res-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .res-card {
            background: #2a2a2a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .res-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .res-val {
            font-size: 24px;
            font-weight: 300;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-icon {
            width: 24px;
            text-align: center;
            margin-right: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-corner {
            background: transparent;
        }

        #contextMenu {
            background: #2d2d2d;
            border: 1px solid #404040;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            z-index: 5000;
        }

        .ctx-item {
            padding: 6px 16px;
            cursor: pointer;
            color: var(--text-primary);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ctx-item:hover {
            background: var(--accent-color);
            color: white;
        }

        .ctx-div {
            border-top: 1px solid #404040;
            margin: 4px 0;
        }

        #boot-screen {
            position: fixed;
            inset: 0;
            background: #111;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.6s;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(2px);
        }

        .zoom-controls {
            display: flex;
            gap: 2px;
            background: #1f1f1f;
            border: 1px solid #383838;
            border-radius: 4px;
            padding: 2px;
        }
    </style>
</head>

<body class="antialiased text-gray-200" oncontextmenu="return false;">

    <!-- Boot Screen -->
    <div id="boot-screen" class="flex flex-col items-center justify-center">
        <img src="../images/litiaina_icon_48x48.png" alt="logo" class="w-16 h-16 rounded-lg mb-4" />
        <h1 class="text-lg font-medium tracking-wide text-gray-300">N1 Cloud</h1>
        <p class="text-[10px] text-gray-600 mt-2 font-mono">ENGINE VERSION 0.0.3 â€¢ LOADING SHELL</p>
    </div>

    <!-- Selection Marquee -->
    <div id="selection-marquee"></div>

    <div id="desktop">
        <!-- Desktop Icons -->
        <div id="desktop-icons">
            <div class="desktop-icon" onclick="WindowManager.open('file-explorer')">
                <div class="desktop-icon-img text-blue-500"><i class="fas fa-folder-tree"></i></div>
                <div class="desktop-icon-label">File Station</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('dashboard')">
                <div class="desktop-icon-img text-green-500"><i class="fas fa-chart-line"></i></div>
                <div class="desktop-icon-label">Resource Monitor</div>
            </div>
            <div class="desktop-icon" onclick="WindowManager.open('recycle-bin')">
                <div class="desktop-icon-img text-gray-400"><i class="fas fa-trash-can"></i></div>
                <div class="desktop-icon-label">Recycle Bin</div>
            </div>
        </div>

        <!-- Taskbar -->
        <div id="taskbar">
            <div class="start-btn" id="start-btn"><i class="fas fa-th text-lg"></i></div>
            <div id="taskbar-apps"></div>
            <div class="ml-auto flex items-center gap-4 text-xs font-mono text-gray-400">
                <div class="cursor-pointer hover:text-white flex items-center gap-2" title="Upload Status"
                    onclick="WindowManager.open('uploads')">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div id="clock">12:00 PM</div>
                <div class="w-7 h-7 rounded-full bg-blue-600 flex items-center justify-center text-white cursor-pointer hover:bg-blue-500"
                    id="user-profile-btn" title="Logout">
                    <i class="fas fa-power-off text-[10px]"></i>
                </div>
            </div>
        </div>

        <!-- Windows Layer -->
        <div id="windows-container">

            <!-- 1. FILE EXPLORER -->
            <div id="win-file-explorer" class="window"
                style="width: 1000px; height: 650px; top: 60px; left: 100px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-folder-tree text-blue-500"></i> File Station</div>
                    <div class="window-controls">
                        <div class="win-btn win-min" onclick="WindowManager.minimize('file-explorer')"></div>
                        <div class="win-btn win-max" onclick="WindowManager.maximize('file-explorer')"></div>
                        <div class="win-btn win-close" onclick="WindowManager.close('file-explorer')"></div>
                    </div>
                </div>
                <div class="window-body">
                    <div class="window-sidebar">
                        <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 px-4 mt-2">Access</div>
                        <div class="nav-item active" id="nav-my-files" onclick="AppNav.navigate('my-files')">
                            <i class="fas fa-hard-drive w-4 text-center"></i> Local Files
                        </div>
                        <div class="nav-item" id="nav-recent" onclick="AppNav.navigate('recent')">
                            <i class="fas fa-clock w-4 text-center"></i> Recent
                        </div>
                        <div class="nav-item" id="nav-starred" onclick="AppNav.navigate('starred')">
                            <i class="fas fa-star w-4 text-center text-yellow-500"></i> Important
                        </div>

                        <div class="flex justify-between items-center px-4 mt-6 mb-2">
                            <div class="text-[10px] font-bold text-gray-500 uppercase">Mounts</div>
                            <button id="addFragmentBtn" class="text-xs text-gray-400 hover:text-white"><i
                                    class="fas fa-plus"></i></button>
                        </div>
                        <div id="fragmentList" class="flex flex-col gap-1 overflow-y-auto max-h-40 custom-scrollbar">
                        </div>

                        <!-- Storage Quota UI -->
                        <div class="mt-auto p-4 border-t border-[#383838]">
                            <div class="flex justify-between items-center mb-1 text-[10px] text-gray-400">
                                <span>Storage</span>
                                <span id="sidebar-storage-percent">0%</span>
                            </div>
                            <div class="w-full bg-[#333] rounded-full h-1.5 mb-2">
                                <div id="sidebar-storage-bar"
                                    class="bg-blue-500 h-1.5 rounded-full transition-all duration-500"
                                    style="width: 0%"></div>
                            </div>
                            <div id="sidebar-gb-used" class="text-[10px] text-gray-500">0 GB used</div>
                        </div>
                    </div>
                    <div class="window-content">
                        <div class="toolbar">
                            <div class="flex items-center gap-2">
                                <button id="back-btn"
                                    class="w-7 h-7 flex items-center justify-center rounded hover:bg-[#4a4a4a] text-gray-300 hidden"
                                    onclick="navigateBack()">
                                    <i class="fas fa-chevron-left text-xs"></i>
                                </button>
                                <button class="tool-btn hover:bg-[#444]" onclick="listObjects(activeFragment)"><i
                                        class="fas fa-sync-alt"></i></button>
                                <button class="tool-btn primary"
                                    onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i>
                                    Upload</button>
                                <button class="tool-btn"
                                    onclick="document.getElementById('newFolderBtnAction').click()"><i
                                        class="fas fa-folder-plus"></i> New Folder</button>
                            </div>
                            <div class="flex-1 mx-4">
                                <div
                                    class="bg-[#1f1f1f] border border-[#383838] rounded flex items-center px-3 py-1 w-full max-w-md focus-within:border-blue-500 transition-colors">
                                    <i class="fas fa-search text-gray-500 mr-2 text-xs"></i>
                                    <input type="text" id="searchInput" placeholder="Search..."
                                        class="bg-transparent border-none outline-none text-xs w-full text-white placeholder-gray-600 h-6">
                                </div>
                            </div>
                            <div class="flex bg-[#1f1f1f] rounded border border-[#383838] p-0.5">
                                <button id="tiles-view-btn"
                                    class="p-1.5 rounded hover:bg-[#333] text-gray-400 text-xs"><i
                                        class="fas fa-th-large"></i></button>
                                <button id="list-view-btn"
                                    class="p-1.5 rounded hover:bg-[#333] text-gray-400 text-xs"><i
                                        class="fas fa-list"></i></button>
                            </div>
                        </div>
                        <div class="h-8 border-b border-[#383838] flex items-center px-4 bg-[#242424]">
                            <div id="breadcrumb" class="breadcrumb">Local Files</div>
                        </div>
                        <div id="browser" class="custom-scrollbar bg-[#1e1e1e] relative select-none">
                            <div id="objectList" class="grid gap-4"
                                style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));"></div>
                            <div id="browserSpinner"
                                class="absolute inset-0 flex items-center justify-center bg-[#1e1e1e]/80 hidden z-10">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-circle-notch fa-spin text-2xl text-blue-500 mb-2"></i>
                                    <span class="text-xs text-gray-400 font-mono">ACCESSING DISK...</span>
                                </div>
                            </div>
                        </div>
                        <div
                            class="h-6 bg-[#2d2d2d] border-t border-[#383838] flex items-center px-4 text-[10px] text-gray-500 justify-between">
                            <span id="selection-status">0 items selected</span>
                            <span id="network-activity-status" class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-green-500"></div> Connected
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. RESOURCE MONITOR (UPDATED) -->
            <div id="win-dashboard" class="window"
                style="width: 900px; height: 600px; top: 80px; left: 150px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-chart-line text-green-500"></i> Resource Monitor</div>
                    <div class="window-controls">
                        <div class="win-btn win-min" onclick="WindowManager.minimize('dashboard')"></div>
                        <div class="win-btn win-close" onclick="WindowManager.close('dashboard')"></div>
                    </div>
                </div>
                <div class="window-body">
                    <div class="res-sidebar">
                        <div class="res-tab active" onclick="ResMonitor.showTab('overview')"><i
                                class="fas fa-tachometer-alt w-5 text-center mr-1"></i> Overview</div>
                    </div>
                    <div class="res-content bg-[#1e1e1e] custom-scrollbar">
                        <!-- Overview Tab -->
                        <div id="res-tab-overview" class="block">
                            <h2 class="text-lg font-light text-white mb-4">System Status: <span
                                    class="text-green-500">Healthy</span></h2>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Account Info -->
                                <div
                                    class="res-card col-span-2 flex gap-4 items-center bg-gradient-to-r from-[#2a2a2a] to-[#222]">
                                    <div
                                        class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white text-xl shadow-lg">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div>
                                        <div class="text-sm text-gray-400 uppercase tracking-wider text-[10px]">Current
                                            Account</div>
                                        <div class="text-lg font-medium text-white" id="account-name-display">Loading...
                                        </div>
                                        <div class="text-xs text-gray-500 font-mono" id="account-email-display">
                                            Loading...</div>
                                    </div>
                                </div>

                                <!-- Network Activity Charts (Replacing CPU/RAM) -->
                                <div class="res-card">
                                    <div class="res-label text-blue-400"><i class="fas fa-arrow-down mr-2"></i>Network
                                        In (Download)</div>
                                    <div class="h-32 w-full relative">
                                        <canvas id="net-in-chart"></canvas>
                                    </div>
                                    <div class="text-right mt-2 font-mono text-sm text-blue-300" id="net-in-val">0 KB/s
                                    </div>
                                </div>
                                <div class="res-card">
                                    <div class="res-label text-green-400"><i class="fas fa-arrow-up mr-2"></i>Network
                                        Out (Upload)</div>
                                    <div class="h-32 w-full relative">
                                        <canvas id="net-out-chart"></canvas>
                                    </div>
                                    <div class="text-right mt-2 font-mono text-sm text-green-300" id="net-out-val">0
                                        KB/s</div>
                                </div>

                                <!-- Storage Analysis with Pie Chart -->
                                <div class="res-card col-span-2">
                                    <div class="flex gap-6">
                                        <!-- Pie Chart Area -->
                                        <div class="w-1/3 flex flex-col items-center justify-center">
                                            <div class="res-label w-full text-center">File Distribution</div>
                                            <div class="relative w-40 h-40">
                                                <canvas id="storage-pie-chart"></canvas>
                                            </div>
                                            <div class="text-xs text-gray-500 mt-2 text-center"
                                                id="storage-total-label">0 GB Used</div>
                                        </div>

                                        <!-- Stats List -->
                                        <div class="flex-1">
                                            <div class="res-label">Storage Details</div>
                                            <div class="space-y-2 text-xs" id="storage-stats-container">
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-image stat-icon text-purple-400"></i>Images</span>
                                                    <span class="text-white font-mono" id="stat-images">0 files (0
                                                        MB)</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-video stat-icon text-pink-500"></i>Videos</span>
                                                    <span class="text-white font-mono" id="stat-videos">0 files (0
                                                        MB)</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-music stat-icon text-yellow-500"></i>Audio</span>
                                                    <span class="text-white font-mono" id="stat-audio">0 files (0
                                                        MB)</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-file-word stat-icon text-blue-500"></i>Documents</span>
                                                    <span class="text-white font-mono" id="stat-docs">0 files (0
                                                        MB)</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-file-zipper stat-icon text-orange-500"></i>Archives</span>
                                                    <span class="text-white font-mono" id="stat-archives">0 files (0
                                                        MB)</span>
                                                </div>
                                                <div class="stat-row">
                                                    <span class="text-gray-400"><i
                                                            class="fas fa-file stat-icon text-gray-500"></i>Others</span>
                                                    <span class="text-white font-mono" id="stat-others">0 files (0
                                                        MB)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. RECYCLE BIN -->
            <div id="win-recycle-bin" class="window"
                style="width: 800px; height: 500px; top: 120px; left: 150px; display: none;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-trash-can text-gray-400"></i> Recycle Bin</div>
                    <div class="window-controls">
                        <div class="win-btn win-min" onclick="WindowManager.minimize('recycle-bin')"></div>
                        <div class="win-btn win-close" onclick="WindowManager.close('recycle-bin')"></div>
                    </div>
                </div>
                <div class="window-body">
                    <div class="window-sidebar">
                        <div class="text-[10px] font-bold text-gray-500 uppercase mb-2 px-4 mt-2">Trash Can</div>
                        <div class="nav-item active"><i class="fas fa-dumpster w-4 text-center"></i> Recycle Bin</div>
                        <div class="mt-auto p-4 text-[10px] text-gray-500 text-center">Items are automatically deleted
                            after 30 days.</div>
                    </div>
                    <div class="window-content">
                        <div class="toolbar">
                            <button id="empty-trash-btn"
                                class="tool-btn hover:bg-red-900/50 hover:text-red-400 hover:border-red-900"><i
                                    class="fas fa-dumpster-fire"></i> Empty Bin</button>
                            <button id="restore-all-btn"
                                class="tool-btn hover:bg-green-900/50 hover:text-green-400 hover:border-green-900 ml-2"><i
                                    class="fas fa-trash-restore"></i> Restore All</button>
                            <div class="flex-1"></div>
                            <div class="flex bg-[#1f1f1f] rounded border border-[#383838] p-0.5">
                                <button id="trash-tiles-btn"
                                    class="p-1.5 rounded hover:bg-[#333] text-gray-400 text-xs"><i
                                        class="fas fa-th-large"></i></button>
                                <button id="trash-list-btn" class="p-1.5 rounded bg-blue-600 text-white text-xs"><i
                                        class="fas fa-list"></i></button>
                            </div>
                        </div>
                        <div
                            class="h-8 border-b border-[#383838] flex items-center px-4 bg-[#242424] text-xs text-gray-400">
                            <i class="fas fa-trash-can mr-2"></i> Recycle Bin
                        </div>
                        <div id="recycle-bin-content"
                            class="custom-scrollbar bg-[#1e1e1e] flex-1 overflow-y-auto content-start"></div>
                    </div>
                </div>
            </div>

            <!-- 6. UPLOAD MANAGER -->
            <div id="win-uploads" class="window"
                style="width: 400px; height: 350px; top: 100px; right: 120px; display: none; z-index: 2000;">
                <div class="window-header">
                    <div class="window-title"><i class="fas fa-cloud-upload-alt text-blue-400"></i> Upload Queue</div>
                    <div class="window-controls">
                        <div class="win-btn win-min" onclick="WindowManager.minimize('uploads')"></div>
                        <div class="win-btn win-close" onclick="WindowManager.close('uploads')"></div>
                    </div>
                </div>
                <div class="window-body flex-col bg-[#242424]">
                    <div
                        class="p-2 border-b border-[#383838] flex justify-between items-center text-[10px] text-gray-400 bg-[#2a2a2a]">
                        <span id="upload-status-header">Ready</span>
                        <button onclick="document.getElementById('upload-items-container').innerHTML=''"
                            class="hover:text-white">CLEAR LIST</button>
                    </div>
                    <div id="upload-items-container" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div id="contextMenu" class="fixed hidden rounded py-1 w-48 text-sm border border-[#404040]"></div>
    <div id="toast-container" class="fixed top-16 right-5 z-[6000] space-y-2"></div>

    <!-- Modals -->
    <div id="newFolderModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="bg-[#242424] p-6 rounded-lg shadow-xl border border-[#404040] w-80 text-white">
            <h3 class="font-bold mb-4">Create New Folder</h3>
            <input type="text" id="newFolderNameInput" placeholder="Folder Name"
                class="bg-[#111] border border-[#444] w-full p-2 rounded mb-4 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelNewFolderBtn" class="text-xs text-gray-400 hover:text-white px-3 py-2">CANCEL</button>
                <button id="confirmNewFolderBtn"
                    class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">CREATE</button>
            </div>
        </div>
    </div>

    <div id="newFragmentModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="bg-[#242424] p-6 rounded-lg shadow-xl border border-[#404040] w-80 text-white">
            <h3 class="font-bold mb-4">Create New Mount</h3>
            <input type="text" id="newFragmentNameInput" placeholder="Mount Name"
                class="bg-[#111] border border-[#444] w-full p-2 rounded mb-4 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelNewFragmentBtn"
                    class="text-xs text-gray-400 hover:text-white px-3 py-2">CANCEL</button>
                <button id="confirmNewFragmentBtn"
                    class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">CREATE</button>
            </div>
        </div>
    </div>

    <div id="renameModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="bg-[#242424] p-6 rounded-lg shadow-xl border border-[#404040] w-96 text-white">
            <h3 class="font-bold mb-4">Rename Object</h3>
            <input id="newObjectKeyInput"
                class="bg-[#111] border border-[#444] w-full p-2 rounded mb-4 text-sm focus:border-blue-500 outline-none text-white">
            <div class="flex justify-end gap-2">
                <button id="cancelRenameBtn" class="text-xs text-gray-400 hover:text-white px-3 py-2">CANCEL</button>
                <button id="confirmRenameBtn"
                    class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">RENAME</button>
            </div>
        </div>
    </div>

    <div id="shareModal" class="hidden modal-backdrop fixed inset-0 flex items-center justify-center z-[2000]">
        <div class="bg-[#242424] p-6 rounded-lg shadow-xl border border-[#404040] w-96 text-white">
            <h3 class="font-bold mb-4">Share Link</h3>
            <div class="space-y-4">
                <select id="shareDisposition"
                    class="w-full bg-[#111] border border-[#444] p-2 rounded text-sm outline-none">
                    <option value="view">View Only</option>
                    <option value="stream">Stream (Video)</option>
                    <option value="download">Download</option>
                </select>
                <input id="shareExpiry" type="number" value="3600" placeholder="Expires in (seconds)"
                    class="w-full bg-[#111] border border-[#444] p-2 rounded text-sm outline-none">
                <div class="flex gap-2">
                    <input id="shareUrl"
                        class="flex-1 bg-[#111] border border-[#444] p-2 rounded text-xs text-gray-300 font-mono"
                        readonly placeholder="Generated URL...">
                    <button id="copyShareUrlBtn" class="bg-[#333] hover:bg-[#444] px-3 rounded text-white"><i
                            class="fas fa-copy"></i></button>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="closeShareBtn" class="text-xs text-gray-400 hover:text-white px-3 py-2">CLOSE</button>
                <button id="generateShareBtn"
                    class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded">GENERATE</button>
            </div>
        </div>
    </div>

    <div id="genericModal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[5000] hidden flex items-center justify-center">
        <div class="bg-[#242424] p-6 rounded-lg shadow-2xl border border-[#404040] w-96">
            <h3 id="modalTitle" class="text-sm font-bold text-white mb-4 uppercase tracking-wider">Title</h3>
            <div id="modalContent" class="text-sm text-gray-300"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="modalCancel"
                    class="px-4 py-2 rounded text-xs bg-[#333] hover:bg-[#444] text-gray-200">Cancel</button>
                <button id="modalConfirm"
                    class="px-4 py-2 rounded text-xs bg-blue-600 hover:bg-blue-500 text-white">Confirm</button>
            </div>
        </div>
    </div>

    <div id="progressModal"
        class="fixed inset-0 bg-black/70 backdrop-blur-sm z-[6000] hidden flex-col items-center justify-center">
        <div class="bg-[#242424] p-6 rounded-lg shadow-2xl border border-[#404040] w-96">
            <h3 id="progressTitle" class="text-sm font-bold text-white mb-2">Processing...</h3>
            <div class="w-full bg-[#333] rounded-full h-2 mb-3">
                <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-200"
                    style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[10px] text-gray-400 font-mono">
                <span id="progressStatus">Initializing...</span>
                <span id="progressCount">0/0</span>
            </div>
        </div>
    </div>

    <!-- Hidden Inputs -->
    <input type="file" id="fileInput" class="hidden" multiple />
    <input type="file" id="folderInput" class="hidden" webkitdirectory directory />
    <input type="file" id="resumeFileInput" class="hidden">
    <button id="newFolderBtnAction" class="hidden"></button>

    <script>
        // --- Core Variables ---
        let currentObjectList = [];
        let clientSideFolders = [];
        let clientSideFragments = [];
        let starredItems = JSON.parse(localStorage.getItem('starredItems')) || [];
        let trashedItems = JSON.parse(localStorage.getItem('trashedItems')) || [];
        let openFilesMap = new Map();
        let activeFragment = 'My Files';
        let currentPath = '';
        let currentView = 'tiles';
        let currentTrashView = 'list';
        const serverLink = `https://storage.litiaina.com`;
        const token = localStorage.getItem("current-token")?.trim() || "";
        const totalCapacity = Number(localStorage.getItem("current-capacity")?.trim()) || (15 * 1024 * 1024 * 1024);
        let uploadQueue = [];
        let activeUploads = 0;
        // HTTP/2 Optimization: Increased from 1 to 5 to allow parallel file uploads
        const MAX_CONCURRENT_UPLOADS = 5; 
        const MB = 1024 * 1024;

        // Stats for Network Graph
        // Removed global variable since each upload calculates its own speed now

        // Selection Manager State
        const SelectionManager = {
            selectedItems: new Set(), // Set of strings: "folder:name" or "file:key"
            lastSelectedIndex: -1,
            clear: function () {
                this.selectedItems.clear();
                this.updateUI();
            },
            toggle: function (id, isRange = false, allItems = []) {
                if (isRange && this.lastSelectedIndex !== -1 && allItems.length > 0) {
                    // Range logic
                    const currentIndex = allItems.findIndex(i => i.id === id);
                    if (currentIndex !== -1) {
                        const start = Math.min(this.lastSelectedIndex, currentIndex);
                        const end = Math.max(this.lastSelectedIndex, currentIndex);
                        for (let i = start; i <= end; i++) {
                            this.selectedItems.add(allItems[i].id);
                        }
                    }
                } else {
                    if (this.selectedItems.has(id)) {
                        this.selectedItems.delete(id);
                    } else {
                        this.selectedItems.add(id);
                        // Find index for range selection
                        if (allItems.length) {
                            this.lastSelectedIndex = allItems.findIndex(i => i.id === id);
                        }
                    }
                }
                this.updateUI();
            },
            selectSingle: function (id, allItems = []) {
                this.selectedItems.clear();
                this.selectedItems.add(id);
                if (allItems.length) {
                    this.lastSelectedIndex = allItems.findIndex(i => i.id === id);
                }
                this.updateUI();
            },
            updateUI: function () {
                // Update Visuals
                document.querySelectorAll('.file-item').forEach(el => {
                    const id = el.dataset.id;
                    if (this.selectedItems.has(id)) el.classList.add('selected');
                    else el.classList.remove('selected');
                });
                // Update Status Bar
                const count = this.selectedItems.size;
                document.getElementById('selection-status').textContent = `${count} item${count !== 1 ? 's' : ''} selected`;
            },
            getSelection: function () {
                return Array.from(this.selectedItems).map(id => {
                    const [type, ...rest] = id.split(':');
                    const key = rest.join(':');
                    return {
                        type,
                        key
                    };
                });
            }
        };

        // User Info from LocalStorage
        const userEmail = localStorage.getItem("current-account-email") || "user@n1cloud.com";
        const userName = localStorage.getItem("current-account-name") || "N1 User";

        const thumbnailCache = new Map();

        // --- Thumbnail Queue System ---
        const ThumbnailLoader = {
            queue: [], // Array of { id, fragment, key, imgElement }
            processing: new Set(),
            maxConcurrent: 4, // Max simultaneous API requests for signing URLs

            enqueue: function(imgElement, fragment, key) {
                // If already cached, apply immediately
                if (thumbnailCache.has(key)) {
                    this.apply(imgElement, thumbnailCache.get(key));
                    return;
                }
                
                // Avoid duplicates in queue
                if (this.queue.find(item => item.key === key)) return;
                
                // Add to queue
                this.queue.push({ imgElement, fragment, key });
                this.process();
            },

            dequeue: function(key) {
                // Remove from queue if scrolled out of view (optional optimization)
                this.queue = this.queue.filter(item => item.key !== key);
            },

            process: async function() {
                if (this.processing.size >= this.maxConcurrent || this.queue.length === 0) return;

                const item = this.queue.shift();
                if (!item.imgElement.isConnected) {
                    this.process(); // Skip if element removed from DOM
                    return;
                }

                const { imgElement, fragment, key } = item;
                this.processing.add(key);

                try {
                    // 1. Get Signed URL (Hits View Limit)
                    const url = await getShareableUrl(fragment, key, 'view', 3600);
                    
                    if (url) {
                        thumbnailCache.set(key, url);
                        this.apply(imgElement, url);
                    }
                } catch (e) {
                    console.error("Thumbnail load failed", e);
                } finally {
                    this.processing.delete(key);
                    this.process(); // Trigger next
                }
            },

            apply: function(img, url) {
                img.src = url; // Hits Sharing Limit (handled by browser network queue usually, but good to control)
                img.onload = () => {
                    img.classList.remove('opacity-0');
                    if (img.previousElementSibling) img.previousElementSibling.classList.add('opacity-0');
                };
            }
        };

        // --- IMAGE OBSERVER ---
        const imageObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const img = entry.target;
                const key = img.getAttribute('data-key');
                const fragment = img.getAttribute('data-fragment');

                if (entry.isIntersecting) {
                    ThumbnailLoader.enqueue(img, fragment, key);
                    imageObserver.unobserve(img); 
                }
            });
        }, {
            root: document.getElementById('browser'),
            rootMargin: '200px', // Preload a bit more ahead since we are throttling
            threshold: 0.01
        });

        // --- Window Manager ---
        const WindowManager = {
            zIndex: 100,
            open: function (appId, meta = {}) {
                const win = $(`#win-${appId}`);
                if (win.is(':visible')) {
                    this.focus(appId);
                    return;
                }
                win.show();
                setTimeout(() => win.addClass('visible'), 10);
                this.focus(appId);
                this.addTaskbarItem(appId, meta);
                if (appId === 'dashboard') {
                    setTimeout(() => ResMonitor.init(), 100);
                }
                if (appId === 'recycle-bin') showTrash();
                if (appId === 'file-explorer') {
                    if (activeFragment && currentObjectList.length === 0) listObjects(activeFragment);
                    else setTimeout(() => VirtualScroller.renderVisible(), 50);
                }
                if (appId === 'uploads') checkForInterruptedUploads();
            },
            close: function (appId) {
                const win = $(`#win-${appId}`);
                win.removeClass('visible');
                setTimeout(() => {
                    win.hide();
                    if (appId.startsWith('viewer-')) {
                        win.remove();
                        for (let [key, val] of openFilesMap.entries()) {
                            if (val === appId) openFilesMap.delete(key);
                        }
                    }
                }, 150);
                $(`#task-item-${appId}`).remove();
            },
            minimize: function (appId) {
                $(`#win-${appId}`).removeClass('visible');
                setTimeout(() => $(`#win-${appId}`).hide(), 150);
                $(`#task-item-${appId}`).removeClass('active');
            },
            maximize: function (appId) {
                const win = $(`#win-${appId}`);
                win.toggleClass('maximized');
                if (win.hasClass('maximized')) win.css({
                    top: '0',
                    left: 0,
                    width: '100%',
                    height: '100%',
                    borderRadius: 0
                });
                else {
                    const defaults = {
                        'file-explorer': {
                            w: 1000,
                            h: 650,
                            t: 60,
                            l: 100
                        },
                        'dashboard': {
                            w: 900,
                            h: 600,
                            t: 80,
                            l: 150
                        },
                        'recycle-bin': {
                            w: 800,
                            h: 500,
                            t: 120,
                            l: 150
                        },
                        'uploads': {
                            w: 400,
                            h: 350,
                            t: 100,
                            l: 120
                        }
                    }[appId] || {
                        w: 800,
                        h: 550,
                        t: 100,
                        l: 100
                    };
                    win.css({
                        width: defaults.w,
                        height: defaults.h,
                        top: defaults.t,
                        left: defaults.l,
                        borderRadius: '6px'
                    });
                }
            },
            focus: function (appId) {
                this.zIndex++;
                $(`#win-${appId}`).css('z-index', this.zIndex);
                $('.task-item').removeClass('active');
                $(`#task-item-${appId}`).addClass('active');
            },
            addTaskbarItem: function (appId, meta = {}) {
                if ($(`#task-item-${appId}`).length === 0) {
                    const map = {
                        'file-explorer': 'File Station',
                        'dashboard': 'Monitor',
                        'recycle-bin': 'Trash',
                        'uploads': 'Upload Queue'
                    };
                    const iconMap = {
                        'file-explorer': 'fa-folder-tree',
                        'dashboard': 'fa-chart-line',
                        'recycle-bin': 'fa-trash-can',
                        'uploads': 'fa-cloud-upload-alt'
                    };
                    const label = meta.title || map[appId] || 'App';
                    const icon = meta.icon || iconMap[appId] || 'fa-window-maximize';
                    $('#taskbar-apps').append(`<div id="task-item-${appId}" class="task-item active" onclick="WindowManager.open('${appId}')" title="${label}"><i class="fas ${icon}"></i> <span class="task-item-text">${label}</span></div>`);
                }
            }
        };

        // --- Resource Monitor (Chart.js) ---
        const ResMonitor = {
            charts: {},
            init: function () {
                if (!document.getElementById('net-in-chart').offsetParent) return;
                if (this.charts['net-in']) return;

                // Update Account Info
                $('#account-name-display').text(userName);
                $('#account-email-display').text(userEmail);

                this.initCharts();
                updateCapacityDisplay();
                updateStorageStats(); // Initial Draw of Pie Chart
            },
            showTab: function (tabId) {
                $('.res-tab').removeClass('active');
                $(`.res-tab[onclick*="${tabId}"]`).addClass('active');
            },
            initCharts: function () {
                Chart.defaults.color = '#a3a3a3';
                Chart.defaults.borderColor = '#333';
                Chart.defaults.font.family = "'Inter', sans-serif";

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            min: 0,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                callback: function (val) {
                                    return formatBytes(val, 0) + '/s';
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 0
                        },
                        line: {
                            tension: 0.4,
                            borderWidth: 2
                        }
                    }
                };

                // Net In Chart
                this.charts['net-in'] = new Chart(document.getElementById('net-in-chart'), {
                    type: 'line',
                    data: {
                        labels: Array(30).fill(''),
                        datasets: [{
                            data: Array(30).fill(0),
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f620',
                            fill: true
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                max: 20 * 1024 * 1024
                            }
                        }
                    } // Cap axis for visuals
                });

                // Net Out Chart
                this.charts['net-out'] = new Chart(document.getElementById('net-out-chart'), {
                    type: 'line',
                    data: {
                        labels: Array(30).fill(''),
                        datasets: [{
                            data: Array(30).fill(0),
                            borderColor: '#22c55e',
                            backgroundColor: '#22c55e20',
                            fill: true
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                max: 10 * 1024 * 1024
                            }
                        }
                    }
                });

                // Pie Chart
                this.charts['pie'] = new Chart(document.getElementById('storage-pie-chart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Images', 'Videos', 'Audio', 'Docs', 'Archives', 'Other'],
                        datasets: [{
                            data: [1, 1, 1, 1, 1, 1], // Placeholders
                            backgroundColor: ['#c084fc', '#ec4899', '#eab308', '#3b82f6', '#f97316', '#6b7280'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });

                // Simulation Loop
                setInterval(() => {
                    this.updateNetworkCharts();
                }, 1000);
            },
            updateNetworkCharts: function () {
                if (!this.charts['net-in']) return;

                // Simulate Network Traffic (Base noise + active upload speed)
                // Base noise: 100KB - 500KB download (idle chatter), 10KB - 50KB upload
                const baseDown = Math.random() * 400 * 1024 + 100 * 1024;
                const baseUp = Math.random() * 40 * 1024 + 10 * 1024;
                
                // Calculate total upload speed from all active uploads
                const totalUploadSpeed = uploadQueue.reduce((acc, item) => acc + (item.currentSpeed || 0), 0);

                const totalUp = baseUp + totalUploadSpeed;
                const totalDown = baseDown; // We don't track download speed variable yet

                // Update Data Arrays
                const update = (chart, val, labelId) => {
                    const data = chart.data.datasets[0].data;
                    data.push(val);
                    data.shift();
                    chart.update('none');
                    document.getElementById(labelId).innerText = formatBytes(val) + '/s';
                };

                update(this.charts['net-in'], totalDown, 'net-in-val');
                update(this.charts['net-out'], totalUp, 'net-out-val');
            },
            updatePieChart: function (stats) {
                if (!this.charts['pie']) return;
                const data = [stats.images.size, stats.videos.size, stats.audio.size, stats.docs.size, stats.archives.size, stats.others.size];
                // If all zero, show placeholder
                if (data.every(v => v === 0)) this.charts['pie'].data.datasets[0].data = [1, 0, 0, 0, 0, 0];
                else this.charts['pie'].data.datasets[0].data = data;
                this.charts['pie'].update();
            }
        };

        // --- Core File System ---
        const AppNav = {
            navigate: function (view) {
                $('.nav-item').not('.fragment-item').removeClass('active');
                $(`#nav-${view}`).addClass('active');
                if (view === 'my-files') {
                    currentPath = '';
                    renderObjects(getActiveObjectList());
                } else if (view === 'recent') showRecentFiles();
                else if (view === 'starred') showStarredFiles();
            }
        };

        function getActiveObjectList() {
            const trashKeys = new Set(trashedItems.map(t => t.key));
            return currentObjectList.filter(o => !trashKeys.has(o.key));
        }

        const VirtualScroller = {
            items: [],
            container: null,
            content: null,
            viewType: 'tiles',
            ticking: false,
            lastStartIndex: -1,
            lastEndIndex: -1,
            init: function (containerId, contentId) {
                this.container = document.getElementById(containerId);
                this.content = document.getElementById(contentId);
                if (this.container) {
                    this.container.addEventListener('scroll', () => {
                        if (!this.ticking) {
                            window.requestAnimationFrame(() => {
                                this.renderVisible();
                                this.ticking = false;
                            });
                            this.ticking = true;
                        }
                    });
                    window.addEventListener('resize', () => {
                        if (!this.ticking) {
                            window.requestAnimationFrame(() => {
                                this.forceRender();
                                this.ticking = false;
                            });
                            this.ticking = true;
                        }
                    });
                }
            },
            setItems: function (items, viewType) {
                this.items = items;
                this.viewType = viewType;
                if (this.container) this.container.scrollTop = 0;
                this.forceRender();
                SelectionManager.clear();
            },
            forceRender: function () {
                this.lastStartIndex = -1;
                this.renderVisible();
            },
            getColumns: function () {
                if (this.viewType === 'list') return 1;
                if (this.container) return Math.max(2, Math.floor(this.container.clientWidth / 136));
                return 5;
            },
            getRowHeight: function () {
                return this.viewType === 'tiles' ? 171 : 46;
            },
            renderVisible: function () {
                if (!this.container || !this.content) return;
                if (!this.items.length) {
                    this.content.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 flex flex-col items-center justify-center h-full"><i class="fas fa-folder-open text-5xl mb-4 opacity-50"></i><p>Empty Folder</p></div>`;
                    this.content.style.paddingTop = '0px';
                    this.content.style.paddingBottom = '0px';
                    return;
                }
                const columns = this.getColumns();
                const rowHeight = this.getRowHeight();
                const totalItems = this.items.length;
                const totalRows = Math.ceil(totalItems / columns);
                const scrollTop = this.container.scrollTop;
                const clientHeight = this.container.clientHeight;
                const buffer = 2;
                const startRow = Math.max(0, Math.floor(scrollTop / rowHeight) - buffer);
                const endRow = Math.min(totalRows, Math.ceil((scrollTop + clientHeight) / rowHeight) + buffer);
                const startIndex = startRow * columns;
                const endIndex = Math.min(totalItems, endRow * columns);
                if (startIndex === this.lastStartIndex && endIndex === this.lastEndIndex) return;
                this.lastStartIndex = startIndex;
                this.lastEndIndex = endIndex;

                const paddingTop = startRow * rowHeight;
                const paddingBottom = Math.max(0, (totalRows * rowHeight) - (endRow * rowHeight));
                this.content.style.paddingTop = `${paddingTop}px`;
                this.content.style.paddingBottom = `${paddingBottom}px`;

                if (this.viewType === 'tiles') {
                    this.content.className = 'grid gap-4 p-4 content-start';
                    this.content.style.gridTemplateColumns = `repeat(auto-fill, minmax(120px, 1fr))`;
                    this.content.style.display = 'grid';
                } else {
                    this.content.className = 'flex flex-col gap-1 p-2 content-start';
                    this.content.style.gridTemplateColumns = 'none';
                    this.content.style.display = 'flex';
                }

                this.content.innerHTML = '';
                const slice = this.items.slice(startIndex, endIndex);
                const fragment = document.createDocumentFragment();
                slice.forEach(itemData => {
                    let el = itemData.type === 'folder' ? (this.viewType === 'tiles' ? createTile(itemData, 'folder') : createRow(itemData, 'folder')) : (this.viewType === 'tiles' ? createTile(itemData, 'file') : createRow(itemData, 'file'));
                    fragment.appendChild(el);
                });
                this.content.appendChild(fragment);
                SelectionManager.updateUI(); // Re-apply selection styles
            }
        };

        function renderObjects(objects) {
            const breadcrumb = document.getElementById('breadcrumb');
            const backBtn = document.getElementById('back-btn');
            if (currentPath) {
                backBtn.classList.remove('hidden');
                let parts = currentPath.split('/').filter(p => p);
                let html = `<span class="cursor-pointer hover:text-white" onclick="navigateTo('')">Files</span>`;
                let acc = '';
                parts.forEach(p => {
                    acc += p + '/';
                    html += ` <span class="text-gray-600">/</span> <span class="cursor-pointer hover:text-white" onclick="navigateTo('${acc}')">${p}</span>`;
                });
                breadcrumb.innerHTML = html;
            } else {
                backBtn.classList.add('hidden');
                breadcrumb.innerHTML = 'Local Files';
            }
            const folders = new Set();
            const files = [];
            objects.forEach(obj => {
                if (obj.key.startsWith(currentPath)) {
                    const relative = obj.key.substring(currentPath.length);
                    const slashIdx = relative.indexOf('/');
                    if (slashIdx > 0) folders.add(relative.substring(0, slashIdx));
                    else if (slashIdx === -1 && relative.length > 0) files.push(obj);
                }
            });
            clientSideFolders.filter(f => f.path === currentPath && f.fragment === activeFragment).forEach(f => folders.add(f.name));
            const sortedFolders = Array.from(folders).sort();
            const sortedFiles = files.sort((a, b) => new Date(Number(b.last_modified.$date.$numberLong)) - new Date(Number(a.last_modified.$date.$numberLong)));

            // Format items for VirtualScroller and SelectionManager
            const items = [
                ...sortedFolders.map(f => ({
                    type: 'folder',
                    name: f,
                    id: `folder:${f}`
                })),
                ...sortedFiles.map(f => ({
                    type: 'file',
                    data: f,
                    id: `file:${f.key}`
                }))
            ];

            VirtualScroller.setItems(items, currentView);
        }

        function showRecentFiles() {
            $('#breadcrumb').html('Recent Files');
            $('#back-btn').addClass('hidden');
            const flat = currentObjectList.filter(o => !o.key.endsWith('/')).sort((a, b) => new Date(Number(b.last_modified.$date.$numberLong)) - new Date(Number(a.last_modified.$date.$numberLong))).slice(0, 50);
            VirtualScroller.setItems(flat.map(i => ({
                type: 'file',
                data: i,
                id: `file:${i.key}`
            })), 'list');
        }

        function showStarredFiles() {
            $('#breadcrumb').html('Important');
            $('#back-btn').addClass('hidden');
            const flat = currentObjectList.filter(o => starredItems.includes(o.key));
            VirtualScroller.setItems(flat.map(i => ({
                type: 'file',
                data: i,
                id: `file:${i.key}`
            })), 'list');
        }

        function createTile(itemData, type) {
            const div = document.createElement('div');
            // Extract data depending on wrapper from VirtualScroller
            const item = type === 'folder' ? itemData.name : itemData.data;
            const uniqueId = itemData.id;

            const isPending = type === 'file' && item.status === 'Pending';
            div.className = `file-item item-tile p-3 flex flex-col items-center group relative border border-transparent rounded hover:bg-[#2a2a2a] transition-all ${isPending ? 'status-pending' : ''}`;
            div.dataset.id = uniqueId;

            const name = type === 'folder' ? item : item.key.split('/').pop();
            const ext = name.split('.').pop().toLowerCase();
            const isImage = type === 'file' && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'tiff'].includes(ext);
            const iconHtml = type === 'folder' ? '<i class="fas fa-folder text-4xl text-yellow-500 mb-2 shadow-sm"></i>' : getFileIconHTML(name);

            let visualContent;
            if (isImage && !isPending) {
                const cachedUrl = thumbnailCache.get(item.key);
                visualContent = `<div class="relative w-full h-20 mb-2 flex items-center justify-center"><div class="icon-placeholder transition-opacity duration-300 ${cachedUrl ? 'opacity-0' : ''}">${iconHtml}</div><img class="img-preview absolute inset-0 w-full h-full object-contain rounded transition-opacity duration-300 ${cachedUrl ? '' : 'opacity-0'}" alt="${name}" src="${cachedUrl || ''}" data-key="${item.key}" data-fragment="${item.fragment}" loading="lazy"></div>`;
            } else {
                visualContent = `<div class="mb-2 h-20 flex items-center justify-center">${iconHtml}</div>`;
            }

            div.innerHTML = `${visualContent}${isPending ? `<div class="absolute bottom-10 right-2 text-yellow-500"><i class="fas fa-clock"></i></div>` : ''}<span class="text-xs text-center break-all line-clamp-2 leading-tight w-full text-gray-300 group-hover:text-white mt-1 max-h-8 overflow-hidden" title="${name}">${name}</span>${type === 'file' ? `<span class="text-[10px] text-gray-600">${formatBytes(item.size_bytes)}</span>` : ''}`;
            if (isImage && !isPending && !thumbnailCache.has(item.key)) imageObserver.observe(div.querySelector('.img-preview'));

            // Event Listeners for Interaction
            attachItemListeners(div, uniqueId, type, item);
            return div;
        }

        function createRow(itemData, type) {
            const div = document.createElement('div');
            const item = type === 'folder' ? itemData.name : itemData.data;
            const uniqueId = itemData.id;

            const isPending = type === 'file' && item.status === 'Pending';
            div.className = `file-item item-list flex items-center p-2 hover:bg-[#333] ${isPending ? 'status-pending' : ''}`;
            div.dataset.id = uniqueId;

            const name = type === 'folder' ? item : item.key.split('/').pop();
            const ext = name.split('.').pop().toLowerCase();
            const isImage = type === 'file' && ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp', 'tiff'].includes(ext);
            const iconHtml = type === 'folder' ? '<i class="fas fa-folder text-yellow-500 w-6 text-center mr-3"></i>' : getFileIconHTML(name, true);
            let iconSection = isImage && !isPending ? `<div class="relative w-6 h-6 mr-3 flex-shrink-0 flex items-center justify-center"><div class="icon-placeholder absolute inset-0 flex items-center justify-center ${thumbnailCache.has(item.key) ? 'opacity-0' : ''}">${iconHtml}</div><img class="img-preview absolute inset-0 w-full h-full object-cover rounded transition-opacity duration-300 ${thumbnailCache.has(item.key) ? '' : 'opacity-0'}" alt="${name}" src="${thumbnailCache.get(item.key) || ''}" data-key="${item.key}" data-fragment="${item.fragment}" loading="lazy"></div>` : iconHtml;
            div.innerHTML = `${iconSection}<div class="flex-1 min-w-0 flex items-center"><span class="text-sm text-gray-300 truncate">${name}</span>${isPending ? `<i class="fas fa-clock text-yellow-500 ml-2 text-xs"></i>` : ''}</div>${type === 'file' ? `<span class="text-xs text-gray-500 w-20 text-right">${formatBytes(item.size_bytes)}</span>` : ''}`;
            if (isImage && !isPending && !thumbnailCache.has(item.key)) imageObserver.observe(div.querySelector('.img-preview'));

            attachItemListeners(div, uniqueId, type, item);
            return div;
        }

        function attachItemListeners(div, id, type, item) {
            div.onclick = (e) => {
                e.stopPropagation();
                if (e.ctrlKey || e.metaKey) {
                    SelectionManager.toggle(id);
                } else if (e.shiftKey) {
                    SelectionManager.toggle(id, true, VirtualScroller.items);
                } else {
                    SelectionManager.selectSingle(id, VirtualScroller.items);
                }
            };

            div.ondblclick = (e) => {
                e.stopPropagation();
                if (type === 'folder') navigateTo(currentPath + item + '/');
                else openFileViewer(item.fragment, item.key);
            };

            div.oncontextmenu = (e) => {
                if (!SelectionManager.selectedItems.has(id)) {
                    SelectionManager.selectSingle(id, VirtualScroller.items);
                }
                showCtx(e, {
                    type,
                    data: item,
                    id
                });
            };
        }

        function navigateTo(path) {
            currentPath = path;
            renderObjects(getActiveObjectList());
        }

        function navigateBack() {
            if (!currentPath) return;
            const parts = currentPath.split('/').filter(p => p);
            parts.pop();
            navigateTo(parts.length ? parts.join('/') + '/' : '');
        }

        // --- ENHANCED FILE VIEWER ---
        async function openFileViewer(fragment, key) {
            if (openFilesMap.has(key)) {
                WindowManager.open(openFilesMap.get(key));
                return;
            }
            const viewerId = `viewer-${crypto.randomUUID()}`;
            openFilesMap.set(key, viewerId);
            const fileName = key.split('/').pop();
            const ext = key.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'png', 'jpeg', 'gif', 'svg', 'webp', 'bmp', 'tiff'].includes(ext);
            const isVideo = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'm3u8'].includes(ext);
            const isAudio = ['mp3', 'wav', 'flac', 'aac', 'm4a', 'ogg'].includes(ext);
            const isOffice = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext);
            const isPdf = ['pdf'].includes(ext);
            let zoomControls = isImage ? `<div class="zoom-controls mr-2"><button class="tool-btn zoom-out-btn" title="Zoom Out"><i class="fas fa-search-minus"></i></button><button class="tool-btn zoom-reset-btn" title="Reset">100%</button><button class="tool-btn zoom-in-btn" title="Zoom In"><i class="fas fa-search-plus"></i></button></div>` : '';
            const windowHtml = `<div id="win-${viewerId}" class="window" style="width: 800px; height: 550px; top: 100px; left: 100px; display: none;"><div class="window-header"><div class="window-title"><i class="fas fa-eye text-yellow-500"></i> ${fileName}</div><div class="window-controls"><div class="win-btn win-min" onclick="WindowManager.minimize('${viewerId}')"></div><div class="win-btn win-max" onclick="WindowManager.maximize('${viewerId}')"></div><div class="win-btn win-close" onclick="WindowManager.close('${viewerId}')"></div></div></div><div class="window-body flex-col bg-[#111]"><div class="toolbar bg-[#222]">${zoomControls}<button class="tool-btn download-btn"><i class="fas fa-download"></i> Download</button><button class="tool-btn share-btn"><i class="fas fa-share-alt"></i> Share</button><div class="h-4 w-px bg-[#444] mx-2"></div><button class="tool-btn hover:text-red-400 delete-btn"><i class="fas fa-trash"></i> Delete</button><button class="tool-btn rename-btn"><i class="fas fa-pencil-alt"></i> Rename</button></div><div class="viewer-content flex-1 flex items-center justify-center overflow-hidden p-0 relative w-full h-full bg-[#0d0d0d]"><i class="fas fa-circle-notch fa-spin text-3xl text-blue-500"></i></div></div></div>`;
            $('#windows-container').append(windowHtml);
            $(`#win-${viewerId}`).draggable({
                handle: ".window-header",
                containment: "#windows-container",
                start: function () {
                    WindowManager.focus(viewerId);
                }
            }).resizable({
                minHeight: 200,
                minWidth: 300
            });
            $(`#win-${viewerId}`).on('mousedown', function () {
                WindowManager.focus(viewerId);
            });
            WindowManager.open(viewerId, {
                title: fileName,
                icon: 'fa-eye'
            });
            const winContext = $(`#win-${viewerId}`);
            winContext.find('.download-btn').click(() => performDirectDownload(fragment, key));
            winContext.find('.share-btn').click(() => showShareModal(fragment, key));
            winContext.find('.rename-btn').click(() => showRenameModal(fragment, key));
            winContext.find('.delete-btn').click(() => {
                showGenericModal('Delete File', 'Are you sure?', () => {
                    moveToTrash(key, 'file');
                    WindowManager.close(viewerId);
                });
            });
            try {
                const url = await getShareableUrl(fragment, key);
                const contentDiv = winContext.find('.viewer-content');
                let html = '';
                if (isImage) {
                    const imgId = `img-${viewerId}`;
                    html = `<div class="zoom-container overflow-hidden w-full h-full relative flex items-center justify-center cursor-grab" id="container-${imgId}"><img id="${imgId}" src="${url}" class="transition-transform duration-100 ease-out max-h-full max-w-full object-contain origin-center select-none" draggable="false"></div>`;
                    contentDiv.html(html);
                    const img = document.getElementById(imgId);
                    const container = document.getElementById(`container-${imgId}`);
                    let scale = 1,
                        panning = false,
                        pointX = 0,
                        pointY = 0,
                        startX = 0,
                        startY = 0;
                    const setTransform = () => {
                        img.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
                        winContext.find('.zoom-reset-btn').text(`${Math.round(scale * 100)}%`);
                        container.style.cursor = scale > 1 ? (panning ? 'grabbing' : 'grab') : 'default';
                    };
                    winContext.find('.zoom-in-btn').click(() => {
                        scale = Math.min(scale + 0.25, 5);
                        setTransform();
                    });
                    winContext.find('.zoom-out-btn').click(() => {
                        scale = Math.max(scale - 0.25, 0.25);
                        setTransform();
                    });
                    winContext.find('.zoom-reset-btn').click(() => {
                        scale = 1;
                        pointX = 0;
                        pointY = 0;
                        setTransform();
                    });
                    container.addEventListener('wheel', (e) => {
                        e.preventDefault();
                        const delta = -Math.sign(e.deltaY) * 0.1;
                        scale = Math.min(Math.max(0.25, scale + delta), 5);
                        setTransform();
                    });
                    container.addEventListener('mousedown', (e) => {
                        if (scale > 1) {
                            e.preventDefault();
                            startX = e.clientX - pointX;
                            startY = e.clientY - pointY;
                            panning = true;
                            container.style.cursor = 'grabbing';
                        }
                    });
                    window.addEventListener('mouseup', () => {
                        if (panning) {
                            panning = false;
                            container.style.cursor = 'grab';
                        }
                    });
                    window.addEventListener('mousemove', (e) => {
                        if (!panning) return;
                        e.preventDefault();
                        pointX = e.clientX - startX;
                        pointY = e.clientY - startY;
                        setTransform();
                    });
                } else if (isVideo) {
                    const videoId = `vid-${viewerId}`;
                    html = `<video id="${videoId}" src="${url}" controls autoplay class="max-h-full max-w-full" style="outline:none; box-shadow:0 0 20px rgba(0,0,0,0.5);"></video>`;
                    contentDiv.html(html);
                    if (ext === 'm3u8' && Hls.isSupported()) {
                        const video = document.getElementById(videoId);
                        const hls = new Hls();
                        hls.loadSource(url);
                        hls.attachMedia(video);
                        hls.on(Hls.Events.MANIFEST_PARSED, function () {
                            video.play();
                        });
                    }
                } else if (isAudio) {
                    html = `<div class="flex flex-col items-center justify-center text-center p-10"><div class="w-32 h-32 bg-[#222] rounded-full flex items-center justify-center mb-6 shadow-xl border border-[#333]"><i class="fas fa-music text-5xl text-blue-500"></i></div><h3 class="text-xl text-white mb-6 font-light tracking-wide">${fileName}</h3><audio src="${url}" controls autoplay class="w-96"></audio></div>`;
                    contentDiv.html(html);
                } else if (isOffice) {
                    const encodedUrl = encodeURIComponent(url);
                    html = `<iframe src="https://docs.google.com/viewer?url=${encodedUrl}&embedded=true" class="w-full h-full border-0"></iframe>`;
                    contentDiv.html(html);
                } else if (isPdf) {
                    html = `<iframe src="${url}" class="w-full h-full border-0"></iframe>`;
                    contentDiv.html(html);
                } else {
                    html = `<div class="text-center text-gray-500"><i class="fas fa-file-circle-question text-5xl mb-4"></i><p>Preview not available for .${ext}</p><button class="mt-4 px-4 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-500" onclick="performDirectDownload('${fragment}', '${key}')">Download File</button></div>`;
                    contentDiv.html(html);
                }
            } catch (e) {
                console.error(e);
                winContext.find('.viewer-content').html('<div class="text-red-500">Error loading file</div>');
            }
        }

        // --- Data Fetching & Stats ---
        async function listObjects(fragment, options = {
            render: true
        }) {
            if (!fragment) return;
            if (options.render) $('#browserSpinner').removeClass('hidden').addClass('flex');
            try {
                let all = [];
                let marker = null;
                while (true) {
                    let url = `${serverLink}/v4/fragment/object/metadata/${fragment}?show_all=true&limit=100`;
                    if (marker) url += `&marker=${encodeURIComponent(marker)}`;
                    const res = await fetch(url, {
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    if (!res.ok) break;
                    const page = await res.json();
                    if (page.length > 0) {
                        all.push(...page);
                        marker = page[page.length - 1].key;
                    }
                    if (page.length < 100) break;
                }
                currentObjectList = all;
                updateStorageStats();
                if (options.render) {
                    if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
                    else if ($('#nav-recent').hasClass('active')) showRecentFiles();
                    else if ($('#nav-starred').hasClass('active')) showStarredFiles();
                }
            } catch (e) {
                console.error(e);
            } finally {
                if (options.render) $('#browserSpinner').addClass('hidden');
            }
        }

        // --- UPDATED STATS LOGIC ---
        function updateStorageStats() {
            let totalBytes = 0;
            const stats = {
                images: {
                    count: 0,
                    size: 0
                },
                videos: {
                    count: 0,
                    size: 0
                },
                audio: {
                    count: 0,
                    size: 0
                },
                docs: {
                    count: 0,
                    size: 0
                },
                archives: {
                    count: 0,
                    size: 0
                },
                others: {
                    count: 0,
                    size: 0
                }
            };

            currentObjectList.forEach(obj => {
                const size = Number(obj.size_bytes);
                totalBytes += size;
                const ext = obj.key.split('.').pop().toLowerCase();
                if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'svg', 'webp', 'tiff'].includes(ext)) {
                    stats.images.count++;
                    stats.images.size += size;
                } else if (['mp4', 'mkv', 'avi', 'mov', 'webm', 'm3u8'].includes(ext)) {
                    stats.videos.count++;
                    stats.videos.size += size;
                } else if (['mp3', 'wav', 'flac', 'ogg', 'm4a', 'aac'].includes(ext)) {
                    stats.audio.count++;
                    stats.audio.size += size;
                } else if (['pdf', 'doc', 'docx', 'txt', 'md', 'rtf', 'xls', 'xlsx', 'ppt', 'pptx'].includes(ext)) {
                    stats.docs.count++;
                    stats.docs.size += size;
                } else if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) {
                    stats.archives.count++;
                    stats.archives.size += size;
                } else {
                    stats.others.count++;
                    stats.others.size += size;
                }
            });

            const pct = Math.min(100, (totalBytes / totalCapacity) * 100);
            $('#gb-used').text(formatBytes(totalBytes));
            $('#storage-percentage').text(Math.round(pct) + '%');
            $('#sidebar-gb-used').text(`${formatBytes(totalBytes)} of ${formatBytes(totalCapacity)}`);
            $('#sidebar-storage-percent').text(`${Math.round(pct)}%`);
            $('#sidebar-storage-bar').css('width', `${pct}%`);
            $('#storage-total-label').text(`${formatBytes(totalBytes)} / ${formatBytes(totalCapacity)}`);

            $('#stat-images').text(`${stats.images.count} files (${formatBytes(stats.images.size)})`);
            $('#stat-videos').text(`${stats.videos.count} files (${formatBytes(stats.videos.size)})`);
            $('#stat-audio').text(`${stats.audio.count} files (${formatBytes(stats.audio.size)})`);
            $('#stat-docs').text(`${stats.docs.count} files (${formatBytes(stats.docs.size)})`);
            $('#stat-archives').text(`${stats.archives.count} files (${formatBytes(stats.archives.size)})`);
            $('#stat-others').text(`${stats.others.count} files (${formatBytes(stats.others.size)})`);

            ResMonitor.updatePieChart(stats);
        }

        async function updateCapacityDisplay() {
            try {
                const res = await fetch(`${serverLink}/v4/capacity/usage`, {
                    headers: {
                        authorization: `Bearer ${token}`
                    }
                });
                if (res.ok) { }
            } catch (e) { }
        }

        // --- Helpers ---
        function getFileIconHTML(name, isList = false) {
            const ext = name.split('.').pop().toLowerCase();
            const map = {
                'pdf': ['fa-file-pdf', 'text-red-500'],
                'doc': ['fa-file-word', 'text-blue-500'],
                'docx': ['fa-file-word', 'text-blue-500'],
                'xls': ['fa-file-excel', 'text-green-500'],
                'xlsx': ['fa-file-excel', 'text-green-500'],
                'ppt': ['fa-file-powerpoint', 'text-orange-500'],
                'jpg': ['fa-file-image', 'text-purple-400'],
                'png': ['fa-file-image', 'text-purple-400'],
                'gif': ['fa-file-image', 'text-purple-400'],
                'mp4': ['fa-file-video', 'text-pink-500'],
                'mp3': ['fa-file-audio', 'text-yellow-500'],
                'wav': ['fa-file-audio', 'text-yellow-500'],
                'zip': ['fa-file-zipper', 'text-orange-500'],
                'rar': ['fa-file-zipper', 'text-orange-500']
            };
            const [icon, color] = map[ext] || ['fa-file', 'text-gray-400'];
            const cls = isList ? `far ${icon} ${color} w-6 text-center mr-3` : `far ${icon} text-4xl ${color} mb-2 drop-shadow-md`;
            return `<i class="${cls}"></i>`;
        }

        function formatBytes(bytes, decimals = 2) {
            if (!bytes) return '0 B';
            const k = 1024,
                i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + ['B', 'KB', 'MB', 'GB', 'TB'][i];
        }

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity || seconds < 0) return '--';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h > 0 ? h + 'h ' : ''}${m > 0 ? m + 'm ' : ''}${s}s`;
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const div = document.createElement('div');
            const color = type === 'success' ? 'border-green-500 text-green-400' : type === 'error' ? 'border-red-500 text-red-400' : 'border-blue-500 text-blue-400';
            div.className = `bg-[#222] border-l-4 ${color} text-white px-4 py-3 rounded shadow-lg flex items-center animate-[slideIn_0.3s_ease-out]`;
            div.innerHTML = `<span class="text-sm font-medium">${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
        async function getShareableUrl(fragment, key, disposition = 'view', expiresIn = 3600) {
            try {
                const res = await fetch(`${serverLink}/v4/fragment/object/share`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        authorization: `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        fragment,
                        object_key: key,
                        expires_in: expiresIn,
                        disposition
                    })
                });
                return (await res.json()).url;
            } catch (e) {
                return null;
            }
        }
        async function performDirectDownload(fragment, key) {
            const url = await getShareableUrl(fragment, key, 'download');
            if (url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = key.split('/').pop();
                document.body.appendChild(a);
                a.click();
                a.remove();
            }
        }

        // --- Context & Modals ---
        function showCtx(e, data) {
            e.preventDefault();
            e.stopPropagation();
            const menu = $('#contextMenu');
            let x = e.clientX,
                y = e.clientY;
            if (x + 200 > window.innerWidth) x -= 200;
            if (y + 200 > window.innerHeight) y -= 200;
            let html = '';

            const selectedCount = SelectionManager.selectedItems.size;

            if (data.isTrash) {
                const object = data.data;
                html = `<div class="ctx-item text-green-400" onclick="restoreFromTrash('${object.key}')"><i class="fas fa-undo w-4"></i> Restore</div><div class="ctx-div"></div><div class="ctx-item text-red-400" onclick="deletePermanently('${object.fragment}', '${object.key}', 'file')"><i class="fas fa-trash-alt w-4"></i> Delete Forever</div>`;
            } else if (selectedCount > 1 && SelectionManager.selectedItems.has(data.id)) {
                html = `
                    <div class="ctx-item bg-[#333] cursor-default font-bold text-gray-400 border-b border-[#444] mb-1">${selectedCount} Items Selected</div>
                    <div class="ctx-item" onclick="batchDownload()"><i class="fas fa-download w-4"></i> Download All</div>
                    <div class="ctx-item text-red-400" onclick="batchDelete()"><i class="fas fa-trash w-4"></i> Delete All</div>
                    `;
            } else if (data.type === 'file') {
                const isStarred = starredItems.includes(data.data.key);
                html = `<div class="ctx-item" onclick="openFileViewer('${data.data.fragment}','${data.data.key}')"><i class="fas fa-eye w-4"></i> Preview</div><div class="ctx-item" onclick="showShareModal('${data.data.fragment}','${data.data.key}')"><i class="fas fa-share-alt w-4"></i> Share</div><div class="ctx-item" onclick="showRenameModal('${data.data.fragment}','${data.data.key}')"><i class="fas fa-pencil-alt w-4"></i> Rename</div><div class="ctx-item" onclick="performDirectDownload('${data.data.fragment}','${data.data.key}')"><i class="fas fa-download w-4"></i> Download</div><div class="ctx-item" onclick="toggleStar('${data.data.key}')"><i class="${isStarred ? 'fas' : 'far'} fa-star w-4 text-yellow-500"></i> ${isStarred ? 'Unstar' : 'Star'}</div><div class="ctx-div"></div><div class="ctx-item text-red-400" onclick="moveToTrash('${data.data.key}','file')"><i class="fas fa-trash w-4"></i> Delete</div>`;
            } else {
                // BUG FIX: data.data is the string name for folders, not an object with a .name property
                const folderName = data.data;
                html = `<div class="ctx-item text-red-400" onclick="moveToTrash('${currentPath + folderName}/','folder')"><i class="fas fa-trash w-4"></i> Delete Folder</div>`;
            }
            menu.html(html).css({
                top: y,
                left: x
            }).removeClass('hidden');
        }

        // --- Batch Actions ---
        function batchDelete() {
            const items = SelectionManager.getSelection();
            showGenericModal('Batch Delete', `Are you sure you want to delete ${items.length} items?`, () => {
                items.forEach(item => {
                    if (item.type === 'file') moveToTrash(item.key, 'file');
                    else if (item.type === 'folder') moveToTrash(currentPath + item.key + '/', 'folder');
                });
                SelectionManager.clear();
            });
            $('#contextMenu').addClass('hidden');
        }

        function batchDownload() {
            const items = SelectionManager.getSelection();
            if (items.length > 5) {
                if (!confirm(`You are about to download ${items.length} files. Continue?`)) return;
            }
            let delay = 0;
            items.forEach(item => {
                if (item.type === 'file') {
                    // Stagger downloads to prevent browser blocking
                    setTimeout(() => {
                        // Find fragment from current list (Selection doesn't store fragment, need lookup)
                        const obj = currentObjectList.find(o => o.key === item.key);
                        if (obj) performDirectDownload(obj.fragment, item.key);
                    }, delay);
                    delay += 500;
                }
            });
            $('#contextMenu').addClass('hidden');
        }


        function showGenericModal(title, content, onConfirm) {
            $('#modalTitle').text(title);
            $('#modalContent').text(content);
            $('#genericModal').removeClass('hidden').addClass('flex');
            $('#modalConfirm').off().click(() => {
                onConfirm();
                $('#genericModal').addClass('hidden').removeClass('flex');
            });
            $('#modalCancel').off().click(() => $('#genericModal').addClass('hidden').removeClass('flex'));
        }

        function showRenameModal(fragment, key) {
            const modal = document.getElementById('renameModal');
            const input = document.getElementById('newObjectKeyInput');
            input.value = key;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('confirmRenameBtn').onclick = async () => {
                const newKey = input.value.trim();
                if (!newKey || newKey === key) return;
                try {
                    const response = await fetch(`${serverLink}/v4/fragment/object/rename`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            source_fragment: fragment,
                            source_key: key,
                            destination_fragment: fragment,
                            destination_key: newKey
                        })
                    });
                    if (!response.ok) throw new Error();
                    showToast('Object renamed successfully.', 'success');
                    listObjects(fragment);
                } catch (err) {
                    showToast('Failed to rename object.', 'error');
                } finally {
                    modal.classList.add('hidden');
                }
            };
            document.getElementById('cancelRenameBtn').onclick = () => modal.classList.add('hidden');
        }

        function showShareModal(fragment, key) {
            const modal = document.getElementById('shareModal');
            const urlInput = document.getElementById('shareUrl');
            urlInput.value = '';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('generateShareBtn').onclick = async () => {
                const disposition = document.getElementById('shareDisposition').value;
                const expires_in = parseInt(document.getElementById('shareExpiry').value, 10) || 3600;
                try {
                    const url = await getShareableUrl(fragment, key, disposition, expires_in);
                    urlInput.value = url;
                } catch (err) {
                    showToast('Failed to generate link.', 'error');
                }
            };
            document.getElementById('copyShareUrlBtn').onclick = () => {
                if (urlInput.value) {
                    navigator.clipboard.writeText(urlInput.value);
                    showToast('URL copied!', 'success');
                }
            };
            document.getElementById('closeShareBtn').onclick = () => modal.classList.add('hidden');
        }

        // --- Trash & Actions ---
        function moveToTrash(key, type) {
            $('#contextMenu').addClass('hidden');
            let items = type === 'folder' ? currentObjectList.filter(o => o.key.startsWith(key)) : [currentObjectList.find(o => o.key === key)].filter(Boolean);
            if (type === 'folder') clientSideFolders = clientSideFolders.filter(f => (f.path || '') + f.name + '/' !== key);
            items.forEach(i => {
                if (!trashedItems.some(t => t.key === i.key)) trashedItems.push({
                    ...i,
                    trashedDate: new Date().toISOString()
                });
            });
            localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
            renderObjects(getActiveObjectList());
            if ($('#win-recycle-bin').is(':visible')) showTrash();
        }
        async function emptyTrash() {
            if (trashedItems.length === 0) return;

            showGenericModal('Empty Recycle Bin', `Permanently delete ${trashedItems.length} items? This cannot be undone.`, async () => {
                const total = trashedItems.length;
                showProgressModal('Emptying Recycle Bin', total);

                let count = 0;
                // Create a copy to iterate safely
                const itemsToDelete = [...trashedItems];

                for (const item of itemsToDelete) {
                    count++;
                    updateProgress(count, total, `Deleting ${item.key.split('/').pop()}...`);

                    try {
                        await fetch(`${serverLink}/v4/fragment/object/delete/${item.fragment}/${item.key}`, {
                            method: 'DELETE',
                            headers: {
                                authorization: `Bearer ${token}`
                            }
                        });
                    } catch (e) {
                        console.error("Failed to delete", item.key);
                    }
                }

                trashedItems = [];
                localStorage.setItem('trashedItems', '[]');
                showTrash();
                hideProgressModal();
                showToast('Recycle Bin emptied.', 'success');
            });
        }

        function restoreAll() {
            if (trashedItems.length === 0) return;

            showGenericModal('Restore All', `Restore all ${trashedItems.length} items to their original locations?`, () => {
                const total = trashedItems.length;
                showProgressModal('Restoring Files', total);

                // Simulate a small delay for UI feel since local operations are instant
                setTimeout(() => {
                    trashedItems = [];
                    localStorage.setItem('trashedItems', '[]');

                    updateProgress(total, total, 'Finalizing...');

                    setTimeout(() => {
                        hideProgressModal();
                        showTrash();
                        // Refresh the file view if we are looking at files
                        if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
                        showToast('All items restored.', 'success');
                    }, 500);
                }, 500);
            });
        }
        async function deletePermanently(fragment, key, type) {
            $('#contextMenu').addClass('hidden');
            showGenericModal('Delete Permanently', 'Cannot be undone. Sure?', async () => {
                try {
                    await fetch(`${serverLink}/v4/fragment/object/delete/${fragment}/${key}`, {
                        method: 'DELETE',
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    trashedItems = trashedItems.filter(t => t.key !== key);
                    localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
                    showTrash();
                    showToast('File deleted.', 'success');
                } catch (e) {
                    showToast('Failed.', 'error');
                }
            });
        }

        function restoreFromTrash(key) {
            $('#contextMenu').addClass('hidden');
            trashedItems = trashedItems.filter(t => t.key !== key);
            localStorage.setItem('trashedItems', JSON.stringify(trashedItems));
            showTrash();
            showToast('File restored.', 'success');
            if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
        }

        function showProgressModal(title, total) {
            $('#progressTitle').text(title);
            $('#progressModal').removeClass('hidden').addClass('flex');
            updateProgress(0, total, 'Starting...');
        }

        function updateProgress(current, total, status) {
            const pct = Math.round((current / total) * 100);
            $('#progressBar').css('width', `${pct}%`);
            $('#progressCount').text(`${current}/${total}`);
            $('#progressStatus').text(status);
        }

        function hideProgressModal() {
            $('#progressModal').addClass('hidden').removeClass('flex');
        }

        function showTrash() {
            const container = document.getElementById('recycle-bin-content');
            const header = document.getElementById('trash-list-header');
            container.innerHTML = '';
            if (currentTrashView === 'tiles') {
                container.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 p-4 custom-scrollbar bg-[#1e1e1e] flex-1 overflow-y-auto content-start';
                if (header) header.classList.add('hidden');
            } else {
                container.className = 'flex flex-col gap-0 custom-scrollbar bg-[#1e1e1e] flex-1 overflow-y-auto';
                if (header) header.classList.remove('hidden');
            }
            if (trashedItems.length === 0) {
                container.innerHTML = `<div class="col-span-full py-20 text-center text-gray-600 flex flex-col items-center justify-center h-full"><i class="fas fa-trash-can text-5xl mb-4 opacity-50"></i><p>Recycle Bin is empty</p></div>`;
                return;
            }
            trashedItems.forEach(item => {
                const name = item.key.split('/').pop();
                const date = new Date(item.trashedDate).toLocaleDateString();
                if (currentTrashView === 'tiles') {
                    const div = document.createElement('div');
                    div.className = 'file-item p-3 flex flex-col items-center group relative border border-transparent rounded hover:bg-[#2a2a2a] transition-all h-max';
                    div.innerHTML = `${getFileIconHTML(name)}<span class="text-xs text-center truncate w-full text-gray-300 group-hover:text-white mt-1">${name}</span><div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 rounded"><button class="w-8 h-8 flex items-center justify-center rounded-full bg-green-600 text-white hover:bg-green-500 shadow-lg transform hover:scale-110 transition-transform" onclick="event.stopPropagation(); restoreFromTrash('${item.key}')"><i class="fas fa-undo text-xs"></i></button><button class="w-8 h-8 flex items-center justify-center rounded-full bg-red-600 text-white hover:bg-red-500 shadow-lg transform hover:scale-110 transition-transform" onclick="event.stopPropagation(); deletePermanently('${item.fragment}', '${item.key}', 'file')"><i class="fas fa-times text-xs"></i></button></div>`;
                    div.oncontextmenu = (e) => showCtx(e, {
                        isTrash: true,
                        data: item
                    });
                    container.appendChild(div);
                } else {
                    const div = document.createElement('div');
                    div.className = 'grid grid-cols-[1fr_150px_100px] gap-2 px-4 py-2 hover:bg-[#2a2a2a] border-b border-[#333] group items-center text-xs text-gray-300 transition-colors';
                    div.innerHTML = `<div class="flex items-center gap-3 truncate">${getFileIconHTML(name, true)}<span class="truncate">${name}</span></div><div class="text-gray-500">${date}</div><div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button class="text-green-500 hover:text-white" onclick="event.stopPropagation(); restoreFromTrash('${item.key}')"><i class="fas fa-undo"></i></button><button class="text-red-500 hover:text-white" onclick="event.stopPropagation(); deletePermanently('${item.fragment}', '${item.key}', 'file')"><i class="fas fa-times"></i></button></div>`;
                    div.oncontextmenu = (e) => showCtx(e, {
                        isTrash: true,
                        data: item
                    });
                    container.appendChild(div);
                }
            });
        }

        function toggleStar(key) {
            if (starredItems.includes(key)) starredItems = starredItems.filter(k => k !== key);
            else starredItems.push(key);
            localStorage.setItem('starredItems', JSON.stringify(starredItems));
            showToast(starredItems.includes(key) ? 'Added to Important' : 'Removed from Important', 'success');
            if ($('#nav-starred').hasClass('active')) showStarredFiles();
            else if ($('#nav-my-files').hasClass('active')) renderObjects(getActiveObjectList());
        }

        // --- Uploads ---
        async function processZipUpload(files) {
            if (!files || files.length === 0) return;

            if (typeof JSZip === 'undefined') {
                showToast('JSZip library missing', 'error');
                return;
            }

            const zip = new JSZip();
            
            const pathInfo = files[0].entryPath || files[0].webkitRelativePath || '';
            const rootFolderName = pathInfo.split('/')[0] || 'folder_archive';
            
            showToast('Compressing folder...', 'info');
            showProgressModal('Compressing Folder', files.length);

            let processed = 0;
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    processed++;
                    updateProgress(processed, files.length, `Zipping ${file.name}...`);
                    
                    const filePath = file.entryPath || file.webkitRelativePath || file.name;
                    zip.file(filePath, file);
                }
                const content = await zip.generateAsync({ 
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    if(metadata.percent < 100) {
                         $('#progressBar').css('width', `${metadata.percent}%`);
                         $('#progressStatus').text(`Compressing: ${metadata.percent.toFixed(0)}%`);
                    }
                });

                const zipFile = new File([content], `${rootFolderName}.zip`, { type: "application/zip" });
                
                hideProgressModal();
                showToast('Folder compressed! Added to queue.', 'success');
                
                handleUploads([zipFile]);

            } catch (e) {
                console.error(e);
                hideProgressModal();
                showToast('Failed to zip folder', 'error');
            }
        }

        async function scanFiles(item, path = '') {
            if (item.isFile) {
                return new Promise(resolve => {
                    item.file(file => {
                        // Attach the full path for the zipper to use
                        file.entryPath = path + file.name;
                        resolve([file]);
                    });
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                let entries = [];

                // readEntries must be called repeatedly until empty
                const readEntries = async () => {
                    const result = await new Promise(resolve => dirReader.readEntries(resolve));
                    if (result.length === 0) return entries;
                    entries = entries.concat(result);
                    return readEntries();
                };

                const allEntries = await readEntries();
                const files = [];
                for (const entry of allEntries) {
                    files.push(...await scanFiles(entry, path + item.name + '/'));
                }
                return files;
            }
            return [];
        }

        async function handleUploads(files) {
            if (!files.length) return;
            WindowManager.open('uploads');
            Array.from(files).forEach(f => {
                const item = {
                    id: crypto.randomUUID(),
                    file: f,
                    fragment: activeFragment,
                    objectKey: currentPath + (f.webkitRelativePath || f.name),
                    controller: new AbortController()
                };
                uploadQueue.push(item);
                createUploadUI(item);
            });
            processUploadQueue();
        }

        function createUploadUI(item, append = false) {
            const container = document.getElementById('upload-items-container');
            const el = document.createElement('div');
            el.id = item.id || `upload-${crypto.randomUUID()}`;
            el.className = 'bg-[#1f1f1f] p-2 rounded border border-[#333] mb-1';
            let progressBar = `<div class="w-full bg-[#333] h-1 rounded-full overflow-hidden mb-1"><div class="progress-bar bg-blue-600 h-full w-0 transition-all"></div></div>`;
            let actions = item.isRecovery ? `<div class="flex gap-2 mt-1"><button class="text-[10px] bg-green-600 hover:bg-green-500 text-white px-2 py-0.5 rounded resume-btn">Resume</button><button class="text-[10px] bg-red-600 hover:bg-red-500 text-white px-2 py-0.5 rounded cancel-btn">Cancel</button></div>` : '';
            el.innerHTML = `<div class="flex justify-between mb-1 text-[10px]"><span class="font-medium text-gray-300 truncate w-24">${item.file.name}</span><span class="${item.isRecovery ? 'text-yellow-500' : 'text-gray-400'} status-text"><i class="far fa-clock mr-1"></i>${item.isRecovery ? 'Interrupted' : 'Pending'}</span></div>${item.isRecovery ? '' : progressBar}<div class="flex justify-end text-[9px] text-gray-500 details-text">${item.isRecovery ? '<span>Waiting...</span>' : '<span>-- MB/s</span><span>--</span>'}</div>${actions}`;
            if (item.isRecovery) {
                el.querySelector('.resume-btn').onclick = () => {
                    const inp = document.getElementById('resumeFileInput');
                    inp.dataset.uiId = item.id;
                    inp.dataset.sessionKey = item.sessionKey;
                    inp.click();
                };
                el.querySelector('.cancel-btn').onclick = () => {
                    localStorage.removeItem(item.sessionKey);
                    el.remove();
                };
            }
            append ? container.appendChild(el) : container.prepend(el);
        }

        let isProcessingQueue = false;
        async function processUploadQueue() {
            if (isProcessingQueue) return;
            isProcessingQueue = true;
            try {
                while (activeUploads < MAX_CONCURRENT_UPLOADS) {
                    const next = uploadQueue.find(i => !i.started && !i.completed && !i.failed);
                    if (!next) break;
                    activeUploads++;
                    next.started = true;

                    // UPDATED: Start upload
                    startUpload(next).finally(() => {
                        activeUploads--;
                        // We do not reset global speed here anymore.
                        processUploadQueue();
                    });
                    
                    // Throttling Start (Auth Limit 2/s)
                    // We pause 500ms between starting uploads to ensure we don't burst the auth/init limit
                    await new Promise(r => setTimeout(r, 500));
                }
            } finally {
                isProcessingQueue = false;
            }
        }
        async function startUpload(item) {
            let ui = document.getElementById(item.id);
            if (!ui) return;
            const statusText = ui.querySelector('.status-text');
            const progBar = ui.querySelector('.progress-bar');
            const detailsText = ui.querySelector('.details-text');

            const currentUsage = currentObjectList.reduce((acc, obj) => acc + Number(obj.size_bytes), 0);
            if (currentUsage + item.file.size > totalCapacity) {
                statusText.textContent = "Storage Full";
                statusText.className = "text-red-400 text-[10px]";
                detailsText.innerHTML = `<span class="text-red-400">Not enough space</span>`;
                item.failed = true;
                showToast(`Not enough storage to upload ${item.file.name}`, 'error');
                return;
            }

            const sessionKey = `upload-session-${item.file.name}-${item.file.size}-${item.file.lastModified}`;
            item.sessionKey = sessionKey; // Explicitly attach for tracking

            let uploadedBytes = 0,
                lastUploadedBytes = 0,
                lastUpdate = Date.now();
            
            // Initialize speed tracking for this item
            item.currentSpeed = 0;

            try {
                const fileSize = item.file.size;
                const chunkSize = fileSize < 100 * MB ? 2 * MB : fileSize < 500 * MB ? 5 * MB : fileSize < 1024 * MB ? 8 * MB : 16 * MB;
                const totalChunks = Math.ceil(fileSize / chunkSize);
                let file_id, chunkQueue = Array.from({
                    length: totalChunks
                }, (_, i) => i);

                const existing = localStorage.getItem(sessionKey);
                if (existing) {
                    const sess = JSON.parse(existing);
                    statusText.textContent = "Resuming...";
                    const statusRes = await fetch(`${serverLink}/v4/fragment/object/upload/status/${sess.file_id}`, {
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    if (statusRes.ok) {
                        const s = await statusRes.json();
                        file_id = sess.file_id;
                        const done = new Set(s.uploaded_chunks);
                        chunkQueue = chunkQueue.filter(i => !done.has(i));
                        uploadedBytes = done.size * chunkSize;
                        if (uploadedBytes > fileSize) uploadedBytes = fileSize;
                        lastUploadedBytes = uploadedBytes;
                    } else {
                        localStorage.removeItem(sessionKey);
                    }
                }

                if (!file_id) {
                    statusText.textContent = "Initializing...";
                    const init = await fetch(`${serverLink}/v4/fragment/object/upload/init/${item.fragment}/${item.objectKey}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            content_type: item.file.type || 'application/octet-stream',
                            total_size_bytes: fileSize,
                            total_chunks: totalChunks
                        })
                    });
                    if (!init.ok) throw new Error();
                    const res = await init.json();
                    file_id = res.file_id;
                    localStorage.setItem(sessionKey, JSON.stringify({
                        file_id,
                        name: item.file.name,
                        size: fileSize,
                        lastModified: item.file.lastModified,
                        objectKey: item.objectKey,
                        fragment: item.fragment
                    }));
                }

                statusText.textContent = "Uploading...";
                const buffer = [],
                    maxBuffer = 4,
                    // UPDATED: maxWorkers increased to take advantage of HTTP/2 multiplexing
                    maxWorkers = 24; 
                    
                let hashingDone = false;

                const producer = async () => {
                    for (const idx of chunkQueue) {
                        while (buffer.length >= maxBuffer) await new Promise(r => setTimeout(r, 50));
                        const blob = item.file.slice(idx * chunkSize, Math.min((idx + 1) * chunkSize, fileSize));
                        const hashBuf = await crypto.subtle.digest('SHA-256', await blob.arrayBuffer());
                        buffer.push({
                            index: idx,
                            blob,
                            hash: btoa(String.fromCharCode(...new Uint8Array(hashBuf)))
                        });
                    }
                    hashingDone = true;
                };
                const worker = async () => {
                    while (true) {
                        const chunk = buffer.shift();
                        if (!chunk) {
                            if (hashingDone) break;
                            await new Promise(r => setTimeout(r, 20));
                            continue;
                        }
                        try {
                            const res = await fetch(`${serverLink}/v4/fragment/object/upload/chunk/raw/${file_id}/${chunk.index}`, {
                                method: 'PUT',
                                headers: {
                                    authorization: `Bearer ${token}`,
                                    'Content-Type': 'application/octet-stream',
                                    'Digest': `sha-256=${chunk.hash}`,
                                    'Buffer': `memory-size=${chunkSize}`
                                },
                                body: chunk.blob,
                                signal: item.controller.signal
                            });

                            if (!res.ok) {
                                throw new Error(`Server returned status ${res.status}`);
                            }

                            uploadedBytes += chunk.blob.size;
                            const now = Date.now();
                            if (now - lastUpdate > 500) {
                                const speed = (uploadedBytes - lastUploadedBytes) / ((now - lastUpdate) / 1000);
                                
                                // Store speed on item instead of global
                                item.currentSpeed = speed;

                                const eta = speed > 0 ? (fileSize - uploadedBytes) / speed : 0;
                                progBar.style.width = `${Math.min(100, (uploadedBytes / fileSize) * 100)}%`;
                                statusText.textContent = `${Math.round((uploadedBytes / fileSize) * 100)}%`;
                                detailsText.innerHTML = `<span class="mr-2">${formatBytes(speed)}/s</span><span>ETA: ${formatTime(eta)}</span>`;
                                lastUpdate = now;
                                lastUploadedBytes = uploadedBytes;
                            }
                        } catch (e) {
                            // Rate limit handling (Retry)
                            buffer.unshift(chunk);
                            // Add slight jitter to prevent thundering herd
                            const jitter = Math.random() * 500; 
                            await new Promise(r => setTimeout(r, 1000 + jitter));
                        }
                    }
                };

                await new Promise((resolve, reject) => {
                    producer().catch(reject);
                    const workers = [];
                    for (let i = 0; i < maxWorkers; i++) workers.push(worker());
                    Promise.all(workers).then(resolve).catch(reject);
                });

                statusText.textContent = "Finalizing...";
                await fetch(`${serverLink}/v4/fragment/object/upload/finalize/${file_id}`, {
                    method: 'POST',
                    headers: {
                        authorization: `Bearer ${token}`
                    }
                });
                statusText.textContent = "Complete";
                statusText.className = "text-green-400 text-[10px]";
                progBar.classList.replace('bg-blue-600', 'bg-green-500');
                progBar.style.width = '100%';
                item.completed = true;
                item.currentSpeed = 0; // Reset speed on completion
                localStorage.removeItem(sessionKey);
                listObjects(activeFragment);

            } catch (e) {
                console.error(e);
                statusText.textContent = "Failed";
                statusText.className = "text-red-400 text-[10px]";
                item.failed = true;
                item.currentSpeed = 0; // Reset speed on failure
                detailsText.innerHTML = `<button class="text-blue-400 mr-2" onclick="retryUpload('${item.id}')">Retry</button><button class="text-red-400" onclick="cancelUpload('${item.id}')">Cancel</button>`;
            }
        }
        window.retryUpload = (id) => {
            const item = uploadQueue.find(u => u.id === id);
            if (item) {
                item.failed = false;
                item.started = false;
                const ui = document.getElementById(id);
                ui.querySelector('.status-text').className = "text-blue-400 status-text";
                ui.querySelector('.status-text').textContent = "Retrying...";
                processUploadQueue();
            }
        };
        window.cancelUpload = (id) => {
            const item = uploadQueue.find(u => u.id === id);
            if (item) {
                item.controller.abort();
                localStorage.removeItem(`upload-session-${item.file.name}-${item.file.size}-${item.file.lastModified}`);
                uploadQueue = uploadQueue.filter(u => u.id !== id);
                document.getElementById(id).remove();
                activeUploads--;
                processUploadQueue();
            }
        };

        function checkForInterruptedUploads() {
            for (let i = 0; i < localStorage.length; i++) {
                const k = localStorage.key(i);
                if (k.startsWith('upload-session-')) {
                    const d = JSON.parse(localStorage.getItem(k));
                    
                    // Generate ID deterministically
                    const elId = `recovery-${k.replace(/[^a-zA-Z0-9]/g, '')}`;

                    // CHECK: Ensure item is not already in queue (being uploaded) AND UI element doesn't already exist
                    if (!uploadQueue.some(u => u.sessionKey === k) && !document.getElementById(elId)) { 
                        createUploadUI({
                            id: elId,
                            sessionKey: k,
                            file: {
                                name: d.name,
                                size: d.size
                            },
                            isRecovery: true,
                            status: 'interrupted',
                            objectKey: d.objectKey
                        }, true);
                    }
                }
            }
            if (document.querySelectorAll('#upload-items-container > div').length > 0) WindowManager.addTaskbarItem('uploads');
        }

        // --- Init ---
        $(document).ready(() => {
            VirtualScroller.init('browser', 'objectList');
            const logoutBtn = document.getElementById("user-profile-btn");
            if (logoutBtn) logoutBtn.addEventListener("click", () => {
                const modal = document.createElement("div");
                modal.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[7000]";
                modal.innerHTML = `<div class="bg-[#242424]/95 p-6 rounded-xl shadow-2xl w-80 border border-[#383838]"><h2 class="text-white font-medium mb-2">Confirm Logout</h2><div class="flex justify-end gap-3 mt-4"><button class="px-4 py-2 rounded-lg bg-[#333] hover:bg-[#444] text-gray-200 text-xs" onclick="this.closest('.fixed').remove()">Cancel</button><button class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white text-xs" onclick="localStorage.removeItem('current-account-email'); localStorage.removeItem('current-token'); localStorage.removeItem('current-account-uid'); localStorage.removeItem('current-account-name'); localStorage.removeItem('current-capacity'); window.location.href='../';">Logout</button></div></div>`;
                document.body.appendChild(modal);
            });

            // Drag Drop
            const dz = document.getElementById('browser');
            let dc = 0;

            dz.addEventListener('dragover', (e) => e.preventDefault());
            dz.addEventListener('dragenter', (e) => {
                dc++;
                dz.classList.add('drag-active');
            });
            dz.addEventListener('dragleave', (e) => {
                dc--;
                if (dc === 0) dz.classList.remove('drag-active');
            });

            dz.addEventListener('drop', async (e) => {
                e.preventDefault();
                dc = 0;
                dz.classList.remove('drag-active');

                const items = e.dataTransfer.items;
                const files = [];
                let hasFolder = false;

                if (items) {
                    for (let i = 0; i < items.length; i++) {
                        const entry = items[i].webkitGetAsEntry ? items[i].webkitGetAsEntry() : null;
                        if (entry) {
                            if (entry.isDirectory) hasFolder = true;
                            files.push(...await scanFiles(entry));
                        } else {
                            // Fallback for items that aren't entries
                            const f = items[i].getAsFile();
                            if (f) files.push(f);
                        }
                    }
                } else {
                    // Fallback for older browsers
                    files.push(...e.dataTransfer.files);
                }

                if (files.length > 0) {
                    if (hasFolder) {
                        // If we detected a folder, ZIP IT
                        processZipUpload(files);
                    } else {
                        // Otherwise, normal upload
                        handleUploads(files);
                    }
                }
            });

            // --- Paste Handler (Standard) ---
            $(document).on('paste', (e) => {
                const cd = e.originalEvent.clipboardData;
                if (!cd) return;
                
                const files = [];
                const uniqueFiles = new Set();
                let potentialFolders = 0;

                const addFile = (f) => {
                    if (!uniqueFiles.has(f.name + f.size)) {
                        files.push(f);
                        uniqueFiles.add(f.name + f.size);
                    }
                };
                if (cd.items) {
                    for (let i = 0; i < cd.items.length; i++) {
                        const item = cd.items[i];
                        if (item.kind !== 'file') continue;

                        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
                        if (entry && entry.isDirectory) {
                            potentialFolders++;
                            continue;
                        }

                        const f = item.getAsFile();
                        if (f) {
                            if (f.size === 0) {
                                potentialFolders++;
                            } else {
                                addFile(f);
                            }
                        }
                    }
                }
                // 2. Fallback Method: 'files' list (older browsers)
                else if (cd.files) {
                    for (let i = 0; i < cd.files.length; i++) {
                        const f = cd.files[i];
                        if (f.size === 0) potentialFolders++;
                        else addFile(f);
                    }
                }

                if ($('#win-file-explorer').is(':visible')) {
                    if (files.length > 0) {
                        e.preventDefault();
                        handleUploads(files);
                    }
                    
                    // Show error if we detected folders (and nothing valid was pasted)
                    if (potentialFolders > 0 && files.length === 0) {
                        showToast('Cannot paste folders. Please use Drag & Drop to zip/upload folders.', 'error');
                    }
                }
            });
            $(".window").draggable({
                handle: ".window-header",
                containment: "#windows-container",
                start: function () {
                    WindowManager.focus($(this).attr('id').replace('win-', ''));
                }
            }).resizable({
                minHeight: 200,
                minWidth: 300
            });
            $(".window").on('mousedown', function () {
                WindowManager.focus($(this).attr('id').replace('win-', ''));
            });
            $(document).on('click', (e) => {
                if (!$(e.target).closest('#contextMenu').length) $('#contextMenu').addClass('hidden');
            });
            $('#folderInput').off('change');
            $('#browser').off('contextmenu');

            $('#folderInput').change((e) => {
                processZipUpload(e.target.files);
                e.target.value = ''; // Reset input
            });

            $('#browser').on('contextmenu', (e) => {
                if ($(e.target).closest('.file-item').length) return;

                e.preventDefault();
                e.stopPropagation();

                const menu = $('#contextMenu');
                let x = e.clientX,
                    y = e.clientY;

                if (x + 200 > window.innerWidth) x -= 200;
                if (y + 200 > window.innerHeight) y -= 200;

                const html = `
                    <div class="ctx-item" onclick="document.getElementById('newFolderBtnAction').click()"><i class="fas fa-folder-plus w-4"></i> New Folder</div>
                    <div class="ctx-item" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload w-4"></i> Upload File</div>
                    <div class="ctx-item" onclick="document.getElementById('folderInput').click()"><i class="fas fa-file-zipper w-4"></i> Upload Folder as Zip</div>
                    <div class="ctx-div"></div>
                    <div class="ctx-item" onclick="listObjects(activeFragment)"><i class="fas fa-sync-alt w-4"></i> Refresh</div>
                `;

                menu.html(html).css({
                    top: y,
                    left: x
                }).removeClass('hidden');
            });

            // Clear selection when clicking on empty space
            $('#browser').on('click', (e) => {
                if (e.target === e.currentTarget || e.target.id === 'objectList') {
                    SelectionManager.clear();
                }
            });

            // Selection Box (Marquee)
            const marquee = document.getElementById('selection-marquee');
            let isSelecting = false,
                startX, startY;

            $('#browser').on('mousedown', (e) => {
                if (e.target !== e.currentTarget && e.target.id !== 'objectList') return;
                if (e.which !== 1) return; // Only left click
                isSelecting = true;
                startX = e.pageX;
                startY = e.pageY;
                marquee.style.left = startX + 'px';
                marquee.style.top = startY + 'px';
                marquee.style.width = '0px';
                marquee.style.height = '0px';
                marquee.style.display = 'block';
                SelectionManager.clear();
            });

            $(document).on('mousemove', (e) => {
                if (!isSelecting) return;
                const currentX = e.pageX;
                const currentY = e.pageY;
                const width = Math.abs(currentX - startX);
                const height = Math.abs(currentY - startY);
                const left = Math.min(currentX, startX);
                const top = Math.min(currentY, startY);
                marquee.style.width = width + 'px';
                marquee.style.height = height + 'px';
                marquee.style.left = left + 'px';
                marquee.style.top = top + 'px';

                // Hit Test
                const items = document.querySelectorAll('.file-item');
                const mRect = marquee.getBoundingClientRect();

                items.forEach(item => {
                    const iRect = item.getBoundingClientRect();
                    if (mRect.left < iRect.right && mRect.right > iRect.left && mRect.top < iRect.bottom && mRect.bottom > iRect.top) {
                        if (!SelectionManager.selectedItems.has(item.dataset.id)) SelectionManager.toggle(item.dataset.id);
                    }
                });
            });

            $(document).on('mouseup', () => {
                if (isSelecting) {
                    isSelecting = false;
                    marquee.style.display = 'none';
                }
            });


            setTimeout(() => {
                $('#boot-screen').css('opacity', 0);
                setTimeout(() => $('#boot-screen').remove(), 600);
            }, 1200);
            $('#fileInput').change((e) => handleUploads(e.target.files));
            $('#searchInput').on('input', function () {
                const v = $(this).val().toLowerCase();
                if (!v) {
                    renderObjects(getActiveObjectList());
                    return;
                }
                $('#breadcrumb').html('<span class="text-blue-400">Search Results</span>');
                const flat = getActiveObjectList().filter(o => o.key.toLowerCase().includes(v));
                VirtualScroller.setItems(flat.map(i => ({
                    type: 'file',
                    data: i,
                    id: `file:${i.key}`
                })), 'list');
            });

            $('#resumeFileInput').change((e) => {
                const f = e.target.files[0],
                    sKey = e.target.dataset.sessionKey,
                    uiId = e.target.dataset.uiId;
                if (f && sKey) {
                    const d = JSON.parse(localStorage.getItem(sKey));
                    if (f.name === d.name && f.size === d.size && f.lastModified === d.lastModified) {
                        document.getElementById(uiId).remove();
                        const item = {
                            id: crypto.randomUUID(),
                            file: f,
                            fragment: d.fragment,
                            objectKey: d.objectKey,
                            controller: new AbortController(),
                            sessionKey: sKey // Ensure sessionKey is tracked
                        };
                        uploadQueue.push(item);
                        createUploadUI(item);
                        processUploadQueue();
                        showToast(`Resuming ${f.name}`, 'success');
                    } else showToast('Incorrect file.', 'error');
                }
                e.target.value = '';
            });

            $('#empty-trash-btn').click(emptyTrash);
            $('#restore-all-btn').click(restoreAll);
            $('#trash-tiles-btn').click(function () {
                currentTrashView = 'tiles';
                showTrash();
            });
            $('#trash-list-btn').click(function () {
                currentTrashView = 'list';
                showTrash();
            });
            $('#tiles-view-btn').click(function () {
                currentView = 'tiles';
                renderObjects(getActiveObjectList());
            });
            $('#list-view-btn').click(function () {
                currentView = 'list';
                renderObjects(getActiveObjectList());
            });

            async function loadFragments() {
                const list = $('#fragmentList').empty();
                try {
                    const res = await fetch(`${serverLink}/v4/fragment/metadata`, {
                        headers: {
                            authorization: `Bearer ${token}`
                        }
                    });
                    if (res.ok) (await res.json()).forEach(pushFrag);
                } catch (e) { }
                clientSideFragments.forEach(pushFrag);

                function pushFrag(f) {
                    if (document.getElementById(`frag-${f}`)) return;
                    const el = $(`<div id="frag-${f}" class="nav-item fragment-item"><i class="fas fa-database w-4 text-center"></i> ${f}</div>`).click(function () {
                        $('#fragmentList .fragment-item').removeClass('active');
                        $(this).addClass('active');
                        activeFragment = f;
                        currentPath = '';
                        AppNav.navigate('my-files');
                        listObjects(f);
                    });
                    if (activeFragment === f) el.addClass('active');
                    list.append(el);
                }
                if (!activeFragment && list.children().length) list.children().first().click();
                else if (activeFragment) listObjects(activeFragment);
            }
            loadFragments();
            checkForInterruptedUploads();

            // Folder & Fragment Modals
            $('#newFolderBtnAction').click(() => {
                $('#newFolderNameInput').val('');
                $('#newFolderModal').removeClass('hidden').addClass('flex');
                setTimeout(() => $('#newFolderNameInput').focus(), 50);
            });
            $('#cancelNewFolderBtn').click(() => $('#newFolderModal').addClass('hidden').removeClass('flex'));
            $('#confirmNewFolderBtn').click(() => {
                const n = $('#newFolderNameInput').val().trim();
                if (n) {
                    clientSideFolders.push({
                        name: n,
                        path: currentPath,
                        fragment: activeFragment
                    });
                    $('#newFolderModal').addClass('hidden').removeClass('flex');
                    renderObjects(getActiveObjectList());
                    showToast('Folder created', 'success');
                }
            });

            $('#addFragmentBtn').click(() => {
                $('#newFragmentNameInput').val('');
                $('#newFragmentModal').removeClass('hidden').addClass('flex');
                setTimeout(() => $('#newFragmentNameInput').focus(), 50);
            });
            $('#cancelNewFragmentBtn').click(() => $('#newFragmentModal').addClass('hidden').removeClass('flex'));
            $('#confirmNewFragmentBtn').click(() => {
                const n = $('#newFragmentNameInput').val().trim();
                if (n && !clientSideFragments.includes(n)) {
                    clientSideFragments.push(n);
                    showToast(`Mount '${n}' created`, 'success');
                    loadFragments();
                }
                $('#newFragmentModal').addClass('hidden').removeClass('flex');
            });

            setInterval(() => $('#clock').text(new Date().toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            })), 1000);
        });
    </script>
</body>

</html>