<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Litiaina - Login</title>
  <link rel="icon" type="image/png" href="images/litiaina_icon.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html {
      background-color: #000;
    }

    body {
      visibility: hidden;
      font-family: 'Inter', sans-serif;
    }

    .modal-enter {
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="bg-black text-white flex flex-col items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-md">
    <div class="text-center mb-8">
      <div class="mx-auto bg-gray-800 h-20 w-20 rounded-full flex items-center justify-center mb-4">
        <img src="images/litiaina_icon.png" alt="https://placehold.co/60x60/374151/FFFFFF?text=Logo" class="rounded-full">
      </div>
      <h1 class="text-3xl font-bold text-white">Welcome Back!</h1>
      <p class="text-gray-400 mt-2">Login to access your account</p>
    </div>

    <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 md:p-8">
      <form id="loginForm" class="space-y-6">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
              fill="currentColor">
              <path
                d="M2.003 5.884L10 2.5l7.997 3.384A2 2 0 0119 7.616V16a2 2 0 01-2 2H3a2 2 0 01-2-2V7.616a2 2 0 011.003-1.732zM10 13a3 3 0 100-6 3 3 0 000 6z" />
            </svg>
          </div>
          <input type="email" id="loginEmail" placeholder="Email" required
            class="w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200" />
        </div>

        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
              fill="currentColor">
              <path fill-rule="evenodd"
                d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z"
                clip-rule="evenodd" />
            </svg>
          </div>
          <input type="password" id="loginPassword" placeholder="Password" required
            class="w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200" />
        </div>

        <div class="relative hidden" id="otpGroup">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
              stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z" />
            </svg>
          </div>
          <input type="text" id="loginOtp" placeholder="Enter OTP"
            class="w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 transition duration-200" />
        </div>

        <div class="text-right">
          <span id="forgotPassword" class="text-sm text-red-400 hover:text-red-300 cursor-pointer">Forgot
            password?</span>
        </div>

        <button type="submit" id="authBtn"
          class="w-full flex items-center justify-center bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 disabled:bg-red-400 disabled:cursor-not-allowed">
          <span id="btnText">LOGIN</span>
          <svg id="btnSpinner" class="animate-spin h-5 w-5 text-white ml-3 hidden" xmlns="http://www.w3.org/2000/svg"
            fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
        </button>

        <div class="text-center text-gray-400">
          Don't have an account?
          <span id="signup" class="font-semibold text-red-400 hover:text-red-300 cursor-pointer">
            Sign Up
          </span>
        </div>
      </form>
    </div>
  </div>

  <div id="modalContainer"
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
    <div id="modal"
      class="modal-enter w-full max-w-sm bg-gray-900 border border-gray-800 rounded-2xl shadow-lg p-6 text-center">
      <h3 id="modalTitle" class="text-xl font-bold mb-3">Modal Title</h3>
      <p id="modalMessage" class="text-gray-300 mb-6">This is a sample message.</p>
      <button id="modalCloseBtn"
        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-4 rounded-lg transition duration-200">
        CLOSE
      </button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.body.style.visibility = 'visible';

      const serverLink = `https://api.litiaina.com`;
      const loginForm = document.getElementById('loginForm');
      const otpGroup = document.getElementById('otpGroup');
      const otpInput = document.getElementById('loginOtp');
      const authBtn = document.getElementById('authBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      const modalContainer = document.getElementById('modalContainer');
      const modalTitle = document.getElementById('modalTitle');
      const modalMessage = document.getElementById('modalMessage');
      const modalCloseBtn = document.getElementById('modalCloseBtn');
      const modal = document.getElementById('modal');

      const setLoading = (isLoading) => {
        authBtn.disabled = isLoading;
        if (isLoading) {
          btnText.classList.add('hidden');
          btnSpinner.classList.remove('hidden');
        } else {
          btnText.classList.remove('hidden');
          btnSpinner.classList.add('hidden');
        }
      };

      const showModal = (title, message, isError = true) => {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalTitle.classList.remove('text-red-400', 'text-green-400');
        if (isError) {
          modalTitle.classList.add('text-red-400');
        } else {
          modalTitle.classList.add('text-green-400');
        }
        modalContainer.classList.remove('hidden');
      };

      const hideModal = () => {
        modalContainer.classList.add('hidden');
      };

      document.getElementById("signup").onclick = () => {
        window.location.href = "signup.html";
      };

      document.getElementById("forgotPassword").onclick = () => {
        showModal("Forgot Password", "Password recovery is not implemented yet. Please contact support if you need assistance.");
      };

      modalCloseBtn.addEventListener('click', hideModal);
      modalContainer.addEventListener('click', (e) => {
        if (e.target === modalContainer) {
          hideModal();
        }
      });

      loginForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        setLoading(true);

        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        const otp = otpInput.value.trim();

        if (!email || !password) {
          showModal("Validation Error", "Please fill in both email and password fields.");
          setLoading(false);
          return;
        }

        try {
          let otpRequired = false;
          try {
            const twoFaCheckResponse = await fetch(`${serverLink}/auth/account/2fa`, {
              method: 'POST',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password })
            });
            if (twoFaCheckResponse.ok) {
              const result = await twoFaCheckResponse.json();
              otpRequired = result.enabled === true;
            }
          } catch (checkError) {
            console.warn("2FA check failed, proceeding without it.", checkError);
          }

          if (otpRequired) {
            otpGroup.classList.remove('hidden');
            if (!otp) {
              showModal("Authentication Required", "This account has 2FA enabled. Please enter your OTP to continue.");
              setLoading(false);
              return;
            }
          }

          const loginPayload = { email, password, otp: otp || "" };
          const loginResponse = await fetch(`${serverLink}/auth/login`, {
            method: 'POST',
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(loginPayload)
          });

          const loginResult = await loginResponse.json();

          if (!loginResponse.ok || !loginResult.response) {
            const errorMessage = loginResult.message || "Email, password, or OTP is incorrect.";
            throw new Error(errorMessage);
          }

          const token = loginResult.token;
          const accountResponse = await fetch(`${serverLink}/auth/account`, {
            method: 'POST',
            headers: {
              "Content-Type": "application/json",
              "authorization": `Bearer ${token}`,
            },
            body: JSON.stringify({ email })
          });

          if (!accountResponse.ok) {
            throw new Error("Could not retrieve account details after login.");
          }

          const accountDetails = await accountResponse.json();

          localStorage.setItem("current-account-email", email);
          localStorage.setItem("current-token", token);
          localStorage.setItem("current-account-uid", accountDetails.uid);
          localStorage.setItem("current-account-name", accountDetails.name);
          localStorage.setItem("current-capacity", accountDetails.allocated_storage);

          showModal("Login Successful!", "You will be redirected to your storage.", false);

          setTimeout(() => {
            window.location.href = "N1.html";
          }, 1000);

        } catch (err) {
          showModal("Login Failed", err.message || "An unknown error occurred. Please try again.");
        } finally {
          setLoading(false);
        }
      });
    });
  </script>
</body>

</html>