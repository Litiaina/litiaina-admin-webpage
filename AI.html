<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Litiaina Assistant</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Libraries for Markdown and Syntax Highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />

    <style>
        /* --- Base Styles & Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0D0D0D;
        }

        #user-input {
            resize: none;
        }

        /* --- Custom Scrollbar Styling (General) --- */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1A1A1A;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6B7280;
        }

        /* --- Sleek Scrollbar for Textarea and Thinking Box --- */
        #user-input::-webkit-scrollbar,
        .thinking-details pre::-webkit-scrollbar,
        .table-responsive-wrapper::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }

        #user-input::-webkit-scrollbar-track,
        .thinking-details pre::-webkit-scrollbar-track,
        .table-responsive-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        #user-input::-webkit-scrollbar-thumb,
        .thinking-details pre::-webkit-scrollbar-thumb,
        .table-responsive-wrapper::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 10px;
        }

        #user-input::-webkit-scrollbar-thumb:hover,
        .thinking-details pre::-webkit-scrollbar-thumb:hover,
        .table-responsive-wrapper::-webkit-scrollbar-thumb:hover {
            background: #777;
        }

        /* --- Styles for Code Blocks (Extendable) --- */
        .code-block-wrapper pre {
            margin-top: 0 !important;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top: none;
        }

        pre {
            background-color: #161616;
            padding: 1rem;
            border-radius: 10px;
            overflow: auto;
            font-size: 0.9rem;
            white-space: pre;
            line-height: 1.5;
            border: 1px solid #3a3a3a;
        }

        code.hljs {
            background: transparent;
        }

        /* --- Animation for incoming messages --- */
        @keyframes message-in {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-in {
            animation: message-in 0.4s ease-out forwards;
        }

        /* --- Improved Styles for Markdown Content --- */
        .bubble-content {
            line-height: 1.6;
        }

        /* Universal selector for consistent spacing between elements */
        .bubble-content>*+* {
            margin-top: 1rem;
        }

        .bubble-content ul,
        .bubble-content ol {
            padding-left: 1.5rem;
        }

        .bubble-content ul {
            list-style-type: disc;
        }

        .bubble-content ol {
            list-style-type: decimal;
        }

        .bubble-content li::marker {
            color: #9CA3AF;
        }


        .bubble-content li {
            margin-bottom: 0.5rem;
            padding-left: 0.5rem;
        }

        .bubble-content blockquote {
            border-left: 4px solid #B91C1C;
            padding-left: 1rem;
            color: #a0aec0;
        }

        .bubble-content a {
            color: #F87171;
            text-decoration: underline;
        }

        .bubble-content a:hover {
            color: #EF4444;
        }

        .bubble-content strong {
            color: #F3F4F6;
        }

        .bubble-content hr {
            border: none;
            height: 1px;
            background-color: #3a3a3a;
        }

        /* --- Responsive Table Wrapper --- */
        .table-responsive-wrapper {
            overflow-x: auto;
        }

        /* --- Table Styling --- */
        .bubble-content table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #3a3a3a;
        }

        .bubble-content th,
        .bubble-content td {
            border: 1px solid #3a3a3a;
            padding: 0.75rem 1rem;
            text-align: left;
        }

        .bubble-content th {
            background-color: #2a2b2e;
            color: #F3F4F6;
            font-weight: 600;
        }

        .bubble-content tr:nth-child(even) {
            background-color: #161616;
        }

        /* --- Dropdown Menu --- */
        .dropdown-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-[#0D0D0D] text-gray-200 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="bg-[#1A1A1A] w-64 p-4 flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30 custom-scrollbar overflow-y-auto hidden md:flex">
        <button id="new-chat-btn"
            class="flex items-center justify-between w-full bg-[#262626] hover:bg-[#333333] text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 active:scale-95 border border-gray-600">
            <span>New Chat</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd"
                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                    clip-rule="evenodd" />
            </svg>
        </button>
        <div class="mt-8">
            <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Recent</h2>
        </div>
        <div class="mt-auto pt-4 border-t border-gray-700">
            <a href="#"
                class="flex items-center p-2 text-sm text-gray-300 rounded-lg hover:bg-gray-700/50 transition-colors duration-200">
                <img class="h-8 w-8 rounded-full object-cover mr-3"
                    src="https://placehold.co/100x100/DC2626/ffffff?text=U" alt="User Avatar"
                    onerror="this.onerror=null;this.src='https://placehold.co/100x100/DC2626/ffffff?text=U';">
                <span id="user-name">Guess</span>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col relative overflow-hidden">
        <header class="flex items-center justify-between p-4 border-b border-gray-800 shrink-0">
            <button id="menu-button" class="md:hidden text-gray-400 hover:text-white"><svg
                    xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg></button>
            <div class="relative">
                <button id="model-dropdown-btn" class="flex items-center gap-2 text-lg font-semibold">
                    <span id="selected-model-name">Light</span>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                        class="text-gray-500 transition-transform">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="model-dropdown-content"
                    class="dropdown-content absolute top-full left-0 mt-2 w-48 bg-[#1A1A1A] border border-gray-700 rounded-lg shadow-xl z-10">
                    <a href="#" class="model-option block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700/50"
                        data-model="Light" data-url="https://ai.litiaina.com/v2/api/stream/chat">Light (Default)</a>
                    <a href="#" class="model-option block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700/50"
                        data-model="Line" data-url="https://ai.litiaina.com/v1/api/stream/chat">Line</a>
                </div>
            </div>
            <div id="cancel-btn-container" class="h-10"></div>
        </header>

        <div id="chat-scroll-area" class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
            <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center">
                <div class="relative w-20 h-20 mb-4">
                    <div class="absolute inset-0 bg-red-600 rounded-3xl blur-lg opacity-30"></div>
                    <img src="https://placehold.co/100x100/B91C1C/ffffff?text=AI" alt="Line AI Logo"
                        class="relative w-20 h-20 rounded-3xl"
                        onerror="this.onerror=null;this.src='https://placehold.co/100x100/B91C1C/ffffff?text=AI';">
                </div>
                <h2 class="text-2xl font-bold text-gray-200">How can I help you today?</h2>
                <div class="mt-6 flex flex-wrap justify-center gap-3">
                    <button class="suggestion-chip">Explain quantum computing</button>
                    <button class="suggestion-chip">Write a python script for a web scraper</button>
                    <button class="suggestion-chip">Create a workout plan</button>
                </div>
            </div>
            <div id="chat" class="max-w-3xl mx-auto w-full space-y-6 hidden"></div>
        </div>

        <div class="p-4 md:p-6 bg-[#0D0D0D] border-t border-gray-800 shrink-0">
            <div class="max-w-3xl mx-auto">
                <form id="chat-form" class="relative">
                    <textarea id="user-input"
                        class="w-full bg-[#1A1A1A] border border-gray-700 rounded-lg text-gray-200 p-4 pr-16 focus:outline-none focus:ring-2 focus:ring-red-500 transition-shadow duration-200"
                        placeholder="Enter a prompt here..." rows="1"></textarea>
                    <button type="submit" id="send-btn"
                        class="absolute right-3 top-1/2 -translate-y-1/2 p-2 bg-[#2a2b2e] rounded-full text-gray-400 hover:bg-red-600 hover:text-white transition-all duration-200 disabled:bg-gray-700 disabled:cursor-not-allowed active:scale-90 flex items-center justify-center h-10 w-10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="19" x2="12" y2="5"></line>
                            <polyline points="5 12 12 5 19 12"></polyline>
                        </svg>
                    </button>
                </form>
                <p class="text-xs text-center text-gray-500 mt-2">Chat AI may display inaccurate info. Consider checking
                    important information.</p>
            </div>
        </div>

        <div id="overlay" class="fixed inset-0 bg-black/50 z-20 hidden md:hidden"></div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const menuButton = document.getElementById('menu-button'),
                sidebar = document.getElementById('sidebar'),
                overlay = document.getElementById('overlay'),
                chatForm = document.getElementById('chat-form'),
                chat = document.getElementById("chat"),
                chatScrollArea = document.getElementById('chat-scroll-area'),
                userInput = document.getElementById("user-input"),
                sendBtn = document.getElementById("send-btn"),
                newChatBtn = document.getElementById("new-chat-btn"),
                cancelBtnContainer = document.getElementById('cancel-btn-container'),
                welcomeScreen = document.getElementById('welcome-screen'),
                modelDropdownBtn = document.getElementById('model-dropdown-btn'),
                modelDropdownContent = document.getElementById('model-dropdown-content'),
                selectedModelName = document.getElementById('selected-model-name');

            // --- State and API variables ---
            const token = localStorage.getItem("current-token")?.trim() || "";
            const userName = localStorage.getItem("current-account-name")?.trim() || "User";
            const nameSpan = document.getElementById("user-name");
            nameSpan.textContent = userName;

            let messages = [],
                controller = null,
                isStreaming = false,
                selectedModelUrl = "https://ai.litiaina.com/v2/api/stream/chat"; // Default to Light

            // --- Mobile Sidebar Toggle ---
            const toggleSidebar = () => {
                sidebar.classList.toggle('-translate-x-full');
                sidebar.classList.toggle('hidden');
                overlay.classList.toggle('hidden');
            };
            menuButton.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            // --- Model Dropdown Toggle ---
            modelDropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = modelDropdownContent.style.display === 'none' || modelDropdownContent.style.display === '';
                modelDropdownContent.style.display = isHidden ? 'block' : 'none';
                modelDropdownBtn.querySelector('svg').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            });

            document.addEventListener('click', () => {
                modelDropdownContent.style.display = 'none';
                modelDropdownBtn.querySelector('svg').style.transform = 'rotate(0deg)';
            });

            // --- Model Selection ---
            modelDropdownContent.addEventListener('click', (e) => {
                e.preventDefault();
                const target = e.target.closest('.model-option');
                if (target) {
                    selectedModelUrl = target.dataset.url;
                    selectedModelName.textContent = target.dataset.model;
                    modelDropdownContent.style.display = 'none';
                    modelDropdownBtn.querySelector('svg').style.transform = 'rotate(0deg)';
                }
            });

            // --- Textarea Auto-Resize ---
            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto';
                userInput.style.height = `${Math.min(userInput.scrollHeight, 200)}px`;
            });

            const enhanceMarkup = (container) => {
                // Enhance Code Blocks
                container.querySelectorAll('pre').forEach(pre => {
                    if (pre.parentNode.classList.contains('code-block-wrapper')) return;

                    const code = pre.querySelector('code');
                    if (!code) return;

                    const language = [...code.classList].find(cls => cls.startsWith('language-'))?.replace('language-', '') || 'text';
                    const wrapper = document.createElement('div');
                    wrapper.className = 'code-block-wrapper';
                    const header = document.createElement('div');
                    header.className = 'flex items-center justify-between bg-[#2a2b2e] text-gray-400 text-xs px-4 py-2 rounded-t-lg border-b border-[#3a3a3a]';
                    const langSpan = document.createElement('span');
                    langSpan.textContent = language;
                    const copyButton = document.createElement('button');
                    copyButton.className = 'flex items-center gap-1.5 hover:text-white transition-colors';
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg><span>Copy</span>`;

                    copyButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const textToCopy = code.textContent;
                        try {
                            navigator.clipboard.writeText(textToCopy).then(() => {
                                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>`;
                            }).catch(err => {
                                copyButton.querySelector('span').textContent = 'Error';
                            });
                        } catch (err) {
                            const textArea = document.createElement("textarea");
                            textArea.value = textToCopy;
                            document.body.appendChild(textArea);
                            textArea.focus();
                            textArea.select();
                            try {
                                document.execCommand('copy');
                                copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><span>Copied!</span>`;
                            } catch (copyErr) {
                                copyButton.querySelector('span').textContent = 'Error';
                            }
                            document.body.removeChild(textArea);
                        }

                        setTimeout(() => {
                            copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg><span>Copy</span>`;
                        }, 2000);
                    });

                    header.appendChild(langSpan);
                    header.appendChild(copyButton);
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                });

                // Wrap Tables for horizontal scrolling
                container.querySelectorAll('table').forEach(table => {
                    if (table.parentNode.classList.contains('table-responsive-wrapper')) return;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'table-responsive-wrapper';
                    table.parentNode.insertBefore(wrapper, table);
                    wrapper.appendChild(table);
                });
            };

            // --- Message Handling ---
            const appendMessage = (role, content) => {
                const messageWrapper = document.createElement('div');
                messageWrapper.className = `flex items-start gap-4 message-in ${role === 'user' ? 'justify-end' : ''}`;

                const avatar = document.createElement('img');
                avatar.className = 'w-8 h-8 rounded-full object-cover mt-1 shrink-0';
                if (role === 'user') {
                    avatar.src = `https://placehold.co/100x100/DC2626/ffffff?text=${userName.charAt(0).toUpperCase()}`;
                    avatar.onerror = function () { this.src = 'https://placehold.co/100x100/cccccc/333333?text=U'; this.onerror = null; };
                } else {
                    avatar.src = 'https://placehold.co/100x100/B91C1C/ffffff?text=AI';
                    avatar.onerror = function () { this.src = 'https://placehold.co/100x100/B91C1C/ffffff?text=AI'; this.onerror = null; };
                }

                const messageBubble = document.createElement('div');
                messageBubble.className = `message-bubble min-w-0 ${role === 'user' ? 'max-w-2xl' : 'flex-1 max-w-full'}`;

                const bubbleContent = document.createElement('div');
                bubbleContent.className = `bubble-content p-4 rounded-xl ${role === 'user' ? 'bg-[#262626] text-white rounded-br-none' : 'bg-[#1C1C1C] text-gray-200 rounded-bl-none'}`;

                bubbleContent.innerHTML = marked.parse(content);

                bubbleContent.querySelectorAll("pre code").forEach(el => hljs.highlightElement(el));
                enhanceMarkup(bubbleContent);

                messageBubble.appendChild(bubbleContent);

                if (role === 'user') {
                    messageWrapper.appendChild(messageBubble);
                    messageWrapper.appendChild(avatar);
                } else {
                    messageWrapper.appendChild(avatar);
                    messageWrapper.appendChild(messageBubble);
                }

                chat.appendChild(messageWrapper);
                chatScrollArea.scrollTop = chatScrollArea.scrollHeight;
                return bubbleContent;
            };

            const createProgressIndicator = () => {
                const wrapper = document.createElement("div");
                wrapper.className = 'flex items-start gap-4 message-in';

                const avatar = document.createElement('img');
                avatar.className = 'w-8 h-8 rounded-full object-cover mt-1 shrink-0';
                avatar.src = 'https://placehold.co/100x100/B91C1C/ffffff?text=AI';
                avatar.onerror = function () { this.src = 'https://placehold.co/100x100/B91C1C/ffffff?text=AI'; this.onerror = null; };

                const container = document.createElement("div");
                container.className = 'progress-indicator-container flex-1 min-w-0 p-4 bg-[#1C1C1C] rounded-xl shadow-lg';

                // Initial "Analyzing" state
                container.innerHTML = `<div class="flex items-center gap-2 text-sm text-gray-400"><span>Analyzing...</span></div>`;

                wrapper.appendChild(avatar);
                wrapper.appendChild(container);
                chat.appendChild(wrapper);
                chatScrollArea.scrollTop = chatScrollArea.scrollHeight;

                let detailsContent = null;

                const switchToThinkingState = () => {
                    if (container.querySelector('.thinking-header')) return; // Already switched

                    container.innerHTML = `
                        <div class="thinking-header flex items-center justify-between text-gray-400">
                            <div class="flex items-center gap-2 text-sm">
                                <div class="w-4 h-4 border-2 border-gray-600 border-t-red-500 rounded-full animate-spin"></div>
                                <span>Thinking...</span>
                            </div>
                            <button class="toggle-work-btn text-xs text-gray-400 hover:text-white transition-colors p-1 flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg> 
                                <span>Show work</span>
                            </button>
                        </div>`;

                    detailsContent = document.createElement('div');
                    detailsContent.className = 'thinking-details hidden bg-[#0D0D0D] p-3 rounded-md border border-gray-700 mt-3';
                    detailsContent.innerHTML = '<pre class="!p-0 !bg-transparent !border-none max-h-32 custom-scrollbar" style="white-space: pre-wrap; overflow-wrap: break-word;"><code class="language-text"></code></pre>';
                    container.appendChild(detailsContent);

                    const toggleBtn = container.querySelector('.toggle-work-btn');
                    let isDetailsVisible = false;
                    toggleBtn.addEventListener('click', () => {
                        isDetailsVisible = !isDetailsVisible;
                        detailsContent.classList.toggle('hidden', !isDetailsVisible);
                        toggleBtn.querySelector('span').textContent = isDetailsVisible ? 'Hide work' : 'Show work';
                    });
                };

                const updateThinkingDetails = (text) => {
                    if (!detailsContent) return;
                    const codeEl = detailsContent.querySelector('code');
                    codeEl.textContent += text;
                    detailsContent.querySelector('pre').scrollTop = detailsContent.querySelector('pre').scrollHeight;
                };

                return {
                    element: wrapper,
                    switchToThinkingState,
                    updateThinkingDetails
                };
            };

            const manageCancelButton = (show) => {
                cancelBtnContainer.innerHTML = '';
                if (show) {
                    const button = document.createElement('button');
                    button.textContent = 'Cancel';
                    button.className = 'bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-200 active:scale-95';
                    button.onclick = () => controller?.abort();
                    cancelBtnContainer.appendChild(button);
                }
            };

            const sendMessage = async (userMsg) => {
                if (!userMsg || isStreaming) return;

                isStreaming = true;
                controller = new AbortController();
                userInput.disabled = true;
                sendBtn.disabled = true;
                manageCancelButton(true);

                welcomeScreen.classList.add('hidden');
                chat.classList.remove('hidden');

                appendMessage("user", userMsg);
                messages.push({ role: "user", content: userMsg });

                userInput.value = "";
                userInput.style.height = 'auto';
                chatScrollArea.scrollTop = chatScrollArea.scrollHeight;

                const progressIndicator = createProgressIndicator();
                let finalMessageBubble = null;

                try {
                    const response = await fetch(selectedModelUrl, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                        body: JSON.stringify({ messages }),
                        signal: controller.signal
                    });

                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let assistantBuffer = "", displayBuffer = "", isInsideThinkingTag = false, finalMessageStarted = false, hasSwitchedToThinking = false;

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value, { stream: true });
                        for (const line of chunk.split("\n")) {
                            if (!line.startsWith("data:")) continue;
                            const jsonText = line.slice(5).trim();
                            if (!jsonText || jsonText.includes('[DONE]')) continue;

                            let json;
                            try { json = JSON.parse(jsonText); } catch { continue; }
                            const delta = json.v || "";

                            if (delta.includes("<think>")) { isInsideThinkingTag = true; continue; }
                            if (delta.includes("</think>")) { isInsideThinkingTag = false; continue; }

                            assistantBuffer += delta;

                            if (isInsideThinkingTag) {
                                if (!hasSwitchedToThinking) {
                                    progressIndicator.switchToThinkingState();
                                    hasSwitchedToThinking = true;
                                }
                                progressIndicator.updateThinkingDetails(delta);
                            } else {
                                if (!finalMessageStarted) {
                                    finalMessageStarted = true;
                                    progressIndicator.element.remove();
                                    finalMessageBubble = appendMessage("assistant", "");
                                }
                                displayBuffer += delta;
                                finalMessageBubble.innerHTML = marked.parse(displayBuffer + ' â–Œ');
                                enhanceMarkup(finalMessageBubble);
                            }
                        }
                    }

                    if (finalMessageBubble) {
                        finalMessageBubble.innerHTML = marked.parse(displayBuffer);
                        enhanceMarkup(finalMessageBubble);
                    } else if (hasSwitchedToThinking) {
                        // If the stream ends while still in "thinking" mode without a final answer.
                        progressIndicator.element.remove();
                    }

                    messages.push({ role: "assistant", content: assistantBuffer.replace(/<\/?think>/g, '') });
                } catch (err) {
                    progressIndicator.element.remove();
                    if (err.name !== "AbortError") {
                        appendMessage("assistant", `**Error:** Could not get a response. Please check your API token, model selection, and network connection.`);
                    }
                } finally {
                    isStreaming = false;
                    controller = null;
                    userInput.disabled = false;
                    sendBtn.disabled = false;
                    manageCancelButton(false);
                    userInput.focus();
                }
            };

            // --- Event Listeners ---
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage(userInput.value.trim());
            });

            userInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.requestSubmit();
                }
            });

            newChatBtn.addEventListener("click", () => {
                controller?.abort();
                messages = [];
                chat.innerHTML = "";
                chat.classList.add('hidden');

                welcomeScreen.classList.remove('hidden');
                if (window.innerWidth < 768) toggleSidebar();
            });

            document.querySelectorAll('.suggestion-chip').forEach(chip => {
                chip.className = 'bg-[#1C1C1C] hover:bg-[#2A2A2A] p-3 rounded-lg text-sm transition-colors duration-200 cursor-pointer border border-gray-700';
                chip.addEventListener('click', () => {
                    sendMessage(chip.textContent);
                });
            });
        });
    </script>
</body>

</html>